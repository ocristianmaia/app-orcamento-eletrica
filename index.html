
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerador de Orçamentos 5.0 — Correção Exclusão</title>
  <link rel="icon" href="https://eusoueletricista.com.br/wp-content/uploads/2025/09/cropped-cropped-Mascote-Eletricista-5.0-1-1.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab.active { border-bottom: 2px solid #2563EB; color: #2563EB; font-weight: 600; }
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center; }
    .modal.active { display:flex; }
    .servico-slim { font-size: 0.80rem; line-height: 1.1rem; font-weight: 300; }
    .servico-slim strong { font-weight: 500; }
    details > summary::-webkit-details-marker { display:none; }
    details .arrow { transition: transform .2s; }
    details[open] .arrow { transform: rotate(180deg); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Modal de confirmação de exclusão -->
  <div id="delete-confirm-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-sm shadow-xl text-center">
      <h3 class="text-xl font-bold text-red-600 mb-4">Confirmação de Exclusão</h3>
      <p id="delete-confirm-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end gap-3">
        <button onclick="closeDeleteConfirmModal(false)" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
        <button onclick="closeDeleteConfirmModal(true)" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">OK, Excluir</button>
      </div>
    </div>
  </div>

  <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-blue-500"></div>
    <p class="mt-3 text-gray-600">Conectando...</p>
  </div>

  <div id="login-view" class="hidden h-screen flex flex-col justify-center items-center text-center p-6 bg-gray-100">
    <h1 class="text-4xl font-bold text-gray-800">Bem-vindo ao</h1>
    <h2 class="text-5xl font-extrabold text-blue-600 mb-8">Gerador de Orçamentos 5.0</h2>
    <p class="max-w-md mb-8 text-gray-600">Seus dados salvos na nuvem.</p>
    <button id="login-button" class="bg-white text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-shadow flex items-center">
      Entrar com Google
    </button>
  </div>

  <div id="app-view" class="hidden">
    <header class="bg-gray-900 text-white shadow-md">
      <div class="max-w-4xl mx-auto py-3 px-4 md:px-6 flex justify-between items-center">
        <h1 class="text-2xl sm:text-3xl font-bold text-left">
          Gerador de Orçamentos
          <span class="block text-3xl sm:text-4xl">ELETRICISTA 5.0</span>
        </h1>
      </div>
    </header>

    <div id="main-view">
      <div class="max-w-4xl mx-auto p-4 md:p-6 w-full">
        <div class="mb-6 border-b border-gray-200 hidden sm:block">
          <nav class="flex -mb-px space-x-6">
            <button class="tab active py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="orcamentos" onclick="changeTab(event, 'orcamentos')">Tela Inicial</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="configuracoes" onclick="changeTab(event, 'configuracoes')">Configurações</button>
          </nav>
        </div>

        <main>
          <div id="orcamentos" class="tab-content active space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <button onclick="openOrcamentoModal()" class="bg-blue-600 text-white p-4 rounded-lg shadow hover:bg-blue-700 transition-colors font-medium flex justify-center items-center">
                <span class="text-xl font-semibold">+ Novo Orçamento</span>
              </button>
              <button onclick="showAllOrcamentosPage()" class="bg-gray-800 text-white p-4 rounded-lg flex justify-center items-center shadow hover:bg-gray-900 transition-colors">
                <h2 class="text-xl font-semibold text-center">Orçamentos</h2>
              </button>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 pt-4">Últimos 3 Orçamentos</h3>
            <div id="orcamentos-list-recent" class="space-y-3"></div>
          </div>

          <div id="configuracoes" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Seus Dados</h2>
              <form id="form-config" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <div class="space-y-4">
                  <input type="text" id="config-nome" placeholder="Seu Nome ou Empresa" class="w-full p-2 border rounded-md" required>
                  <input type="tel" id="config-telefone" placeholder="Seu Telefone" class="w-full p-2 border rounded-md" required>
                  <input type="text" id="config-doc" placeholder="Seu CPF/CNPJ" class="w-full p-2 border rounded-md" required>
                  <input type="text" id="config-endereco" placeholder="Seu Endereço" class="w-full p-2 border rounded-md">
                  <input type="url" id="config-logo" placeholder="URL da sua Logomarca (opcional)" class="w-full p-2 border rounded-md">
                </div>
                <div class="space-y-4">
                  <label class="block"><span class="text-gray-700">Empreitada (R$)</span><input type="number" step="0.01" id="config-residencial-empreitada" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                  <label class="block"><span class="text-gray-700">Diária (R$)</span><input type="number" step="0.01" id="config-residencial-diaria" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                  <label class="block"><span class="text-gray-700">Por Ponto (R$)</span><input type="number" step="0.01" id="config-residencial-ponto" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                  <label class="block"><span class="text-gray-700">Por Hora (R$)</span><input type="number" step="0.01" id="config-residencial-hora" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                </div>
                <div class="md:col-span-2 text-right">
                  <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                    <span id="save-config-text">Salvar Configurações</span>
                    <span id="save-config-spinner" class="hidden">Salvando...</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Página "Todos os Orçamentos" -->
    <div id="all-orcamentos-view" class="hidden">
      <div class="max-w-4xl mx-auto p-4 md:p-6 w-full">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
          <h2 class="text-2xl font-semibold">Todos os Orçamentos</h2>
          <div class="flex gap-2 w-full sm:w-auto justify-end">
             <button onclick="showMainPage()" class="bg-gray-500 text-white px-5 py-2 rounded-lg shadow hover:bg-gray-600 transition-colors font-medium">Voltar</button>
             <button id="btn-delete-selected-orcamentos" onclick="confirmDeleteSelectedOrcamentos()" class="bg-red-600 text-white px-5 py-2 rounded-lg shadow hover:bg-red-700 transition-colors font-medium disabled:opacity-50" disabled>Excluir Selecionados</button>
          </div>
        </div>
        <div id="all-orcamentos-list" class="space-y-3"></div>
      </div>
    </div>

    <!-- Modal orçamento (simplificado para teste) -->
    <div id="orcamento-modal" class="modal">
      <div class="bg-white rounded-lg p-6 w-[95%] max-w-[960px] max-h-[90vh] overflow-y-auto shadow-xl">
        <div class="flex justify-between items-center mb-6">
          <h2 id="modal-title" class="text-2xl font-bold">Criar Novo Orçamento</h2>
          <button onclick="closeOrcamentoModal()" class="text-gray-500 text-2xl font-bold">&times;</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="space-y-6">
            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">1. Cliente</h4>
              <input id="cliente-nome" placeholder="Nome do cliente" class="w-full p-2 border rounded-md mb-2" />
              <input id="cliente-telefone" placeholder="Telefone" class="w-full p-2 border rounded-md mb-2" />
              <input id="cliente-endereco" placeholder="Endereço" class="w-full p-2 border rounded-md" />
            </div>
            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">2. Mão de Obra</h4>
              <label class="block mb-2">Empreitada (R$): <input type="number" step="0.01" id="empreitada-valor" class="w-full p-2 border rounded-md"></label>
            </div>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg border h-full flex flex-col">
            <h3 class="text-lg font-semibold mb-4 text-center">Pré-visualização do Orçamento</h3>
            <div id="pdf-preview" class="flex-grow text-sm">
              <p class="text-gray-500 text-center mt-8">Preencha os campos para ver a prévia.</p>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-2 justify-end">
              <button onclick="saveOrcamento()" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar Orçamento</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  <footer class="bg-gray-900 text-white text-center py-6 mt-12">
    <div class="max-w-4xl mx-auto px-4 md:px-6">
      <p class="mb-2">Build de teste com correção de exclusão múltipla.</p>
      <p class="text-xs opacity-80">Dicas: selecione vários orçamentos em "Todos os Orçamentos" e clique em "Excluir Selecionados".</p>
    </div>
  </footer>

  <script type="module">
    // ===== Firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyB-0cfQ1Y9Cz12grbia7-Y4nSlWwmXrqWg",
      authDomain: "app-orcamentos-eletrica.firebaseapp.com",
      projectId: "app-orcamentos-eletrica",
      storageBucket: "app-orcamentos-eletrica.firebasestorage.app",
      messagingSenderId: "424397941585",
      appId: "1:424397941585:web:3d5a24606f1a4f6ae54170"
    };

    // Imports Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp, writeBatch, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== Estado e elementos =====
    let app, db, auth, userId;
    const appState = {
      config: {}, orcamentos: [], orcamentosParaExcluir: new Set(), currentOrcamento: null
    };

    const loadingOverlay = document.getElementById('loading-overlay');
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const mainView = document.getElementById('main-view');
    const allOrcamentosView = document.getElementById('all-orcamentos-view');

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    // ===== Inicialização Firebase e Auth =====
    async function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            hide(loadingOverlay); hide(loginView); show(appView);
            loadAllData();
          } else {
            userId = null;
            show(loginView); hide(appView); hide(loadingOverlay);
          }
        });
      } catch (e) {
        console.error('Erro ao inicializar Firebase:', e);
        loadingOverlay.innerHTML = '<p class="text-red-600">Erro crítico ao conectar. Verifique as chaves do Firebase.</p>';
      }
    }

    document.getElementById('login-button')?.addEventListener('click', async () => {
      try { show(loadingOverlay); await signInWithPopup(auth, new GoogleAuthProvider()); }
      catch (e) { console.error(e); alert('Falha no login Google.'); hide(loadingOverlay); }
    });

    // ===== Carregamento reativo de dados =====
    function loadAllData() {
      if (!userId) return;
      const prefix = `users/${userId}`;

      onSnapshot(doc(db, `${prefix}/config/main`), (snap) => {
        if (snap.exists()) appState.config = snap.data();
      });

      onSnapshot(query(collection(db, `${prefix}/orcamentos`)), (snapshot) => {
        appState.orcamentos = snapshot.docs.map(d => {
          const data = d.data();
          if (data.createdAt?.toDate) data.createdAt = data.createdAt.toDate();
          return { id: d.id, ...data };
        });
        appState.orcamentos.sort((a,b) => (b.numeroOrcamento||0) - (a.numeroOrcamento||0));
        renderOrcamentosList();
        renderOrcamentosList(true);
      });
    }

    // ===== UI: Tabs =====
    window.changeTab = (event, tabName) => {
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
    };

    // ===== Orçamentos (lista / modal etc.) =====
    function updateDeleteButtonState() {
      const btn = document.getElementById('btn-delete-selected-orcamentos');
      if (btn) btn.disabled = appState.orcamentosParaExcluir.size === 0;
    }

    function renderOrcamentosList(isFullList = false) {
      const el = isFullList ? document.getElementById('all-orcamentos-list') : document.getElementById('orcamentos-list-recent');
      if (!el) return;

      const listBase = (appState.orcamentos || []).filter(o => o && typeof o.id === 'string' && o.id.trim() !== '');
      const list = isFullList ? listBase : listBase.slice(0, 3);

      if (!list.length) {
        el.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm text-center"><p class="text-gray-500">Nenhum orçamento salvo ainda.</p></div>`;
        if (isFullList) updateDeleteButtonState();
        return;
      }

      el.innerHTML = list.map(orc => {
        const numeroFormatado = String(orc.numeroOrcamento || '').padStart(2, '0');
        const versaoFormatada = String(orc.versao || 1).padStart(2, '0');
        const date = orc.createdAt || new Date();
        const month = String((new Date(date)).getMonth() + 1).padStart(2, '0');
        const year = String((new Date(date)).getFullYear()).slice(-2);
        const orcamentoId = `OS${numeroFormatado}${month}${year}-${versaoFormatada}`;
        const nome = orc?.cliente?.nome || 'Cliente';

        if (isFullList) {
          const isChecked = appState.orcamentosParaExcluir.has(orc.id);
          return `
            <div class="bg-white p-4 rounded-lg shadow-sm flex flex-col gap-y-2">
              <div class="flex justify-between items-start w-full">
                <label class="flex items-center cursor-pointer flex-grow">
                  <input type="checkbox" data-id="${orc.id}" onchange="toggleOrcamentoExclusao(this)" ${isChecked ? 'checked' : ''} class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                  <div class="ml-3">
                    <p class="font-medium text-lg text-gray-800">${nome}</p>
                    <p class="text-sm text-gray-500">${orcamentoId}</p>
                  </div>
                </label>
              </div>
              <div class="flex gap-2 self-end">
                <button onclick="editOrcamento('${orc.id}')" class="bg-yellow-500 text-white px-4 py-1 rounded-md text-sm hover:bg-yellow-600">Editar</button>
              </div>
            </div>`;
        }

        return `
          <div class="bg-white p-4 rounded-lg shadow-sm flex flex-col gap-y-2">
            <div class="flex justify-between items-baseline w-full">
              <p class="font-medium text-lg text-gray-800">${nome}</p>
              <p class="text-sm text-gray-500">${orcamentoId}</p>
            </div>
            <div class="flex gap-2 self-end">
              <button onclick="editOrcamento('${orc.id}')" class="bg-yellow-500 text-white px-4 py-1 rounded-md text-sm hover:bg-yellow-600">Editar</button>
            </div>
          </div>`;
      }).join('');

      if (isFullList) updateDeleteButtonState();
    }

    window.toggleOrcamentoExclusao = (checkbox) => {
      const id = String(checkbox?.dataset?.id || '').trim();
      if (!id) { checkbox.checked = false; return; }
      if (checkbox.checked) appState.orcamentosParaExcluir.add(id);
      else appState.orcamentosParaExcluir.delete(id);
      updateDeleteButtonState();
    };

    window.confirmDeleteSelectedOrcamentos = () => {
      const count = appState.orcamentosParaExcluir.size;
      if (count === 0) { alert('Nenhum orçamento selecionado para exclusão.'); return; }
      const modal = document.getElementById('delete-confirm-modal');
      const messageEl = document.getElementById('delete-confirm-message');
      messageEl.innerHTML = `ATENÇÃO! Você irá excluir <strong>${count}</strong> orçamento(s) selecionado(s). Esta ação é irreversível. Deseja continuar?`;
      modal.classList.add('active');
    };

    window.closeDeleteConfirmModal = (confirmAction) => {
      const modal = document.getElementById('delete-confirm-modal');
      modal.classList.remove('active');
      if (confirmAction) {
        const ids = Array.from(new Set(Array.from(appState.orcamentosParaExcluir).map(x => String(x || '').trim()).filter(Boolean)));
        deleteOrcamentosEmLote(ids);
      }
    };

    async function deleteOrcamentosEmLote(ids) {
      if (!userId) { alert('Falha na autenticação. Faça login novamente.'); return; }
      if (!ids.length) { alert('Nenhum ID válido para exclusão.'); return; }
      const btn = document.getElementById('btn-delete-selected-orcamentos');
      if (btn) btn.disabled = true;

      try {
        const batch = writeBatch(db);
        ids.forEach(id => {
          const ref = doc(db, `users/${userId}/orcamentos/${id}`);
          batch.delete(ref);
        });
        await batch.commit();
        appState.orcamentosParaExcluir.clear();
        alert(`${ids.length} orçamento(s) excluído(s) com sucesso.`);
      } catch (e) {
        console.error('Erro ao excluir em lote:', e);
        alert(`Erro ao excluir: ${e?.message || e}`);
      } finally {
        if (btn) btn.disabled = false;
        updateDeleteButtonState();
      }
    }

    // ===== Modal criar orçamento (teste) =====
    window.openOrcamentoModal = () => {
      document.getElementById('orcamento-modal').classList.add('active');
      appState.currentOrcamento = appState.currentOrcamento || {
        cliente: { nome: '', telefone: '', endereco: '' },
        maoDeObra: { tipo: 'empreitada', valor: 0, label: 'Empreitada', raw_value: 0 },
        total: 0, tipoObra: 'residencial', createdAt: null, numeroOrcamento: null, versao: 1
      };
    };
    window.closeOrcamentoModal = () => {
      document.getElementById('orcamento-modal').classList.remove('active');
    };

    window.saveOrcamento = async () => {
      if (!userId) { alert('Faça login.'); return; }
      const nome = (document.getElementById('cliente-nome').value || '').trim();
      const telefone = (document.getElementById('cliente-telefone').value || '').trim();
      const endereco = (document.getElementById('cliente-endereco').value || '').trim();
      const empreitada = parseFloat(document.getElementById('empreitada-valor').value || '0') || 0;
      if (!nome) return alert('Informe o nome do cliente.');

      const o = {
        cliente: { nome, telefone, endereco },
        maoDeObra: { tipo:'empreitada', valor: empreitada, label:'Empreitada', raw_value: empreitada },
        total: empreitada,
        tipoObra: 'residencial',
        createdAt: serverTimestamp(),
        numeroOrcamento: (appState.orcamentos.reduce((max, x) => Math.max(max, x.numeroOrcamento || 0), 0) || 0) + 1,
        versao: 1
      };

      try {
        await addDoc(collection(db, `users/${userId}/orcamentos`), o);
        alert('Orçamento salvo com sucesso!');
        closeOrcamentoModal();
      } catch (err) {
        console.error('Erro ao salvar orçamento:', err);
        alert('Erro ao salvar orçamento: ' + (err && err.message ? err.message : 'verifique as regras do Firestore.'));
      }
    };

    // ===== Navegação simples =====
    window.showAllOrcamentosPage = () => {
      mainView.classList.add('hidden');
      allOrcamentosView.classList.remove('hidden');
      appState.orcamentosParaExcluir.clear();
      updateDeleteButtonState();
      renderOrcamentosList(true);
    };
    window.showMainPage = () => {
      allOrcamentosView.classList.add('hidden');
      mainView.classList.remove('hidden');
      appState.orcamentosParaExcluir.clear();
      updateDeleteButtonState();
    };

    // start
    document.addEventListener('DOMContentLoaded', initializeFirebase);
  </script>
</body>
</html>
