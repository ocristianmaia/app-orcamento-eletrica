<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerador de Orçamentos 5.0 — Categorias & Submenus</title>
  <link rel="icon" href="https://eusoueletricista.com.br/wp-content/uploads/2025/09/cropped-cropped-Mascote-Eletricista-5.0-1-1.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab.active { border-bottom: 2px solid #2563EB; color: #2563EB; font-weight: 600; }
   .modal {
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.5);
      z-index: 9999; /* Mantido alto */
      align-items:center;
      justify-content:center;
    }
    .modal.active { display:flex; }
    /* Slim look for serviços */
    .servico-slim { font-size: 0.80rem; line-height: 1.1rem; font-weight: 300; }
    .servico-slim strong { font-weight: 500; }
    details > summary::-webkit-details-marker { display:none; }
    details .arrow { transition: transform .2s; }
    details[open] .arrow { transform: rotate(180deg); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-blue-500"></div>
    <p class="mt-3 text-gray-600">Conectando...</p>
  </div>

  <div id="delete-confirm-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-sm shadow-xl text-center">
      <h3 class="text-xl font-bold text-red-600 mb-4">Confirmação de Exclusão</h3>
      <p id="delete-confirm-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end gap-3">
        <button onclick="closeDeleteConfirmModal(false)" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
        <button onclick="closeDeleteConfirmModal(true)" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">OK, Excluir</button>
      </div>
    </div>
  </div>

  <div id="edit-cliente-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Cliente</h3>
      <form id="form-edit-cliente" class="space-y-4">
        <input type="hidden" id="edit-cliente-id">
        <div>
          <label for="edit-cliente-nome" class="block text-sm font-medium text-gray-700">Nome</label>
          <input type="text" id="edit-cliente-nome" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div>
          <label for="edit-cliente-telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
          <input type="tel" id="edit-cliente-telefone" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div>
          <label for="edit-cliente-endereco" class="block text-sm font-medium text-gray-700">Endereço</label>
          <input type="text" id="edit-cliente-endereco" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeEditClienteModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <div id="edit-material-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Material/Serviço</h3>
      <form id="form-edit-material" class="space-y-4">
        <input type="hidden" id="edit-material-id">
        <div>
          <label for="edit-material-nome" class="block text-sm font-medium text-gray-700">Descrição</label>
          <input type="text" id="edit-material-nome" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="edit-material-unidade" class="block text-sm font-medium text-gray-700">Unidade</label>
            <select id="edit-material-unidade" class="w-full p-2 border rounded-md mt-1 h-10">
              <option>UNID</option><option>Pç</option><option>m</option><option>cx</option><option>kit</option>
            </select>
          </div>
          <div>
            <label for="edit-material-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
            <input type="number" step="0.01" id="edit-material-valor" class="w-full p-2 border rounded-md mt-1" required>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeEditMaterialModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <div id="edit-tiposervico-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
        <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Tipo de Serviço</h3>
        <form id="form-edit-tiposervico" class="space-y-4">
            <input type="hidden" id="edit-tiposervico-id">
            <div>
                <label for="edit-tiposervico-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                <input type="text" id="edit-tiposervico-categoria" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: INSTALAÇÕES" required>
            </div>
            <div>
                <label for="edit-tiposervico-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                <input type="text" id="edit-tiposervico-descricao" class="w-full p-2 border rounded-md mt-1" required>
            </div>
            <div>
                <label for="edit-tiposervico-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                <input type="number" step="0.01" id="edit-tiposervico-valor" class="w-full p-2 border rounded-md mt-1" required>
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeEditTipoServicoModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Alterações</button>
            </div>
        </form>
    </div>
  </div>


  <div id="login-view" class="hidden h-screen flex flex-col justify-center items-center text-center p-6 bg-gray-100">
    <h1 class="text-4xl font-bold text-gray-800">Bem-vindo ao</h1>
    <h2 class="text-5xl font-extrabold text-blue-600 mb-8">Gerador de Orçamentos 5.0</h2>
    <p class="max-w-md mb-8 text-gray-600">Seus dados salvos na nuvem.</p>
    <button id="login-button" class="bg-white text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-shadow flex items-center">
      <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.138,44,30.025,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
      Entrar com Google
    </button>
  </div>

  <div id="app-view" class="hidden">
    <header class="bg-gray-900 text-white shadow-md">
      <div class="max-w-4xl mx-auto py-3 px-4 md:px-6 flex justify-between items-center">
        <h1 class="text-2xl sm:text-3xl font-bold text-left">
          Gerador de Orçamentos
          <span class="block text-3xl sm:text-4xl">ELETRICISTA 5.0</span>
        </h1>
        <img
          src="https://eusoueletricista.com.br/wp-content/uploads/2025/09/cropped-cropped-Mascote-Eletricista-5.0-1-1.png"
          alt="Logo Eletricista 5.0"
          class="h-12 sm:h-14 w-auto"
        >
      </div>
    </header>

    <div id="main-view">
      <div class="max-w-4xl mx-auto p-4 md:p-6 w-full">
        <p class="text-md text-gray-600 text-left sm:text-center -mt-2 mb-6">Crie, gerencie e envie orçamentos de forma rápida.</p>

        <div class="mb-6 border-b border-gray-200 hidden sm:block">
          <nav class="flex -mb-px space-x-6">
            <button class="tab active py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="orcamentos" onclick="changeTab(event, 'orcamentos')">Tela Inicial</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="clientes" onclick="changeTab(event, 'clientes')">Clientes</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="materiais" onclick="changeTab(event, 'materiais')">Materiais/Serviços</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="servicos" onclick="changeTab(event, 'servicos')">Serviços</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600 flex items-center" data-tab="configuracoes" onclick="changeTab(event, 'configuracoes')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.575 1.558.75.244.081.503.14.767.17.844.088 1.517.766 1.517 1.61z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Configurações
            </button>
          </nav>
        </div>

        <div class="mb-6 sm:hidden space-y-2">
            <div class="grid grid-cols-3 gap-2">
                <button class="mobile-tab active text-white p-3 rounded-lg shadow-md bg-blue-500" data-tab="orcamentos" onclick="changeTab(event, 'orcamentos')">Início</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-green-500" data-tab="clientes" onclick="changeTab(event, 'clientes')">Clientes</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-yellow-500" data-tab="materiais" onclick="changeTab(event, 'materiais')">Materiais</button>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-purple-500" data-tab="servicos" onclick="changeTab(event, 'servicos')">Serviços</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-gray-500 flex items-center justify-center" data-tab="configuracoes" onclick="changeTab(event, 'configuracoes')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 sm:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.575 1.558.75.244.081.503.14.767.17.844.088 1.517.766 1.517 1.61z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Conf.
                </button>
                <div class="h-full"></div> </div>
        </div>

        <main>
          <div id="orcamentos" class="tab-content active space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <button onclick="showAllOrcamentosPage()" class="bg-gray-800 text-white p-4 rounded-lg flex justify-center items-center shadow hover:bg-gray-900 transition-colors">
                <h2 class="text-xl font-semibold text-center">Orçamentos</h2>
              </button>
              <button onclick="openOrcamentoModal()" class="bg-blue-600 text-white p-4 rounded-lg shadow hover:bg-blue-700 transition-colors font-medium flex justify-center items-center">
                <span class="text-xl font-semibold">+ Novo Orçamento</span>
              </button>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 pt-4">Últimos 3 Orçamentos</h3>
            <div id="orcamentos-list-recent" class="space-y-3"></div>
          </div>

          <div id="clientes" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Cadastrar Novo Cliente</h2>
              <form id="form-cliente" class="space-y-4">
                <input type="text" id="cliente-nome" placeholder="Nome do Cliente" class="w-full p-2 border rounded-md" required>
                <input type="tel" id="cliente-telefone" placeholder="Telefone (com DDD)" class="w-full p-2 border rounded-md" required>
                <input type="text" id="cliente-endereco" placeholder="Endereço Completo" class="w-full p-2 border rounded-md" required>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar Cliente</button>
              </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Clientes Cadastrados</h2>
              <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4" role="alert">
                <p class="text-sm font-medium">Para editar um cliente, clique sobre o nome dele. Para excluir, clique no &times;.</p>
              </div>
              <div id="clientes-list" class="space-y-2"><p class="text-gray-500">Nenhum cliente cadastrado.</p></div>
            </div>
          </div>

          <div id="materiais" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Cadastrar Novo Material/Serviço</h2>
              <form id="form-material" class="flex flex-col sm:flex-row items-stretch sm:items-end gap-4">
                <div class="flex-grow">
                  <label class="block text-sm font-medium text-gray-700">Descrição</label>
                  <input type="text" id="material-nome" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: Tomada Dupla 10A" required>
                </div>
                <div class="sm:w-32">
                  <label class="block text-sm font-medium text-gray-700">Unidade</label>
                  <select id="material-unidade" class="w-full p-2 border rounded-md mt-1 h-10">
                    <option>UNID</option><option>Pç</option><option>m</option><option>cx</option><option>kit</option>
                  </select>
                </div>
                <div class="sm:w-40">
                  <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                  <input type="number" step="0.01" id="material-valor" class="w-full p-2 border rounded-md mt-1" placeholder="25.50" required>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors h-10 w-full sm:w-auto">Salvar Item</button>
              </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold mb-4">Importar Materiais</h2>
                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <p class="text-sm text-gray-600 mb-2">Importar planilha (.xlsx) com as colunas <strong>Descrição</strong>, <strong>Unidade</strong> e <strong>Valor</strong>.</p>
                    <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                      <input type="file" id="materiais-xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-700 flex-1">
                      <button id="btn-import-materiais-xlsx" class="whitespace-nowrap bg-emerald-600 text-white px-4 py-2 rounded-lg shadow hover:bg-emerald-700 transition">Importar Materiais</button>
                      <button id="btn-clear-materiais" class="whitespace-nowrap bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">Limpar Materiais</button>
                    </div>
                    <p id="materiais-xlsx-status" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Itens Cadastrados</h2>
              <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4" role="alert">
                <p class="text-sm font-medium">Para editar um item, clique sobre o nome dele. Para excluir, clique no &times;.</p>
              </div>
              <div id="materiais-list" class="space-y-2"><p class="text-gray-500">Nenhum material cadastrado.</p></div>
            </div>
          </div>

          <div id="servicos" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Tipos de Serviço</h2>

              <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                <p class="text-sm text-gray-600 mb-2">Importar planilha (.xlsx) com as colunas <strong>Categoria</strong>, <strong>Descrição</strong> e <strong>Valor</strong>.</p>
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                  <input type="file" id="xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-700 flex-1">
                  <button id="btn-import-xlsx" class="whitespace-nowrap bg-emerald-600 text-white px-4 py-2 rounded-lg shadow hover:bg-emerald-700 transition">Importar</button>
                  <button id="btn-clear-tiposervico" class="whitespace-nowrap bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">Limpar Tudo</button>
                </div>
                <p id="xlsx-status" class="text-xs text-gray-500 mt-2"></p>
              </div>

              <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4" role="alert">
                <p class="text-sm font-medium">Para editar um serviço, clique sobre o nome dele. Para excluir, clique no &times;.</p>
                <p class="text-sm mt-1">Adicione um novo serviço escolhendo uma das categorias, ou adicione uma nova categoria.</p>
              </div>
              <form id="form-tiposervico" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="tiposervico-categoria-select" class="w-full p-2 border rounded-md mt-1">
                      <option value="">Selecionar existente</option>
                      <option value="new_category">+ Nova Categoria</option>
                    </select>
                    <input type="text" id="tiposervico-categoria-new" placeholder="Nome da Nova Categoria" class="w-full p-2 border rounded-md mt-2 hidden">
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="tiposervico-descricao" placeholder="Ex: Instalação de Padrão" class="w-full p-2 border rounded-md mt-1" required>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="number" step="0.01" id="tiposervico-valor" placeholder="150.00" class="w-full p-2 border rounded-md mt-1" required>
                  </div>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar</button>
              </form>

              <div id="tiposdeservico-list" class="space-y-2 mt-6">
                <p class="text-gray-500">Nenhum tipo de serviço cadastrado.</p>
              </div>
            </div>
          </div>

          <div id="configuracoes" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Configurações Gerais</h2>
              <form id="form-config" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <div>
                  <h3 class="text-lg font-medium mb-4 border-b pb-2">Seus Dados Profissionais</h3>
                  <div class="space-y-4">
                    <input type="text" id="config-nome" placeholder="Seu Nome ou Nome da Empresa" class="w-full p-2 border rounded-md" required>
                    <input type="tel" id="config-telefone" placeholder="Seu Telefone" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="config-doc" placeholder="Seu CPF ou CNPJ" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="config-endereco" placeholder="Seu Endereço" class="w-full p-2 border rounded-md">
                    <input type="text" id="config-logo" placeholder="URL da sua Logomarca (opcional)" class="w-full p-2 border rounded-md">
                  </div>
                </div>
                <div>
                  <div>
                    <h3 class="text-lg font-medium mb-4 border-b pb-2">Valores Mão de Obra - Residencial/Predial</h3>
                    <div class="space-y-4">
                      <label class="block"><span class="text-gray-700">Valor por Empreitada (R$)</span><input type="number" step="0.01" id="config-residencial-empreitada" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor da Diária (R$)</span><input type="number" step="0.01" id="config-residencial-diaria" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Ponto (R$)</span><input type="number" step="0.01" id="config-residencial-ponto" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Hora (R$)</span><input type="number" step="0.01" id="config-residencial-hora" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    </div>
                  </div>
                  <div class="mt-6">
                    <h3 class="text-lg font-medium mb-4 border-b pb-2">Valores Mão de Obra - Industrial</h3>
                    <div class="space-y-4">
                      <label class="block"><span class="text-gray-700">Valor da Diária (R$)</span><input type="number" step="0.01" id="config-industrial-diaria" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Equipamento (R$)</span><input type="number" step="0.01" id="config-industrial-ponto" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Hora (R$)</span><input type="number" step="0.01" id="config-industrial-hora" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    </div>
                  </div>
                </div>
                <div class="md:col-span-2 text-right">
                  <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                    <span id="save-config-text">Salvar Configurações</span>
                    <span id="save-config-spinner" class="hidden">Salvando...</span>
                  </button>
                </div>
              </form>
            </div>

            <div class="mt-8 border-t pt-6 text-center">
              <p id="user-info" class="text-gray-600 mb-4"></p>
              <button id="logout-button" class="bg-red-500 text-white px-6 py-2 rounded-lg shadow hover:bg-red-700 transition-colors">Sair da Conta</button>
            </div>
          </div>
        </main>
      </div>
    </div>

    <div id="all-orcamentos-view" class="hidden">
      <div class="max-w-4xl mx-auto p-4 md:p-6 w-full">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
          <h2 class="text-2xl font-semibold">Todos os Orçamentos</h2>
          <div class="flex gap-2 w-full sm:w-auto justify-end">
             <button onclick="showMainPage()" class="bg-gray-500 text-white px-5 py-2 rounded-lg shadow hover:bg-gray-600 transition-colors font-medium">Voltar</button>
             <button id="btn-delete-selected-orcamentos" onclick="confirmDeleteSelectedOrcamentos()" class="bg-red-600 text-white px-5 py-2 rounded-lg shadow hover:bg-red-700 transition-colors font-medium disabled:opacity-50" disabled>Excluir Selecionados</button>
          </div>
        </div>
        <div id="all-orcamentos-list" class="space-y-3"></div>
      </div>
    </div>
    <div id="orcamento-modal" class="modal">
      <div class="bg-white rounded-lg p-6 w-[95%] max-w-[960px] max-height-[90vh] max-h-[90vh] overflow-y-auto shadow-xl">
        <div class="flex justify-between items-center mb-6">
          <h2 id="modal-title" class="text-2xl font-bold">Criar Novo Orçamento</h2>
          <button onclick="closeOrcamentoModal()" class="text-gray-500 text-2xl font-bold">&times;</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="space-y-6">
            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">1. Selecione o Cliente</h4>
              <select id="orc-cliente-select" class="w-full p-2 border rounded-md">
                <option value="">Selecione um cliente</option>
              </select>
            </div>

            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">2. Tipo de Serviço</h4>
              <input id="filter-tipos" placeholder="Pesquisar serviço..." class="w-full p-2 border rounded-md mb-2 text-sm" />
              <div id="orc-tiposdeservico-list" class="h-48 overflow-y-auto border rounded-md p-2 space-y-2 bg-gray-50"></div>
            </div>

            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">3. Materiais/Itens</h4>
              <div id="orc-materiais-list" class="h-48 overflow-y-auto border rounded-md p-2 space-y-2 bg-gray-50"></div>
            </div>

            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">4. Tipo de Obra</h4>
              <div id="orc-tipo-obra" class="flex gap-3">
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="tipo-obra" value="residencial" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                  <span class="ml-3 text-sm font-medium text-gray-900">Residencial/Predial</span>
                </label>
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="tipo-obra" value="industrial" class="h-4 w-4 text-blue-600 border-gray-300">
                  <span class="ml-3 text-sm font-medium text-gray-900">Industrial</span>
                </label>
              </div>
            </div>

            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">5. Mão de Obra</h4>
              <div id="orc-mao-de-obra" class="space-y-2">
                <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                  <input type="radio" name="tipo-servico" value="empreitada" class="h-4 w-4 text-blue-600 border-gray-300">
                  <span class="ml-3 text-sm font-medium text-gray-900">Empreitada</span>
                  <input type="number" step="0.01" id="empreitada-valor" placeholder="Valor total R$" class="ml-auto w-32 p-1 border rounded-md text-sm">
                </label>
                <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                  <input type="radio" name="tipo-servico" value="diaria" class="h-4 w-4 text-blue-600 border-gray-300">
                  <span class="ml-3 text-sm font-medium text-gray-900">Diária</span>
                  <input type="number" step="1" id="diaria-qtd" placeholder="Qtd. dias" class="ml-auto w-32 p-1 border rounded-md text-sm">
                </label>
                <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                  <input type="radio" name="tipo-servico" value="ponto" class="h-4 w-4 text-blue-600 border-gray-300">
                  <span id="ponto-label-span" class="ml-3 text-sm font-medium text-gray-900">Por Ponto</span>
                  <input type="number" step="1" id="ponto-qtd" placeholder="Qtd. pontos" class="ml-auto w-32 p-1 border rounded-md text-sm">
                </label>
                <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                  <input type="radio" name="tipo-servico" value="hora" class="h-4 w-4 text-blue-600 border-gray-300">
                  <span class="ml-3 text-sm font-medium text-gray-900">Por Hora</span>
                  <input type="number" step="0.5" id="hora-qtd" placeholder="Qtd. horas" class="ml-auto w-32 p-1 border rounded-md text-sm">
                </label>
              </div>
            </div>
          </div>

          <div class="bg-gray-50 p-4 rounded-lg border h-full flex flex-col">
            <h3 class="text-lg font-semibold mb-4 text-center">Pré-visualização do Orçamento</h3>
            <div id="pdf-preview" class="flex-grow text-sm">
              <p class="text-gray-500 text-center mt-8">Selecione um cliente e adicione itens para ver o orçamento.</p>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-2 justify-end">
              <button onclick="saveOrcamento()" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar Orçamento</button>
              <button onclick="shareOrViewPDF()" class="bg-green-600 text-white px-5 py-2 rounded-lg shadow hover:bg-green-700 transition-colors">Enviar PDF</button>
              <button onclick="sendWhatsAppText()" class="bg-teal-500 text-white px-5 py-2 rounded-lg shadow hover:bg-teal-600 transition-colors">Enviar (só texto)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-gray-900 text-white text-center py-6 mt-12">
      <div class="max-w-4xl mx-auto px-4 md:px-6">
        <p class="mb-4">Para ajustes ou sugestões de melhorias, mande uma mensagem.</p>
        <a href="https://wa.me/5551999600889" target="_blank" rel="noopener noreferrer" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md inline-block">Enviar mensagem ao desenvolvedor</a>
      </div>
    </footer>

  </div> <script type="module">

    // Mantido o log de versão original
    console.log("VERSÃO 4.0 DO SCRIPT CARREGADA - TESTE FINAL");

    // ===== Firebase config (preservado do seu arquivo) =====
    const firebaseConfig = {
      apiKey: "AIzaSyB-0cfQ1Y9Cz12grbia7-Y4nSlWwmXrqWg",
      authDomain: "app-orcamentos-eletrica.firebaseapp.com",
      projectId: "app-orcamentos-eletrica",
      storageBucket: "app-orcamentos-eletrica.firebasestorage.app",
      messagingSenderId: "424397941585",
      appId: "1:424397941585:web:3d5a24606f1a4f6ae54170"
    };

    // Imports Firebase
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, setDoc, deleteDoc, onSnapshot, collection, query, addDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== Estado e elementos =====
    let app, db, auth, userId;
    setLogLevel('error'); // Mudado para 'error' para reduzir logs do Firebase

    const loadingOverlay = document.getElementById('loading-overlay');
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const mainView = document.getElementById('main-view');
    const allOrcamentosView = document.getElementById('all-orcamentos-view');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');
    const userInfo = document.getElementById('user-info');

    const appState = {
      config: {}, clientes: [], materiais: [], orcamentos: [],
      tiposDeServico: [], currentOrcamento: null,
      orcamentosParaExcluir: new Set()
    };

    function resetCurrentOrcamento() {
      appState.currentOrcamento = {
        id: null, cliente: null, tiposDeServico: [], items: [],
        maoDeObra: { tipo: '', valor: 0, label: '', raw_value: '' },
        total: 0, tipoObra: 'residencial', createdAt: null,
        numeroOrcamento: null, versao: 1
      };
    }

    // ===== Inicialização Firebase e Auth =====
    async function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            userInfo.textContent = `Logado como: ${user.displayName || user.email}`;
            loadingOverlay.querySelector('p').textContent = 'Carregando seus dados...';
            loadAllData();
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            loadingOverlay.style.display = 'none';
          } else {
            userId = null;
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
            loadingOverlay.style.display = 'none';
          }
        });
      } catch (e) {
        console.error('Erro ao inicializar Firebase:', e);
        loadingOverlay.innerHTML = '<p class="text-red-600">Erro crítico ao conectar. Verifique as chaves do Firebase.</p>';
      }
    }

    const loginWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try { loadingOverlay.style.display = 'flex'; await signInWithPopup(auth, provider); }
      catch (e) { console.error(e); alert('Falha no login Google.'); loadingOverlay.style.display = 'none'; }
    };

    const logout = async () => {
      if (confirm('Tem certeza que deseja sair da sua conta?')) {
        try { await signOut(auth); } catch(e) { alert('Erro ao sair.'); }
      }
    };

    loginButton?.addEventListener('click', loginWithGoogle);
    logoutButton?.addEventListener('click', logout);

    document.getElementById('orc-cliente-select')?.addEventListener('change', (e) => { /* ... código interno mantido ... */ });
      if (!appState.currentOrcamento) resetCurrentOrcamento();

      const clienteId = e.target.value;
      if (clienteId) {
        const cliente = appState.clientes.find(c => c.id === clienteId);
        if (cliente) {
          appState.currentOrcamento.cliente = cliente;
        } else {
          appState.currentOrcamento.cliente = null;
        }
      } else {
        appState.currentOrcamento.cliente = null;
      }
      updateOrcamentoPreview();
    });

    // ===== Carregamento reativo de dados =====
    function loadAllData() {
      if (!userId) return;
      const prefix = `users/${userId}`;

      onSnapshot(doc(db, `${prefix}/config/main`), (snap) => {
        if (snap.exists()) appState.config = snap.data();
        updateConfigForm();
      });

      onSnapshot(query(collection(db, `${prefix}/clientes`)), (snapshot) => {
        appState.clientes = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
        renderClientesList();
        renderOrcamentosList(); // Força atualização dos nomes nos orçamentos
        renderOrcamentosList(true); // Força atualização dos nomes nos orçamentos
      });

      onSnapshot(query(collection(db, `${prefix}/materiais`)), (snapshot) => {
        appState.materiais = snapshot.docs.map(d => ({ ...d.data(), id: d.id })); // Corrigido aqui também
        renderMateriaisList();
      });

      onSnapshot(query(collection(db, `${prefix}/tiposdeservico`)), (snapshot) => {
        appState.tiposDeServico = snapshot.docs.map(d => ({ ...d.data(), id: d.id })); // Corrigido aqui também
        renderTiposDeServicoList();
        populateCategorySelect();
      });

      onSnapshot(query(collection(db, `${prefix}/orcamentos`)), (snapshot) => {
        console.log(`[DEBUG] Recebeu ${snapshot.docs.length} orçamentos do Firebase.`); // Mantido
        appState.orcamentos = snapshot.docs.map(d => {
          const data = d.data();
          if (data.createdAt?.toDate) data.createdAt = data.createdAt.toDate();
          console.log(`[DEBUG] Mapeando doc. ID do Firebase (d.id):`, d.id); // Mantido
          return { ...data, id: d.id };
        });
        appState.orcamentos.sort((a,b) => (b.numeroOrcamento||0) - (a.numeroOrcamento||0));
        renderOrcamentosList();
        renderOrcamentosList(true);
      });
    }

    // ===== Config =====
    function updateConfigForm() {
      const c = appState.config || {};
      document.getElementById('config-nome').value = c.nome || '';
      document.getElementById('config-telefone').value = c.telefone || '';
      document.getElementById('config-doc').value = c.doc || '';
      document.getElementById('config-endereco').value = c.endereco || '';
      document.getElementById('config-logo').value = c.logo || '';
      document.getElementById('config-residencial-empreitada').value = c.residencial_empreitada || '';
      document.getElementById('config-residencial-diaria').value = c.residencial_diaria || '';
      document.getElementById('config-residencial-ponto').value = c.residencial_ponto || '';
      document.getElementById('config-residencial-hora').value = c.residencial_hora || '';
      document.getElementById('config-industrial-diaria').value = c.industrial_diaria || '';
      document.getElementById('config-industrial-ponto').value = c.industrial_ponto || '';
      document.getElementById('config-industrial-hora').value = c.industrial_hora || '';
    }

   document.getElementById('form-config')?.addEventListener('submit', async (e) => { /* ... código interno mantido ... */ });
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const btn = e.target.querySelector('button[type="submit"]');
      const textSpan = document.getElementById('save-config-text');
      const spinSpan = document.getElementById('save-config-spinner');
      btn.disabled = true; textSpan.classList.add('hidden'); spinSpan.classList.remove('hidden');
      try {
        const data = {
          nome: document.getElementById('config-nome').value,
          telefone: document.getElementById('config-telefone').value,
          doc: document.getElementById('config-doc').value,
          endereco: document.getElementById('config-endereco').value,
          logo: document.getElementById('config-logo').value,
          residencial_empreitada: parseFloat(document.getElementById('config-residencial-empreitada').value) || 0,
          residencial_diaria: parseFloat(document.getElementById('config-residencial-diaria').value) || 0,
          residencial_ponto: parseFloat(document.getElementById('config-residencial-ponto').value) || 0,
          residencial_hora: parseFloat(document.getElementById('config-residencial-hora').value) || 0,
          industrial_diaria: parseFloat(document.getElementById('config-industrial-diaria').value) || 0,
          industrial_ponto: parseFloat(document.getElementById('config-industrial-ponto').value) || 0,
          industrial_hora: parseFloat(document.getElementById('config-industrial-hora').value) || 0,
        };
        await setDoc(doc(db, `users/${userId}/config/main`), data);
        alert('Configurações salvas!');
      } catch(e) { console.error(e); alert('Erro ao salvar.'); }
      finally { btn.disabled=false; textSpan.classList.remove('hidden'); spinSpan.classList.add('hidden'); }
    });

    // ===== Clientes =====
    document.getElementById('form-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        const nome = document.getElementById('cliente-nome').value;
        const telefone = document.getElementById('cliente-telefone').value;
        const endereco = document.getElementById('cliente-endereco').value;
        const d = new Date(), month = String(d.getMonth()+1).padStart(2,'0'), year = String(d.getFullYear()).slice(-2);
        const count = appState.clientes.length + 1; const num = String(count).padStart(2,'0');
        const numeroCadastro = `${num}${month}${year}`;
        await addDoc(collection(db, `users/${userId}/clientes`), { nome, telefone, endereco, numeroCadastro });
        e.target.reset();
      } catch(e) { console.error(e); alert('Erro ao salvar cliente.'); }
      finally { btn.disabled=false; btn.textContent='Salvar Cliente'; }
    });
    // Listener para o formulário de EDIÇÃO de cliente
    document.getElementById('form-edit-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const clienteId = document.getElementById('edit-cliente-id').value;
      if (!clienteId) return alert('Erro: ID do cliente não encontrado.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        const data = {
          nome: document.getElementById('edit-cliente-nome').value,
          telefone: document.getElementById('edit-cliente-telefone').value,
          endereco: document.getElementById('edit-cliente-endereco').value,
        };
        const originalCliente = appState.clientes.find(c => c.id === clienteId);
        data.numeroCadastro = originalCliente.numeroCadastro || '';
        await setDoc(doc(db, `users/${userId}/clientes/${clienteId}`), data);
        alert('Cliente atualizado com sucesso!');
        closeEditClienteModal();
      } catch(e) { console.error(e); alert('Erro ao atualizar cliente.'); }
      finally { btn.disabled=false; btn.textContent='Salvar Alterações'; }
    });

    function renderClientesList() {
      const el = document.getElementById('clientes-list');
      if (!appState.clientes.length) { el.innerHTML = '<p class="text-gray-500">Nenhum cliente cadastrado.</p>'; return; }
      el.innerHTML = appState.clientes.map(c => `
        <div class="flex justify-between items-center p-2 border rounded-md">
          <div class="flex-grow cursor-pointer" onclick="openEditClienteModal('${c.id}')">
            <p class="font-medium">${c.nome} <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">${c.numeroCadastro||''}</span></p>
            <p class="text-sm text-gray-600">${c.telefone} | ${c.endereco}</p>
          </div>
          <button onclick="deleteCliente('${c.id}')" class="text-red-500 hover:text-red-700 text-2xl ml-3 flex-shrink-0">&times;</button>
        </div>`).join('');
    }

    window.deleteCliente = async (id) => {
      if (confirm('Excluir este cliente?')) { await deleteDoc(doc(db, `users/${userId}/clientes/${id}`)); }
    };
    // Funções do modal Editar Cliente (com debug)
    window.openEditClienteModal = (id) => {
      console.log(`[DEBUG-CLIENTE] 1. Função chamada com ID:`, id); // Mantido
      try {
        const cliente = appState.clientes.find(c => c.id === id);
        if (!cliente) throw new Error('Cliente não encontrado no appState.');
        console.log("[DEBUG-CLIENTE] 2. Cliente encontrado:", cliente.nome); // Mantido
        const modalEl = document.getElementById('edit-cliente-modal'); if (!modalEl) throw new Error("Elemento 'edit-cliente-modal' não foi encontrado!");
        const idInput = document.getElementById('edit-cliente-id'); if (!idInput) throw new Error("Elemento 'edit-cliente-id' não foi encontrado!");
        const nomeInput = document.getElementById('edit-cliente-nome'); if (!nomeInput) throw new Error("Elemento 'edit-cliente-nome' não foi encontrado!");
        const telInput = document.getElementById('edit-cliente-telefone'); if (!telInput) throw new Error("Elemento 'edit-cliente-telefone' não foi encontrado!");
        const endInput = document.getElementById('edit-cliente-endereco'); if (!endInput) throw new Error("Elemento 'edit-cliente-endereco' não foi encontrado!");
        console.log("[DEBUG-CLIENTE] 3. Todos os elementos do modal foram encontrados. Preenchendo..."); // Mantido
        idInput.value = cliente.id; nomeInput.value = cliente.nome || ''; telInput.value = cliente.telefone || ''; endInput.value = cliente.endereco || '';
        console.log("[DEBUG-CLIENTE] 4. Dados preenchidos. Abrindo modal..."); // Mantido
        modalEl.classList.add('active');
        console.log("[DEBUG-CLIENTE] 5. Modal aberto com sucesso!"); // Mantido
      } catch (e) { console.error("[ERRO CRÍTICO] Falha ao abrir o modal de edição cliente:", e.message); alert("Ocorreu um erro ao tentar abrir a edição. Verifique o console (F12)."); }
    };
    window.closeEditClienteModal = () => { document.getElementById('edit-cliente-modal').classList.remove('active'); document.getElementById('form-edit-cliente').reset(); };

    // ===== Materiais =====
    document.getElementById('form-material').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        const nome = document.getElementById('material-nome').value;
        const valor = parseFloat(document.getElementById('material-valor').value);
        const unidade = document.getElementById('material-unidade').value;
        await addDoc(collection(db, `users/${userId}/materiais`), { nome, valor, unidade });
        e.target.reset();
      } catch(e) { console.error(e); alert('Erro ao salvar item.'); }
      finally { btn.disabled=false; btn.textContent='Salvar Item'; }
    });
    // Listener para o NOVO formulário de EDIÇÃO de material
    document.getElementById('form-edit-material').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const materialId = document.getElementById('edit-material-id').value;
      if (!materialId) return alert('Erro: ID do material não encontrado.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        const data = {
          nome: document.getElementById('edit-material-nome').value,
          unidade: document.getElementById('edit-material-unidade').value,
          valor: parseFloat(document.getElementById('edit-material-valor').value) || 0,
        };
        await setDoc(doc(db, `users/${userId}/materiais/${materialId}`), data);
        alert('Material atualizado com sucesso!');
        closeEditMaterialModal();
      } catch(e) { console.error(e); alert('Erro ao atualizar material.'); }
      finally { btn.disabled=false; btn.textContent='Salvar Alterações'; }
    });

    // Função renderMateriaisList MODIFICADA para incluir edição
    function renderMateriaisList() {
      const el = document.getElementById('materiais-list');
      if (!appState.materiais.length) { el.innerHTML = '<p class="text-gray-500">Nenhum material cadastrado.</p>'; return; }
      el.innerHTML = appState.materiais.map(m => `
        <div class="flex justify-between items-center p-2 border rounded-md">
          <div class="flex-grow cursor-pointer" onclick="openEditMaterialModal('${m.id}')">
            <p class="servico-slim"><strong>${m.nome}</strong> (${m.unidade || 'UNID'}) — R$ ${m.valor.toFixed(2)}</p>
          </div>
          <button onclick="deleteMaterial('${m.id}')" class="text-red-500 hover:text-red-700 text-2xl ml-3 flex-shrink-0">&times;</button>
        </div>`).join('');
    }

    window.deleteMaterial = async (id) => {
      if (confirm('Excluir este item?')) { await deleteDoc(doc(db, `users/${userId}/materiais/${id}`)); }
    };
    // NOVAS Funções do modal Editar Material
    window.openEditMaterialModal = (id) => {
      try {
        const material = appState.materiais.find(m => m.id === id);
        if (!material) throw new Error('Material não encontrado no appState.');
        const modalEl = document.getElementById('edit-material-modal'); if (!modalEl) throw new Error("Elemento 'edit-material-modal' não foi encontrado!");
        const idInput = document.getElementById('edit-material-id'); if (!idInput) throw new Error("Elemento 'edit-material-id' não foi encontrado!");
        const nomeInput = document.getElementById('edit-material-nome'); if (!nomeInput) throw new Error("Elemento 'edit-material-nome' não foi encontrado!");
        const unInput = document.getElementById('edit-material-unidade'); if (!unInput) throw new Error("Elemento 'edit-material-unidade' não foi encontrado!");
        const valInput = document.getElementById('edit-material-valor'); if (!valInput) throw new Error("Elemento 'edit-material-valor' não foi encontrado!");
        idInput.value = material.id; nomeInput.value = material.nome || ''; unInput.value = material.unidade || 'UNID'; valInput.value = material.valor || 0;
        modalEl.classList.add('active');
      } catch (e) { console.error("[ERRO CRÍTICO] Falha ao abrir o modal de edição material:", e.message); alert("Ocorreu um erro ao tentar abrir a edição de material. Verifique o console (F12)."); }
    };
    window.closeEditMaterialModal = () => { document.getElementById('edit-material-modal').classList.remove('active'); document.getElementById('form-edit-material').reset(); };

    // ===== Tipos de Serviço com Categoria & Submenu =====
    const catSelect = document.getElementById('tiposervico-categoria-select');
    const catNew = document.getElementById('tiposervico-categoria-new');

    function populateCategorySelect() {
      while (catSelect.options.length > 2) catSelect.remove(2);
      const cats = [...new Set(appState.tiposDeServico.map(s => s.categoria).filter(Boolean))].sort();
      cats.forEach(cat => { const o=document.createElement('option'); o.value=cat; o.textContent=cat; catSelect.appendChild(o); });
    }

    catSelect.addEventListener('change', () => { if (catSelect.value === 'new_category') { catNew.classList.remove('hidden'); catNew.focus(); } else { catNew.classList.add('hidden'); } });

    document.getElementById('form-tiposervico').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        let categoria = (catSelect.value === 'new_category') ? (catNew.value||'').trim() : (catSelect.value||'').trim();
        categoria = categoria ? categoria.toUpperCase() : 'OUTROS';
        const descricao = document.getElementById('tiposervico-descricao').value;
        const valor = parseFloat(document.getElementById('tiposervico-valor').value);
        if (!categoria || !descricao || isNaN(valor) || valor <= 0) throw new Error('Preencha categoria, descrição e um valor válido maior que zero.');
        await addDoc(collection(db, `users/${userId}/tiposdeservico`), { descricao, valor, categoria });
        e.target.reset(); catNew.classList.add('hidden'); catSelect.value='';
      } catch(e) { console.error(e); alert('Erro ao salvar tipo de serviço: ' + e.message); }
      finally { btn.disabled=false; btn.textContent='Salvar'; }
    });
    // Listener para o NOVO formulário de EDIÇÃO de tipo de serviço
    document.getElementById('form-edit-tiposervico').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const tipoServicoId = document.getElementById('edit-tiposervico-id').value;
      if (!tipoServicoId) return alert('Erro: ID do tipo de serviço não encontrado.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        const categoria = document.getElementById('edit-tiposervico-categoria').value.toUpperCase().trim() || 'OUTROS';
        const descricao = document.getElementById('edit-tiposervico-descricao').value;
        const valor = parseFloat(document.getElementById('edit-tiposervico-valor').value);
        if (!categoria || !descricao || isNaN(valor) || valor <= 0) throw new Error('Preencha categoria, descrição e um valor válido maior que zero.');
        const data = { categoria, descricao, valor };
        await setDoc(doc(db, `users/${userId}/tiposdeservico/${tipoServicoId}`), data);
        alert('Tipo de serviço atualizado com sucesso!');
        closeEditTipoServicoModal();
      } catch(e) { console.error(e); alert('Erro ao atualizar tipo de serviço: ' + e.message); }
      finally { btn.disabled=false; btn.textContent='Salvar Alterações'; }
    });

    function groupBy(arr, key) { return arr.reduce((acc,cur)=>{ const k=cur[key]||'OUTROS'; (acc[k]||(acc[k]=[])).push(cur); return acc; },{}); }

    // Função renderTiposDeServicoList MODIFICADA para incluir edição
    function renderTiposDeServicoList() {
      const el = document.getElementById('tiposdeservico-list');
      if (!appState.tiposDeServico.length) { el.innerHTML = '<p class="text-gray-500">Nenhum tipo de serviço cadastrado.</p>'; return; }
      const byCat = groupBy(appState.tiposDeServico, 'categoria');
      const cats = Object.keys(byCat).sort();
      el.innerHTML = cats.map(cat => {
        const servicos = byCat[cat].sort((a,b) => (a.descricao || '').localeCompare(b.descricao || ''));
        return `
          <details class="border rounded-md mb-2">
            <summary class="flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-gray-100">
              <span class="text-sm font-medium text-gray-800">${cat}</span>
              <svg class="w-4 h-4 arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </summary>
            <div class="p-2 space-y-1">
              ${
                servicos.map(s => `
                  <div class="flex justify-between items-center p-1 border-b border-gray-100">
                    <div class="flex-grow cursor-pointer" onclick="openEditTipoServicoModal('${s.id}')">
                       <p class="servico-slim">${s.descricao} — <span class="text-gray-700">R$ ${s.valor.toFixed(2)}</span></p>
                    </div>
                    <button onclick="deleteTipoDeServico('${s.id}')" class="text-red-500 hover:text-red-700 text-xl leading-none ml-3 flex-shrink-0">&times;</button>
                  </div>
                `).join('')
              }
            </div>
          </details>`;
      }).join('');
    }

    window.deleteTipoDeServico = async (id) => {
      if (confirm('Excluir este tipo de serviço?')) { await deleteDoc(doc(db, `users/${userId}/tiposdeservico/${id}`)); }
    };
    // NOVAS Funções do modal Editar Tipo de Serviço
    window.openEditTipoServicoModal = (id) => {
      try {
        const servico = appState.tiposDeServico.find(s => s.id === id);
        if (!servico) throw new Error('Tipo de serviço não encontrado no appState.');
        const modalEl = document.getElementById('edit-tiposervico-modal'); if (!modalEl) throw new Error("Elemento 'edit-tiposervico-modal' não foi encontrado!");
        const idInput = document.getElementById('edit-tiposervico-id'); if (!idInput) throw new Error("Elemento 'edit-tiposervico-id' não foi encontrado!");
        const catInput = document.getElementById('edit-tiposervico-categoria'); if (!catInput) throw new Error("Elemento 'edit-tiposervico-categoria' não foi encontrado!");
        const descInput = document.getElementById('edit-tiposervico-descricao'); if (!descInput) throw new Error("Elemento 'edit-tiposervico-descricao' não foi encontrado!");
        const valInput = document.getElementById('edit-tiposervico-valor'); if (!valInput) throw new Error("Elemento 'edit-tiposervico-valor' não foi encontrado!");
        idInput.value = servico.id; catInput.value = servico.categoria || 'OUTROS'; descInput.value = servico.descricao || ''; valInput.value = servico.valor || 0;
        modalEl.classList.add('active');
      } catch (e) { console.error("[ERRO CRÍTICO] Falha ao abrir o modal de edição de serviço:", e.message); alert("Ocorreu um erro ao tentar abrir a edição de serviço. Verifique o console (F12)."); }
    };
    window.closeEditTipoServicoModal = () => { document.getElementById('edit-tiposervico-modal').classList.remove('active'); document.getElementById('form-edit-tiposervico').reset(); };


    // ===== Importar Excel (Serviços) =====
    document.getElementById('btn-import-xlsx').addEventListener('click', async () => {
      const inp = document.getElementById('xlsx-input');
      const status = document.getElementById('xlsx-status');
      if (!inp.files || !inp.files[0]) { alert('Selecione um arquivo .xlsx'); return; }
      const f = inp.files[0];
      try {
        status.textContent = 'Lendo planilha...';
        const buf = await f.arrayBuffer(); const wb = XLSX.read(buf, { type:'array' }); const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
        const norm = (s) => String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
        const headerMapCandidates = { categoria: ['categoria','grupo','setor'], descricao: ['descricao','descrição','servico','serviço','atividade','item'], valor: ['valor','preco','preço','price'] };
        const keys = rows.length ? Object.keys(rows[0]) : [];
        const colMap = { categoria: null, descricao: null, valor: null };
        keys.forEach(k => { const nk = norm(k); for (const fld of Object.keys(headerMapCandidates)) { if (headerMapCandidates[fld].some(alias => nk.includes(alias))) colMap[fld] = k; } });
        if (!colMap.categoria || !colMap.descricao || !colMap.valor) throw new Error('Não encontrei colunas suficientes. Garanta que a planilha tenha: Categoria, Descrição e Valor.');
        const prefix = `users/${userId}`; const batch = writeBatch(db); let count = 0;
        rows.forEach(r => {
          const categoria = String(r[colMap.categoria]||'').toUpperCase().trim() || 'OUTROS';
          const descricao = String(r[colMap.descricao]||'').trim();
          const rawValor = (r[colMap.valor] ?? '').toString().replace(',', '.').replace(/\s/g,'');
          const valor = parseFloat(rawValor) || 0;
          if (!categoria || !descricao || isNaN(valor) || valor <= 0) return;
          const ref = doc(collection(db, `${prefix}/tiposdeservico`)); batch.set(ref, { categoria, descricao, valor }); count++;
        });
        if (!count) { alert('Nenhuma linha válida encontrada.'); return; }
        status.textContent = 'Enviando para o banco...'; await batch.commit();
        status.textContent = `Importação concluída: ${count} itens adicionados.`; inp.value = ''; // Limpa o input
      } catch(e) { console.error(e); alert('Erro ao importar planilha: ' + e.message); status.textContent = 'Falha na importação.'; }
    });
    // Função para Limpar Serviços
    async function clearAllTiposDeServico() { /* ... (código mantido) ... */ }
    document.getElementById('btn-clear-tiposervico').addEventListener('click', clearAllTiposDeServico);


    // ===== NOVA SEÇÃO: Importar Excel (Materiais) =====
    document.getElementById('btn-import-materiais-xlsx').addEventListener('click', async () => {
        const inp = document.getElementById('materiais-xlsx-input');
        const status = document.getElementById('materiais-xlsx-status');
        if (!inp.files || !inp.files[0]) { alert('Selecione um arquivo .xlsx para materiais.'); return; }
        const f = inp.files[0];
        try {
            status.textContent = 'Lendo planilha de materiais...';
            const buf = await f.arrayBuffer(); const wb = XLSX.read(buf, { type:'array' }); const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
            const norm = (s) => String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
            // Colunas esperadas para materiais: Descrição, Unidade, Valor
            const headerMapCandidates = { nome: ['descricao','descrição','material','item'], unidade: ['unidade','unid','und'], valor: ['valor','preco','preço','price'] };
            const keys = rows.length ? Object.keys(rows[0]) : [];
            const colMap = { nome: null, unidade: null, valor: null };
            keys.forEach(k => { const nk = norm(k); for (const fld of Object.keys(headerMapCandidates)) { if (headerMapCandidates[fld].some(alias => nk.includes(alias))) colMap[fld] = k; } });
            if (!colMap.nome || !colMap.valor) throw new Error('Não encontrei colunas suficientes. Garanta que a planilha tenha pelo menos: Descrição e Valor. A coluna Unidade é opcional (padrão UNID).');
            const prefix = `users/${userId}`; const batch = writeBatch(db); let count = 0;
            rows.forEach(r => {
                const nome = String(r[colMap.nome]||'').trim();
                const unidade = String(r[colMap.unidade]||'').trim().toUpperCase() || 'UNID'; // Usa Unidade se existir, senão UNID
                const rawValor = (r[colMap.valor] ?? '').toString().replace(',', '.').replace(/\s/g,'');
                const valor = parseFloat(rawValor) || 0;
                if (!nome || isNaN(valor) || valor <= 0) return; // Unidade é opcional
                const ref = doc(collection(db, `${prefix}/materiais`)); batch.set(ref, { nome, unidade, valor }); count++;
            });
            if (!count) { alert('Nenhuma linha válida encontrada na planilha de materiais.'); return; }
            status.textContent = 'Enviando materiais para o banco...'; await batch.commit();
            status.textContent = `Importação de materiais concluída: ${count} itens adicionados.`; inp.value = ''; // Limpa o input
        } catch(e) { console.error(e); alert('Erro ao importar planilha de materiais: ' + e.message); status.textContent = 'Falha na importação de materiais.'; }
    });
    // NOVA Função para Limpar Materiais
    async function clearAllMateriais() {
        if (!userId) return alert('Faça login.');
        if (!confirm('ATENÇÃO!\n\nIsso apagará TODOS os Materiais/Itens cadastrados. Deseja continuar?')) return;
        const status = document.getElementById('materiais-xlsx-status');
        status.textContent = 'Apagando todos os materiais...';
        try {
            const prefix = `users/${userId}`; const ref = collection(db, `${prefix}/materiais`); const snapshot = await getDocs(ref);
            if (snapshot.empty) { status.textContent = 'Nenhum material para apagar.'; return; }
            const batch = writeBatch(db); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit();
            status.textContent = `Todos os ${snapshot.size} materiais foram apagados.`;
        } catch(e) { console.error(e); status.textContent = 'Erro ao apagar os materiais.'; alert('Erro ao apagar materiais.'); }
    }
    document.getElementById('btn-clear-materiais').addEventListener('click', clearAllMateriais);


    // ===== Orçamentos (lista / modal etc.) =====
    function updateDeleteButtonState() { /* ... (código mantido) ... */ }
    function renderOrcamentosList(isFullList = false) { /* ... (código mantido) ... */ }
    window.toggleOrcamentoExclusao = (checkbox) => { /* ... (código mantido, com debug) ... */ };
    window.confirmDeleteSelectedOrcamentos = () => { /* ... (código mantido) ... */ };
    window.closeDeleteConfirmModal = (confirmAction) => { /* ... (código mantido) ... */ };
    async function deleteOrcamentosEmLote(ids) { /* ... (código mantido, com debug) ... */ }
    window.showAllOrcamentosPage = () => { /* ... (código mantido) ... */ };
    window.showMainPage = () => { /* ... (código mantido) ... */ };
    window.editOrcamento = (id) => { /* ... (código mantido, com debug) ... */ };
    window.openOrcamentoModal = (orcamentoParaEditar = null) => { /* ... (código mantido) ... */ };
    window.closeOrcamentoModal = () => { /* ... (código mantido) ... */ };
    function populateClienteSelect() { /* ... (código mantido) ... */ }
    function populateMateriaisOrcamento() { /* ... (código mantido) ... */ }
    function populateTiposDeServicoOrcamento() { /* ... (código mantido) ... */ }
    document.getElementById('filter-tipos').addEventListener('input', (e) => { /* ... (código mantido) ... */ });
    document.getElementById('orc-materiais-list').addEventListener('input', (e) => { /* ... (código mantido) ... */ });
    document.getElementById('orc-tiposdeservico-list').addEventListener('change', (e) => { /* ... (código mantido) ... */ });
    document.getElementById('orc-tipo-obra').addEventListener('change', (e) => { /* ... (código mantido) ... */ });
    document.getElementById('orc-mao-de-obra').addEventListener('input', () => { /* ... (código mantido) ... */ });
    function calculateMaoDeObra() { /* ... (código mantido) ... */ }
    function updateOrcamentoPreview() { /* ... (código mantido) ... */ }
    window.saveOrcamento = async () => { /* ... (código mantido) ... */ };
    window.shareOrViewPDF = async () => { /* ... (código mantido) ... */ };
    window.sendWhatsAppText = () => { /* ... (código mantido) ... */ };

    // ===== Navegação =====
    window.changeTab = (event, tabName) => {
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelectorAll('.tab, .mobile-tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelectorAll(`.tab[data-tab="${tabName}"], .mobile-tab[data-tab="${tabName}"]`).forEach(tab => tab.classList.add('active'));
    };

    window.onload = initializeFirebase;
  </script>
</body>
</html>
