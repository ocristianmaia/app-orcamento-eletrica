<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerador de Or√ßamentos 5.0 ‚Äî Categorias & Submenus</title>
  <link rel="icon" href="icons/icon-32x32.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab.active { border-bottom: 2px solid #2563EB; color: #2563EB; font-weight: 600; }
   .modal { 
      display:none; 
      position:fixed; 
      inset:0; 
      background: rgba(0,0,0,.5); 
      z-index: 9999;
      align-items:center; 
      justify-content:center; 
    }
    .modal.active { display:flex; }
    /* Slim look for servi√ßos */
    .servico-slim { font-size: 0.80rem; line-height: 1.1rem; font-weight: 300; }
    .servico-slim strong { font-weight: 500; }
    details > summary::-webkit-details-marker { display:none; }
    details .arrow { transition: transform .2s; }
    details[open] .arrow { transform: rotate(180deg); }
  </style>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-180x180.png">
  <meta name="theme-color" content="#0a2245">
</head>
<body class="bg-gray-100 text-gray-800">
  <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-blue-500"></div>
    <p class="mt-3 text-gray-600">Conectando...</p>
  </div>

  <div id="delete-confirm-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-sm shadow-xl text-center">
      <h3 class="text-xl font-bold text-red-600 mb-4">Confirma√ß√£o de Exclus√£o</h3>
      <p id="delete-confirm-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end gap-3">
        <button onclick="closeDeleteConfirmModal(false)" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
        <button onclick="closeDeleteConfirmModal(true)" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">OK, Excluir</button>
      </div>
      </div>
  </div>
  
  <div id="edit-cliente-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Cliente</h3>
      <form id="form-edit-cliente" class="space-y-4">
        <input type="hidden" id="edit-cliente-id">
        <div>
          <label for="edit-cliente-numerocadastro" class="block text-sm font-medium text-gray-700">ID do Cliente (Ex: CL0011125)</label>
          <input type="text" id="edit-cliente-numerocadastro" class="w-full p-2 border rounded-md mt-1 bg-gray-100" placeholder="CL0011125">
        </div>
        <div>
          <label for="edit-cliente-telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
          <input type="tel" id="edit-cliente-telefone" class="w-full p-2 border rounded-md mt-1" required>
        </div>
       <div class="grid grid-cols-3 gap-4">
          <div class="col-span-2">
            <label for="edit-cliente-cep" class="block text-sm font-medium text-gray-700">CEP</label>
            <input type="text" id="edit-cliente-cep" 
                   onchange="buscarCEP(this.value, { logradouro: 'edit-cliente-logradouro', bairro: 'edit-cliente-bairro', cidade: 'edit-cliente-cidade', uf: 'edit-cliente-uf', numero: 'edit-cliente-numero' })" 
                   placeholder="00000-000" class="w-full p-2 border rounded-md mt-1">
          </div>
          <div>
            <label for="edit-cliente-numero" class="block text-sm font-medium text-gray-700">N√∫mero</label>
            <input type="text" id="edit-cliente-numero" placeholder="Ex: 106" class="w-full p-2 border rounded-md mt-1" required>
          </div>
        </div>
        <div>
          <label for="edit-cliente-logradouro" class="block text-sm font-medium text-gray-700">Rua / Logradouro</label>
          <input type="text" id="edit-cliente-logradouro" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
        </div>
        <div>
          <label for="edit-cliente-bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
          <input type="text" id="edit-cliente-bairro" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div class="col-span-2">
            <label for="edit-cliente-cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
            <input type="text" id="edit-cliente-cidade" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
          </div>
          <div>
            <label for="edit-cliente-uf" class="block text-sm font-medium text-gray-700">UF</label>
            <input type="text" id="edit-cliente-uf" placeholder="UF" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
          </div>
        </div>

        <div>
          <label for="edit-cliente-documento" class="block text-sm font-medium text-gray-700">CPF ou CNPJ</label>
          <input type="text" id="edit-cliente-documento" class="w-full p-2 border rounded-md mt-1">
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeEditClienteModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>
      
  <div id="edit-material-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Material</h3>
      <form id="form-edit-material" class="space-y-4">
        <input type="hidden" id="edit-material-id">
        <div>
          <label for="edit-material-nome" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
          <input type="text" id="edit-material-nome" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="edit-material-unidade" class="block text-sm font-medium text-gray-700">Unidade</label>
            <select id="edit-material-unidade" class="w-full p-2 border rounded-md mt-1 h-10">
              <option>UNID</option><option>P√ß</option><option>m</option><option>cx</option><option>kit</option>
            </select>
          </div>
          <div>
            <label for="edit-material-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
            <input type="number" step="0.01" id="edit-material-valor" class="w-full p-2 border rounded-md mt-1" required>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeEditMaterialModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>

  <div id="edit-tiposervico-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
        <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Tipo de Servi√ßo</h3>
        <form id="form-edit-tiposervico" class="space-y-4">
            <input type="hidden" id="edit-tiposervico-id">
            <div>
                <label for="edit-tiposervico-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                <input type="text" id="edit-tiposervico-categoria" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: INSTALA√á√ïES" required>
            </div>
            <div>
                <label for="edit-tiposervico-descricao" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                <input type="text" id="edit-tiposervico-descricao" class="w-full p-2 border rounded-md mt-1" required>
            </div>
            <div>
                <label for="edit-tiposervico-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                <input type="number" step="0.01" id="edit-tiposervico-valor" class="w-full p-2 border rounded-md mt-1" required>
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeEditTipoServicoModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Altera√ß√µes</button>
            </div>
        </form>
    </div>
  </div>

  <div id="login-view" class="hidden h-screen flex flex-col justify-center items-center text-center p-6 bg-gray-100">
    <h1 class="text-4xl font-bold text-gray-800">Bem-vindo ao</h1>
    <h2 class="text-5xl font-extrabold text-blue-600 mb-8">Gerador de Or√ßamentos 5.0</h2>
    <p class="max-w-md mb-8 text-gray-600">Seus dados salvos na nuvem.</p>
    <button id="login-button" class="bg-white text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-shadow flex items-center">
      <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.138,44,30.025,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
      Entrar com Google
    </button>
  </div>

  <div id="app-view" class="hidden">
    <header class="bg-gray-900 text-white shadow-md">
      <div class="max-w-4xl mx-auto py-3 px-4 md:px-6 flex justify-between items-center">
        <h1 class="font-bold text-left leading-tight">
          <span class="block text-3xl sm:text-4xl lg:text-5xl">QUOTEX</span>
          <span class="block text-lg sm:text-xl lg:text-2xl mt-1">Or√ßamento Inteligente</span>
        </h1>
        <img src="https://i.postimg.cc/T3VYRRgx/Orcamento-Inteligente.png" alt="Or√ßamento Inteligente" class="h-14 sm:h-16 lg:h-20 w-auto">
      </div>
    </header>

    <div id="main-view">
      <div class="max-w-4xl mx-auto p-4 md:p-6 w-full">
        <p class="text-md text-gray-600 text-left sm:text-center -mt-2 mb-6">Crie, gerencie e envie or√ßamentos de forma r√°pida.</p>

        <div class="mb-6 border-b border-gray-200 hidden sm:block">
          <nav class="flex -mb-px space-x-6">
            <button class="tab active py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="orcamentos" onclick="changeTab(event, 'orcamentos')">Tela Inicial</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="clientes" onclick="changeTab(event, 'clientes')">Clientes</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="materiais" onclick="changeTab(event, 'materiais')">Materiais</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="servicos" onclick="changeTab(event, 'servicos')">Servi√ßos</button>
                        <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="financeiro" onclick="changeTab(event, 'financeiro')">
              Financeiro
            </button>
<button class="tab py-4 px-1 text-gray-500 hover:text-blue-600 flex items-center" data-tab="configuracoes" onclick="changeTab(event, 'configuracoes')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.575 1.558.75.244.081.503.14.767.17.844.088 1.517.766 1.517 1.61z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Configura√ß√µes
            </button>
          </nav>
        </div>
        <div class="mb-6 sm:hidden space-y-2">
            <div class="grid grid-cols-3 gap-2">
                <button class="mobile-tab active text-white p-3 rounded-lg shadow-md bg-blue-500" data-tab="orcamentos" onclick="changeTab(event, 'orcamentos')">In√≠cio</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-green-500" data-tab="clientes" onclick="changeTab(event, 'clientes')">Clientes</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-yellow-500" data-tab="materiais" onclick="changeTab(event, 'materiais')">Materiais</button>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-red-500" data-tab="servicos" onclick="changeTab(event, 'servicos')">Servi√ßos</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-gray-500 flex items-center justify-center" data-tab="configuracoes" onclick="changeTab(event, 'configuracoes')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 sm:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.575 1.558.75.244.081.503.14.767.17.844.088 1.517.766 1.517 1.61z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Conf.
                </button>
                <button class="mobile-tab text-white p-3 rounded-lg bg-green-500/80" data-tab="financeiro" onclick="changeTab(event, 'financeiro')">
                    Financeiro
                </button> </div>
        </div>

        <main>
          <div id="orcamentos" class="tab-content active space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <button onclick="showAllOrcamentosPage()" class="bg-gray-800 text-white p-4 rounded-lg flex justify-center items-center shadow hover:bg-gray-900 transition-colors">
                <h2 class="text-xl font-semibold text-center">Or√ßamentos</h2>
              </button>
              <button type="button" onclick="openOrcamentoModal()" class="bg-blue-600 text-white p-4 rounded-lg shadow hover:bg-blue-700 transition-colors font-medium flex justify-center items-center">
                <span class="text-xl font-semibold">+ Novo Or√ßamento</span>
              </button>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 pt-4">√öltimos 3 Or√ßamentos</h3>
            <div id="orcamentos-list-recent" class="space-y-3"></div>
          </div>

         <div id="clientes" class="tab-content space-y-4">
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
              
              <h2 class="text-xl font-semibold mb-4">Importar / Cadastrar</h2>
              <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                <p class="text-sm text-gray-600 mb-2">Importar planilha (.xlsx) com as colunas: <br><strong>Nome, Telefone, Documento, CEP, Numero, Logradouro, Bairro, Cidade, UF</strong>.</p>
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                  <input type="file" id="clientes-xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-700 flex-1">
                  <button id="btn-import-clientes-xlsx" class="whitespace-nowrap bg-emerald-600 text-white px-4 py-2 rounded-lg shadow hover:bg-emerald-700 transition">Importar Clientes</button>
                  <button id="btn-clear-clientes" class="whitespace-nowrap bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">Limpar Clientes</button>
                </div>
                <p id="clientes-xlsx-status" class="text-xs text-gray-500 mt-2"></p>
              </div>
              
              <details class="border rounded-lg">
                <summary class="cursor-pointer bg-gray-100 hover:bg-gray-200 p-4 font-medium text-lg rounded-t-lg">
  Cadastrar Novo Cliente
</summary>
                <div class="p-6">
                  <form id="form-cliente" class="space-y-4">
                    <input type="text" id="cliente-nome" placeholder="Nome do Cliente" class="w-full p-2 border rounded-md" required>
                    <input type="tel" id="cliente-telefone" placeholder="Telefone (com DDD)" class="w-full p-2 border rounded-md" required>

                    <div class="grid grid-cols-3 gap-4">
                      <div class="col-span-2">
                        <label for="cliente-cep" class="block text-sm font-medium text-gray-700">CEP</label>
                        <input type="text" id="cliente-cep" 
                               onchange="buscarCEP(this.value, { logradouro: 'cliente-logradouro', bairro: 'cliente-bairro', cidade: 'cliente-cidade', uf: 'cliente-uf', numero: 'cliente-numero' })" 
                               placeholder="00000-000" class="w-full p-2 border rounded-md mt-1">
                      </div>
                      <div>
                        <label for="cliente-numero" class="block text-sm font-medium text-gray-700">N√∫mero</label>
                        <input type="text" id="cliente-numero" placeholder="Ex: 106" class="w-full p-2 border rounded-md mt-1" required>
                      </div>
                    </div>
                    <div>
                      <label for="cliente-logradouro" class="block text-sm font-medium text-gray-700">Rua / Logradouro</label>
                      <input type="text" id="cliente-logradouro" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                    </div>
                    <div>
                      <label for="cliente-bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
                      <input type="text" id="cliente-bairro" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                      <div class="col-span-2">
                        <label for="cliente-cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                        <input type="text" id="cliente-cidade" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                      </div>
                      <div>
                        <label for="cliente-uf" class="block text-sm font-medium text-gray-700">UF</label>
                        <input type="text" id="cliente-uf" placeholder="UF" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                      </div>
                    </div>
                    <input type="text" id="cliente-documento" placeholder="CPF ou CNPJ do Cliente" class="w-full p-2 border rounded-md">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar Cliente</button>
                  </form>
                </div>
              </details>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
              
             <div class="flex flex-col-reverse sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
   <h2 class="text-xl font-semibold">Clientes Cadastrados</h2>
   <input type="text" id="search-cliente" placeholder="üîé Pesquisar por nome..." class="w-full sm:max-w-xs p-2 border rounded-md text-sm">
</div>

              <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4" role="alert">
                <p class="text-sm font-medium">Para editar um cliente, clique sobre o nome dele. Para excluir, clique no &times;.</p>
              </div>
              <div id="clientes-list" class="space-y-2"><p class="text-gray-500">Nenhum cliente cadastrado.</p></div>
            </div>
          </div>

          <div id="materiais" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Cadastrar Novo Material</h2>
              <form id="form-material" class="flex flex-col sm:flex-row items-stretch sm:items-end gap-4">
                <div class="flex-grow">
                  <label class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                  <input type="text" id="material-nome" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: Tomada Dupla 10A" required>
                </div>
                <div class="sm:w-32">
                  <label class="block text-sm font-medium text-gray-700">Unidade</label>
                  <select id="material-unidade" class="w-full p-2 border rounded-md mt-1 h-10">
                    <option>UNID</option><option>P√ß</option><option>m</option><option>cx</option><option>kit</option>
                  </select>
                </div>
                <div class="sm:w-40">
                  <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                  <input type="number" step="0.01" id="material-valor" class="w-full p-2 border rounded-md mt-1" placeholder="25.50" required>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors h-10 w-full sm:w-auto">Salvar Item</button>
              </form>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold mb-4">Importar Materiais</h2>
                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <p class="text-sm text-gray-600 mb-2">Importar planilha (.xlsx) com as colunas <strong>Descri√ß√£o</strong>, <strong>Unidade</strong> e <strong>Valor</strong>.</p>
                    <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                      <input type="file" id="materiais-xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-700 flex-1">
                      <button id="btn-import-materiais-xlsx" class="whitespace-nowrap bg-emerald-600 text-white px-4 py-2 rounded-lg shadow hover:bg-emerald-700 transition">Importar Materiais</button>
                      <button id="btn-clear-materiais" class="whitespace-nowrap bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">Limpar Materiais</button>
                    </div>
                    <p id="materiais-xlsx-status" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Itens Cadastrados</h2>
              <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4" role="alert">
                <p class="text-sm font-medium">Para editar um item, clique sobre o nome dele. Para excluir, clique no &times;.</p>
              </div>
              <div id="materiais-list" class="space-y-2"><p class="text-gray-500">Nenhum material cadastrado.</p></div>
            </div>
          </div>

          <div id="servicos" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Tipos de Servi√ßo</h2>

              <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                <p class="text-sm text-gray-600 mb-2">Importar planilha (.xlsx) com as colunas <strong>Categoria</strong>, <strong>Descri√ß√£o</strong> e <strong>Valor</strong>.</p>
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                  <input type="file" id="xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-700 flex-1">
                  <button id="btn-import-xlsx" class="whitespace-nowrap bg-emerald-600 text-white px-4 py-2 rounded-lg shadow hover:bg-emerald-700 transition">Importar</button>
                  <button id="btn-clear-tiposervico" class="whitespace-nowrap bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">Limpar Tudo</button>
                </div>
                <p id="xlsx-status" class="text-xs text-gray-500 mt-2"></p>
              </div>

              <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4" role="alert">
                <p class="text-sm font-medium">Para editar um servi√ßo, clique sobre o nome dele. Para excluir, clique no &times;.</p>
                <p class="text-sm mt-1">Adicione um novo servi√ßo escolhendo uma das categorias, ou adicione uma nova categoria.</p>
              </div>
              <form id="form-tiposervico" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="tiposervico-categoria-select" class="w-full p-2 border rounded-md mt-1">
                      <option value="">Selecionar existente</option>
                      <option value="new_category">+ Nova Categoria</option>
                    </select>
                    <input type="text" id="tiposervico-categoria-new" placeholder="Nome da Nova Categoria" class="w-full p-2 border rounded-md mt-2 hidden">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                    <input type="text" id="tiposervico-descricao" placeholder="Ex: Instala√ß√£o de Padr√£o" class="w-full p-2 border rounded-md mt-1" required>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="number" step="0.01" id="tiposervico-valor" placeholder="150.00" class="w-full p-2 border rounded-md mt-1" required>
                  </div>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar</button>
              </form>

              <div id="tiposdeservico-list" class="space-y-2 mt-6">
                <p class="text-gray-500">Nenhum tipo de servi√ßo cadastrado.</p>
              </div>
            </div>
          </div>

          <div id="financeiro" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm space-y-4">
              <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                <div>
                  <h2 class="text-xl font-semibold mb-1">Financeiro / Faturamento</h2>
                  <p class="text-sm text-gray-500">Acompanhe o valor bruto gerado em or√ßamentos e o valor l√≠quido apenas dos aprovados.</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                  <div class="flex items-center gap-2">
                    <label for="fat-ano" class="text-sm text-gray-600">Ano:</label>
                    <select id="fat-ano" class="border rounded px-2 py-1 text-sm">
                      <option value="todos">Todos</option>
                      <option value="2023">2023</option>
                      <option value="2024">2024</option>
                      <option value="2025">2025</option>
                      <option value="2026">2026</option>
                      <option value="2027">2027</option>
                    </select>
                  </div>
                  <div class="flex items-center gap-2">
                    <label for="fat-mes" class="text-sm text-gray-600">M√™s:</label>
                    <select id="fat-mes" class="border rounded px-2 py-1 text-sm">
                      <option value="all">Todos</option>
                      <option value="0">Janeiro</option>
                      <option value="1">Fevereiro</option>
                      <option value="2">Mar√ßo</option>
                      <option value="3">Abril</option>
                      <option value="4">Maio</option>
                      <option value="5">Junho</option>
                      <option value="6">Julho</option>
                      <option value="7">Agosto</option>
                      <option value="8">Setembro</option>
                      <option value="9">Outubro</option>
                      <option value="10">Novembro</option>
                      <option value="11">Dezembro</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="mt-4 grid gap-4 md:grid-cols-3">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                  <p class="text-xs font-medium text-yellow-700 uppercase tracking-wide">Valor Bruto (gerado)</p>
                  <p id="fat-bruto" class="mt-1 text-lg font-semibold text-yellow-800">R$ 0,00</p>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                  <p class="text-xs font-medium text-green-700 uppercase tracking-wide">Valor L√≠quido (aprovado)</p>
                  <p id="fat-liquido" class="mt-1 text-lg font-extrabold text-green-800">R$ 0,00</p>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <p class="text-xs font-medium text-blue-700 uppercase tracking-wide">Or√ßamentos (aprovados x pendentes)</p>
                  <p id="fat-contagem" class="mt-1 text-sm text-blue-800">0 aprovados / 0 pendentes</p>
                </div>
              </div>

              <div class="mt-6 bg-gray-50 p-3 rounded-lg border flex flex-col sm:flex-row justify-between items-center gap-3">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-gray-700">Visualiza√ß√£o:</span>
                  <select id="chart-periodo" class="border rounded px-2 py-1 text-sm bg-white" onchange="updateFinanceiroView()">
                    <option value="mensal">Mensal (Detalhado)</option>
                    <option value="anual">Anual (M√™s a M√™s)</option>
                  </select>
                </div>
                
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-gray-700">Tipo:</span>
                  <div class="flex bg-white rounded border overflow-hidden">
                    <button type="button" class="px-3 py-1 text-sm hover:bg-gray-100 border-r text-xl" onclick="mudarTipoGrafico('bar')" title="Colunas">
                      üìä
                    </button>
                    <button type="button" class="px-3 py-1 text-sm hover:bg-gray-100 text-xl" onclick="mudarTipoGrafico('pie')" title="Pizza">
                      üçï
                    </button>
                  </div>
                </div>
              </div>

              <div class="mt-2 bg-white p-4 rounded-lg border shadow-sm">
                <div class="relative h-[300px] w-full">
                    <canvas id="finance-chart"></canvas>
                </div>
              </div>

              <div class="mt-6 border-t pt-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Exportar faturamento</h3>
                <div class="grid gap-3 md:grid-cols-[repeat(3,minmax(0,1fr))] md:items-end">
                  <div>
                    <label for="fat-data-inicio" class="block text-xs font-medium text-gray-600">Data inicial</label>
                    <input type="date" id="fat-data-inicio" class="mt-1 block w-full border rounded px-2 py-1 text-sm" />
                  </div>
                  <div>
                    <label for="fat-data-fim" class="block text-xs font-medium text-gray-600">Data final</label>
                    <input type="date" id="fat-data-fim" class="mt-1 block w-full border rounded px-2 py-1 text-sm" />
                  </div>
                  <div class="flex gap-2">
                    <button id="btn-atualizar-financeiro" class="flex-1 inline-flex justify-center items-center px-3 py-2 border border-indigo-500 text-indigo-600 text-sm font-medium rounded-md hover:bg-indigo-50">
                      Atualizar dados
                    </button>
                    <button id="btn-exportar-financeiro" class="flex-1 inline-flex justify-center items-center px-3 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50">
                      Exportar (.xlsx)
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="configuracoes" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Configura√ß√µes Gerais</h2>
              <form id="form-config" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <div>
                  <h3 class="text-lg font-medium mb-4 border-b pb-2">Seus Dados Profissionais</h3>
                  <div class="space-y-4">
                    <input type="text" id="config-nome" placeholder="Seu Nome ou Nome da Empresa" class="w-full p-2 border rounded-md" required>
                    <input type="tel" id="config-telefone" placeholder="Seu Telefone" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="config-doc" placeholder="Seu CPF ou CNPJ" class="w-full p-2 border rounded-md" required>

                    <div class="grid grid-cols-3 gap-4">
                      <div class="col-span-2">
                        <label for="config-cep" class="block text-sm font-medium text-gray-700">CEP</label>
                        <input type="text" id="config-cep" 
                               onchange="buscarCEP(this.value, { logradouro: 'config-logradouro', bairro: 'config-bairro', cidade: 'config-cidade', uf: 'config-uf', numero: 'config-numero' })" 
                               placeholder="00000-000" class="w-full p-2 border rounded-md mt-1">
                      </div>
                      <div>
                        <label for="config-numero" class="block text-sm font-medium text-gray-700">N√∫mero</label>
                        <input type="text" id="config-numero" placeholder="Ex: 106" class="w-full p-2 border rounded-md mt-1">
                      </div>
                    </div>
                    <div>
                      <label for="config-logradouro" class="block text-sm font-medium text-gray-700">Rua / Logradouro</label>
                      <input type="text" id="config-logradouro" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                    </div>
                    <div>
                      <label for="config-bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
                      <input type="text" id="config-bairro" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                      <div class="col-span-2">
                        <label for="config-cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                        <input type="text" id="config-cidade" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                      </div>
                      <div>
                        <label for="config-uf" class="block text-sm font-medium text-gray-700">UF</label>
                        <input type="text" id="config-uf" placeholder="UF" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                      </div>
                    </div>

                    <input type="hidden" id="config-logo">

                    <div>
                      <label for="config-logo-file" class="block text-sm font-medium text-gray-700">
                        Logomarca (opcional)
                      </label>
                      <input
                        type="file"
                        id="config-logo-file"
                        accept="image/*"
                        class="mt-1 block w-full text-sm text-gray-700 border rounded-md p-2 bg-white"
                      >
                      <p class="text-xs text-gray-500 mt-1">
                        Selecione uma imagem do seu celular ou computador. Ela ser√° exibida no cabe√ßalho do PDF.
                      </p>

                      <div id="config-logo-preview-wrapper" class="mt-2 hidden">
                        <p class="text-xs text-gray-600 mb-1">Pr√©-visualiza√ß√£o:</p>
                        <div class="flex items-center gap-3">
                          <img
                            id="config-logo-preview"
                            src=""
                            alt="Pr√©-visualiza√ß√£o da logomarca"
                            class="max-h-16 object-contain border rounded-md bg-white p-1"
                          >
                          <button
                            type="button"
                            id="config-logo-clear"
                            class="text-xs text-red-600 hover:underline"
                          >
                            Remover logomarca
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="mb-6">
                    <h3 class="text-lg font-medium mb-4 border-b pb-2">Personaliza√ß√£o do PDF</h3>
                    <div class="flex gap-4">
                        <label class="block flex-1">
                            <span class="text-gray-700">Cor Prim√°ria (T√≠tulos)</span>
                            <input type="color" id="config-color-primary" class="w-full h-10 p-1 border rounded-md mt-1" value="#000000">
                        </label>
                        <label class="block flex-1">
                            <span class="text-gray-700">Cor Secund√°ria (Total)</span>
                            <input type="color" id="config-color-secondary" class="w-full h-10 p-1 border rounded-md mt-1" value="#333333">
                        </label>
                    </div>
                  </div>
                  <div>
                    <h3 class="text-lg font-medium mb-4 border-b pb-2">Valores M√£o de Obra - Residencial/Predial</h3>
                    <div class="space-y-4">
                      <label class="block"><span class="text-gray-700">Valor por Empreitada (R$)</span><input type="number" step="0.01" id="config-residencial-empreitada" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor da Di√°ria (R$)</span><input type="number" step="0.01" id="config-residencial-diaria" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Ponto (R$)</span><input type="number" step="0.01" id="config-residencial-ponto" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Hora (R$)</span><input type="number" step="0.01" id="config-residencial-hora" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    </div>
                  </div>
                  <div class="mt-6">
                    <h3 class="text-lg font-medium mb-4 border-b pb-2">Valores M√£o de Obra - Industrial</h3>
                    <div class="space-y-4">
                      <label class="block"><span class="text-gray-700">Valor da Di√°ria (R$)</span><input type="number" step="0.01" id="config-industrial-diaria" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Equipamento (R$)</span><input type="number" step="0.01" id="config-industrial-ponto" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Hora (R$)</span><input type="number" step="0.01" id="config-industrial-hora" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    </div>
                  </div>
                </div>
                
                <div>
                  <h3 class="text-lg font-medium mb-4 border-b pb-2">Formas de Pagamento</h3>
                  <div class="space-y-4">
                    <label class="block"><span class="text-gray-700">Chave PIX</span><input type="text" id="config-pix-chave" class="w-full p-2 border rounded-md mt-1" placeholder="Sua chave PIX"></label>
                    <label class="block"><span class="text-gray-700">Cart√£o (N¬∫ de Parcelas)</span><input type="number" step="1" id="config-cartao-vezes" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 12"></label>
                    <label class="block"><span class="text-gray-700">Cart√£o (Juros % por parcela)</span><input type="number" step="0.01" id="config-cartao-juros" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 1.99"></label>
                    <label class="flex items-center"><input type="checkbox" id="config-pagamento-dinheiro" class="h-4 w-4 text-blue-600 border-gray-300 rounded mr-2"><span class="text-gray-700">Aceita Dinheiro</span></label>
                    <h4 class="text-md font-medium pt-2 border-t mt-2">Dados para Dep√≥sito</h4>
                    <label class="block"><span class="text-gray-700">Banco</span><input type="text" id="config-deposito-banco" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: Banco do Brasil"></label>
                    <label class="block"><span class="text-gray-700">Ag√™ncia</span><input type="text" id="config-deposito-ag" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 0001"></label>
                    <label class="block"><span class="text-gray-700">Conta</span><input type="text" id="config-deposito-conta" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 12345-6"></label>
                  </div>
                </div>
                <div class="md:col-span-2 text-right">
                  <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">
                    <span id="save-config-text">Salvar Configura√ß√µes</span>
                    <span id="save-config-spinner" class="hidden">Salvando...</span>
                  </button>
                </div>
              </form>
            </div>

            <div class="mt-8 border-t pt-6 text-center">
              <p id="user-info" class="text-gray-600 mb-4"></p>
              <button id="logout-button" class="bg-red-500 text-white px-6 py-2 rounded-lg shadow hover:bg-red-700 transition-colors">Sair da Conta</button>
            </div>
          </div>
        </main>
      </div>
    </div>

    <div id="all-orcamentos-view" class="hidden">

      
      <div class="max-w-4xl mx-auto p-4 md:p-6 w-full">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
          <h2 class="text-2xl font-semibold">Todos os Or√ßamentos</h2>
          <div class="flex gap-2 w-full sm:w-auto justify-end">
             <button onclick="showMainPage()" class="bg-gray-500 text-white px-5 py-2 rounded-lg shadow hover:bg-gray-600 transition-colors font-medium">Voltar</button>
             <button id="btn-delete-selected-orcamentos" onclick="confirmDeleteSelectedOrcamentos()" class="bg-red-600 text-white px-5 py-2 rounded-lg shadow hover:bg-red-700 transition-colors font-medium disabled:opacity-50" disabled>Excluir Selecionados</button>
          </div>
        </div>
        <div id="all-orcamentos-list-container">
              <div class="mb-4 grid gap-3 md:grid-cols-4">
                <div>
                  <label for="filtro-status-orcamento" class="block text-xs font-medium text-gray-600">Status</label>
                  <select id="filtro-status-orcamento" class="mt-1 block w-full border rounded px-2 py-1 text-sm">
                    <option value="todos">Todos</option>
                    <option value="aprovado">Aprovados</option>
                    <option value="pendente">Pendentes</option>
                  </select>
                </div>
                <div>
                  <label for="filtro-mes-orcamento" class="block text-xs font-medium text-gray-600">M√™s</label>
                  <select id="filtro-mes-orcamento" class="mt-1 block w-full border rounded px-2 py-1 text-sm">
                    <option value="todos">Todos</option>
                    <option value="0">Janeiro</option>
                    <option value="1">Fevereiro</option>
                    <option value="2">Mar√ßo</option>
                    <option value="3">Abril</option>
                    <option value="4">Maio</option>
                    <option value="5">Junho</option>
                    <option value="6">Julho</option>
                    <option value="7">Agosto</option>
                    <option value="8">Setembro</option>
                    <option value="9">Outubro</option>
                    <option value="10">Novembro</option>
                    <option value="11">Dezembro</option>
                  </select>
                </div>
                <div>
                  <label for="filtro-ano-orcamento" class="block text-xs font-medium text-gray-600">Ano</label>
                  <select id="filtro-ano-orcamento" class="mt-1 block w-full border rounded px-2 py-1 text-sm">
                    <option value="todos">Todos</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <button id="btn-limpar-filtros-orcamento" class="inline-flex justify-center items-center w-full px-3 py-2 border border-gray-300 text-gray-700 text-xs font-medium rounded-md hover:bg-gray-50">
                    Limpar filtros
                  </button>
                </div>
              </div>
             </div> <div id="all-orcamentos-list" class="space-y-3"></div>
      </div>
    </div>
    <div id="orcamento-modal" class="modal">
      <div class="bg-white rounded-lg p-6 w-[95%] max-w-[960px] max-height-[90vh] max-h-[90vh] overflow-y-auto shadow-xl">
        <div class="flex justify-between items-center mb-6">
          <h2 id="modal-title" class="text-2xl font-bold">Criar Novo Or√ßamento</h2>
          <button onclick="closeOrcamentoModal()" class="text-gray-500 text-2xl font-bold">&times;</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="space-y-6">
            
            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">Selecione o Cliente</h4>
              <select id="orc-cliente-select" class="w-full p-2 border rounded-md">
                <option value="">Selecione um cliente</option>
              </select>
            </div>

            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">Modo de Cobran√ßa</h4>
              <div id="orc-modo-cobranca" class="flex gap-3">
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="modo-cobranca" value="mao_de_obra" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                  <span class="ml-3 text-sm font-medium text-gray-900">M√£o de Obra</span>
                </label>
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="modo-cobranca" value="por_servico" class="h-4 w-4 text-blue-600 border-gray-300">
                  <span class="ml-3 text-sm font-medium text-gray-900">Por Servi√ßo</span>
                </label>
              </div>
            </div>

            <div id="orc-cobranca-mo-wrapper" class="space-y-6">
              <div>
                <h4 class="text-md font-medium text-gray-800 mb-2">ESPECIALIDADE</h4>
                <div id="orc-tipo-obra" class="flex gap-3">
                  <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                    <input type="radio" name="tipo-obra" value="residencial" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                    <span class="ml-3 text-sm font-medium text-gray-900">Residencial/Predial</span>
                  </label>
                  <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                    <input type="radio" name="tipo-obra" value="industrial" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span class="ml-3 text-sm font-medium text-gray-900">Industrial</span>
                  </label>
                </div>
              </div>

              <div>
                <h4 class="text-md font-medium text-gray-800 mb-2">M√£o de Obra</h4>
                <div id="orc-mao-de-obra" class="space-y-2">
                  <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo-servico" value="empreitada" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span class="ml-3 text-sm font-medium text-gray-900">Empreitada</span>
                    <input type="number" step="0.01" id="empreitada-valor" placeholder="Valor total R$" class="ml-auto w-32 p-1 border rounded-md text-sm">
                  </label>
                  <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo-servico" value="diaria" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span class="ml-3 text-sm font-medium text-gray-900">Di√°ria</span>
                    <input type="number" step="1" id="diaria-qtd" placeholder="Qtd. dias" class="ml-auto w-32 p-1 border rounded-md text-sm">
                  </label>
                  <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo-servico" value="ponto" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span id="ponto-label-span" class="ml-3 text-sm font-medium text-gray-900">Por Ponto</span>
                    <input type="number" step="1" id="ponto-qtd" placeholder="Qtd. pontos" class="ml-auto w-32 p-1 border rounded-md text-sm">
                  </label>
                  <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo-servico" value="hora" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span class="ml-3 text-sm font-medium text-gray-900">Por Hora</span>
                    <input type="number" step="0.5" id="hora-qtd" placeholder="Qtd. horas" class="ml-auto w-32 p-1 border rounded-md text-sm">
                  </label>
                </div>
              </div>
            </div>
            
            <div id="orc-cobranca-servico-wrapper" class="space-y-6 hidden">
               <div>
                <h4 class="text-md font-medium text-gray-800 mb-2">Tipos de Servi√ßo</h4>
                <input id="filter-tipos" placeholder="Pesquisar servi√ßo..." class="w-full p-2 border rounded-md mb-2 text-sm" />
                <div id="orc-tiposdeservico-list" class="h-48 overflow-y-auto border rounded-md p-2 space-y-2 bg-gray-50"></div>
              </div>
            </div>
            
            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">Materiais</h4>
              <div id="orc-usar-material" class="flex gap-3">
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="usar-material" value="sim" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                  <span class="ml-3 text-sm font-medium text-gray-900">Usar Materiais</span>
                </label>
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="usar-material" value="nao" class="h-4 w-4 text-blue-600 border-gray-300">
                  <span class="ml-3 text-sm font-medium text-gray-900">N√£o Incluir</span>
                </label>
              </div>
            </div>
            
            <div id="orc-cobranca-material-wrapper" class="space-y-6">
              <div>
                <h4 class="text-md font-medium text-gray-800 mb-2">Lista de Materiais</h4>
                <div id="orc-materiais-list" class="h-48 overflow-y-auto border rounded-md p-2 space-y-2 bg-gray-50"></div>
              </div>
            </div>
            
            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">Desconto (Opcional)</h4>
              <div class="flex gap-3">
                <select id="orc-desconto-tipo" class="p-2 border rounded-md bg-gray-50">
                  <option value="nenhum">Sem Desconto</option>
                  <option value="percent">% (Porcentagem)</option>
                  <option value="valor">R$ (Valor Fixo)</option>
                </select>
                <input type="number" step="0.01" id="orc-desconto-valor" class="w-full p-2 border rounded-md" placeholder="0.00" disabled>
              </div>
            </div>

            <div class="mt-4">
              <label for="orc-descricao-servico" class="block text-sm font-medium text-gray-700">
                Descri√ß√£o do servi√ßo realizado (empreitada, por hora, etc.)
              </label>
              <textarea
                id="orc-descricao-servico"
                class="mt-1 w-full p-2 border rounded-md text-sm"
                rows="3"
                placeholder="Ex.: Instala√ß√£o de pontos de ilumina√ß√£o, troca de disjuntores, revis√£o geral do quadro, etc."
              ></textarea>
            </div>
            <div class="mt-2">
              <label class="inline-flex items-center">
                <input id="orc-status-aprovado" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded">
                <span class="ml-2 text-sm text-gray-800">
                  Marcar este or√ßamento como <span class="font-semibold text-green-700">APROVADO</span>
                </span>
              </label>
            </div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg border h-full flex flex-col">
            <h3 class="text-lg font-semibold mb-4 text-center">Pr√©-visualiza√ß√£o do Or√ßamento</h3>
            <div id="pdf-preview" class="flex-grow text-sm">
              <p class="text-gray-500 text-center mt-8">Selecione um cliente e adicione itens para ver o or√ßamento.</p>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-2 justify-end">
              <button onclick="saveOrcamento()" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar Or√ßamento</button>
              <button onclick="shareOrViewPDF()" class="bg-green-600 text-white px-5 py-2 rounded-lg shadow hover:bg-green-700 transition-colors">Enviar PDF</button>
              <button onclick="sendWhatsAppText()" class="bg-teal-500 text-white px-5 py-2 rounded-lg shadow hover:bg-teal-600 transition-colors">Enviar (s√≥ texto)</button>
            </div>
          </div>
        </div>
      </div>
    </div>
      
<footer class="bg-gray-900 text-white text-center py-6 mt-12">
      <div class="max-w-4xl mx-auto px-4 md:px-6">
        <p class="mb-4">D√∫vidas e sugest√µes? Mande uma mensagem ao desenvolvedor.</p>
        <a href="https://wa.me/5551999600889" target="_blank" rel="noopener noreferrer" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md inline-block">Enviar Mensagem</a>
      </div>
    </footer>

    <script type="module">
    console.log("VERS√ÉO 14.0 (CORRE√á√ÉO TOTAL - BOT√ïES E FINANCEIRO) CARREGADA");

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDocs, setDoc, deleteDoc, onSnapshot, collection, query, addDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-0cfQ1Y9Cz12grbia7-Y4nSlWwmXrqWg",
      authDomain: "app-orcamentos-eletrica.firebaseapp.com",
      projectId: "app-orcamentos-eletrica",
      storageBucket: "app-orcamentos-eletrica.firebasestorage.app",
      messagingSenderId: "424397941585",
      appId: "1:424397941585:web:3d5a24606f1a4f6ae54170"
    };

    // Vari√°veis de Estado
    let app, db, auth, userId;
    let financeChart = null;
    let chartType = 'bar';

    const appState = {
      config: {}, clientes: [], materiais: [], orcamentos: [],
      tiposDeServico: [], currentOrcamento: null,
      orcamentosParaExcluir: new Set()
    };

    // ===== 1. INICIALIZA√á√ÉO E LOGIN =====
    window.onload = async () => {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);

      onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
          document.getElementById('user-info').textContent = `Logado: ${user.email}`;
          document.getElementById('loading-overlay').style.display = 'none';
          document.getElementById('login-view').classList.add('hidden');
          document.getElementById('app-view').classList.remove('hidden');
          
          // Configura Data Inicial Financeiro
          const hoje = new Date();
          if(document.getElementById('fat-ano')) document.getElementById('fat-ano').value = hoje.getFullYear();
          if(document.getElementById('fat-mes')) document.getElementById('fat-mes').value = hoje.getMonth();

          loadAllData();
          setupManualListeners();
        } else {
          userId = null;
          document.getElementById('loading-overlay').style.display = 'none';
          document.getElementById('login-view').classList.remove('hidden');
          document.getElementById('app-view').classList.add('hidden');
        }
      });
    };

    // ===== 2. CARREGAMENTO DE DADOS (REALTIME) =====
    function loadAllData() {
      const prefix = `users/${userId}`;

      // Configura√ß√µes
      onSnapshot(doc(db, `${prefix}/config/main`), (snap) => {
        if (snap.exists()) { 
            appState.config = snap.data(); 
            updateConfigForm(); 
        }
      });

      // Clientes
      onSnapshot(query(collection(db, `${prefix}/clientes`)), (snap) => {
        appState.clientes = snap.docs.map(d => ({ ...d.data(), id: d.id }));
        renderClientesList();
        renderOrcamentosList(); 
        renderOrcamentosList(true);
      });

      // Materiais
      onSnapshot(query(collection(db, `${prefix}/materiais`)), (snap) => {
        appState.materiais = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMateriaisList();
      });

      // Servi√ßos
      onSnapshot(query(collection(db, `${prefix}/tiposdeservico`)), (snap) => {        
        appState.tiposDeServico = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTiposDeServicoList();
        populateCategorySelect();
      });

      // Or√ßamentos
      onSnapshot(query(collection(db, `${prefix}/orcamentos`)), (snap) => {
        appState.orcamentos = snap.docs.map(d => {
          const data = d.data();
          if (data.createdAt?.toDate) data.createdAt = data.createdAt.toDate();
          else if (typeof data.createdAt === 'string') data.createdAt = new Date(data.createdAt);
          
          return { 
            ...data, 
            id: d.id, 
            status: data.status || (data.aprovado ? 'aprovado' : 'pendente'), 
            aprovado: data.aprovado ?? (data.status === 'aprovado')
          };
        });
        appState.orcamentos.sort((a,b) => (b.numeroOrcamento||0) - (a.numeroOrcamento||0));
        renderOrcamentosList();
        renderOrcamentosList(true);
        window.updateFinanceiroView(); // Atualiza gr√°fico sempre que mudar or√ßamento
      });
    }

    // ===== 3. FUN√á√ïES EXPOSTAS AO HTML (WINDOW) =====
    // Isso resolve o problema dos bot√µes n√£o clicarem

    // Navega√ß√£o
    window.changeTab = (event, tabName) => {
      document.querySelectorAll('.tab-content, .tab, .mobile-tab').forEach(x=>x.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelectorAll(`[data-tab="${tabName}"]`).forEach(t => t.classList.add('active'));
      if (tabName === 'financeiro') setTimeout(() => window.updateFinanceiroView(), 100);
    };

    window.showAllOrcamentosPage = () => {
      document.getElementById('main-view').classList.add('hidden');
      document.getElementById('all-orcamentos-view').classList.remove('hidden');
      renderOrcamentosList(true);
    };

    window.showMainPage = () => {
      document.getElementById('all-orcamentos-view').classList.add('hidden');
      document.getElementById('main-view').classList.remove('hidden');
      appState.orcamentosParaExcluir.clear();
    };

    // Clientes (Edi√ß√£o e Exclus√£o)
    window.openEditClienteModal = (id) => {
        const c = appState.clientes.find(x => x.id === id);
        if(!c) return alert('Cliente n√£o encontrado na mem√≥ria.');
        
        const set=(i,v)=>document.getElementById(i).value=v||'';
        set('edit-cliente-id', c.id);
        set('edit-cliente-nome', c.nome);
        set('edit-cliente-numerocadastro', c.numeroCadastro);
        set('edit-cliente-telefone', formatarTelefone(c.telefone));
        set('edit-cliente-documento', formatarCPFCNPJ(c.documento));
        set('edit-cliente-cep', formatarCEP(c.cep));
        set('edit-cliente-numero', c.numero);
        set('edit-cliente-logradouro', c.logradouro);
        set('edit-cliente-bairro', c.bairro);
        set('edit-cliente-cidade', c.cidade);
        set('edit-cliente-uf', c.uf);
        
        document.getElementById('edit-cliente-modal').classList.add('active');
    };
    window.closeEditClienteModal = () => document.getElementById('edit-cliente-modal').classList.remove('active');
    window.deleteCliente = async (id) => { if(confirm('Excluir cliente permanentemente?')) await deleteDoc(doc(db, `users/${userId}/clientes/${id}`)); };

    // Materiais e Servi√ßos
    window.openEditMaterialModal = (id) => {
        const m = appState.materiais.find(x => x.id === id); if(!m) return;
        document.getElementById('edit-material-id').value=m.id;
        document.getElementById('edit-material-nome').value=m.nome;
        document.getElementById('edit-material-unidade').value=m.unidade;
        document.getElementById('edit-material-valor').value=m.valor;
        document.getElementById('edit-material-modal').classList.add('active');
    };
    window.closeEditMaterialModal = () => document.getElementById('edit-material-modal').classList.remove('active');
    window.deleteMaterial = async (id) => { if(confirm('Excluir item?')) await deleteDoc(doc(db, `users/${userId}/materiais/${id}`)); };

    window.openEditTipoServicoModal = (id) => {
        const s = appState.tiposDeServico.find(x => x.id === id); if(!s) return;
        document.getElementById('edit-tiposervico-id').value=s.id;
        document.getElementById('edit-tiposervico-categoria').value=s.categoria;
        document.getElementById('edit-tiposervico-descricao').value=s.descricao;
        document.getElementById('edit-tiposervico-valor').value=s.valor;
        document.getElementById('edit-tiposervico-modal').classList.add('active');
    };
    window.closeEditTipoServicoModal = () => document.getElementById('edit-tiposervico-modal').classList.remove('active');
    window.deleteTipoDeServico = async (id) => { if(confirm('Excluir servi√ßo?')) await deleteDoc(doc(db, `users/${userId}/tiposdeservico/${id}`)); };

    // Or√ßamentos (Edi√ß√£o e Exclus√£o em Lote)
    window.editOrcamento = (id) => {
        const orc = appState.orcamentos.find(o => String(o.id) === String(id));
        if (orc) window.openOrcamentoModal(orc);
        else alert('Or√ßamento n√£o encontrado.');
    };

    window.toggleOrcamentoExclusao = (checkbox) => {
        const id = checkbox.dataset.id;
        if(checkbox.checked) appState.orcamentosParaExcluir.add(id);
        else appState.orcamentosParaExcluir.delete(id);
        const btn = document.getElementById('btn-delete-selected-orcamentos');
        if(btn) btn.disabled = (appState.orcamentosParaExcluir.size === 0);
    };

    window.confirmDeleteSelectedOrcamentos = () => {
        if(appState.orcamentosParaExcluir.size > 0) {
            document.getElementById('delete-confirm-modal').classList.add('active');
            document.getElementById('delete-confirm-message').textContent = `Apagar ${appState.orcamentosParaExcluir.size} itens?`;
        }
    };
    
    window.closeDeleteConfirmModal = async (confirm) => {
        document.getElementById('delete-confirm-modal').classList.remove('active');
        if(confirm) {
            const batch = writeBatch(db);
            appState.orcamentosParaExcluir.forEach(id => batch.delete(doc(db, `users/${userId}/orcamentos/${id}`)));
            await batch.commit();
            appState.orcamentosParaExcluir.clear();
            alert('Exclu√≠dos com sucesso.');
        }
    };

    // ===== 4. FINANCEIRO (CORRE√á√ÉO MATEM√ÅTICA) =====
    window.updateFinanceiroView = () => {
        const anoSel = document.getElementById('fat-ano')?.value || 'todos';
        const mesSel = document.getElementById('fat-mes')?.value || 'all';
        const vis = document.getElementById('chart-periodo')?.value || 'mensal';
        const divMes = document.getElementById('fat-mes')?.parentElement;
        
        let tBruto=0, tLiq=0, ap=0, pe=0, labels=[], data=[];

        if(vis === 'mensal') {
            if(divMes) divMes.style.display = 'flex';
            appState.orcamentos.forEach(o => {
                if(!o.createdAt) return;
                const d = new Date(o.createdAt);
                if(anoSel!=='todos' && d.getFullYear().toString() !== anoSel) return;
                if(mesSel!=='all' && d.getMonth().toString() !== mesSel) return;
                
                const val = parseFloat(o.total) || 0; // For√ßa convers√£o num√©rica
                tBruto += val;
                if(o.status === 'aprovado' || o.aprovado) { tLiq += val; ap++; } else { pe++; }
            });
            labels = ['Gerado', 'Aprovado']; 
            data = [tBruto, tLiq];
        } else {
            if(divMes) divMes.style.display = 'none';
            const mb = Array(12).fill(0);
            appState.orcamentos.forEach(o => {
                if(!o.createdAt) return;
                const d = new Date(o.createdAt);
                if(anoSel!=='todos' && d.getFullYear().toString() !== anoSel) return;
                
                const val = parseFloat(o.total) || 0;
                const m = d.getMonth();
                mb[m] += val; tBruto += val;
                if(o.status === 'aprovado' || o.aprovado) { tLiq += val; ap++; } else { pe++; }
            });
            labels = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            data = (chartType === 'pie') ? [tBruto, tLiq] : mb;
        }

        const fmt = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
        if(document.getElementById('fat-bruto')) document.getElementById('fat-bruto').textContent = fmt(tBruto);
        if(document.getElementById('fat-liquido')) document.getElementById('fat-liquido').textContent = fmt(tLiq);
        if(document.getElementById('fat-contagem')) document.getElementById('fat-contagem').textContent = `${ap} aprov / ${pe} pend`;

        const ctx = document.getElementById('finance-chart');
        if(ctx) {
            if(financeChart) financeChart.destroy();
            financeChart = new Chart(ctx, {
                type: chartType,
                data: { 
                    labels: (chartType==='pie' && vis==='anual') ? ['Total Gerado','Total Aprovado'] : labels, 
                    datasets: [{ label:'Valor', data:data, backgroundColor:['#FACC15','#22C55E','#3B82F6'] }] 
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    };
    window.mudarTipoGrafico = (t) => { chartType = t; window.updateFinanceiroView(); };

    // ===== 5. MODAL DE OR√áAMENTO (TOGGLES VISUAIS) =====
    window.openOrcamentoModal = (editObj = null) => {
        const modal = document.getElementById('orcamento-modal');
        const sel = document.getElementById('orc-cliente-select');
        
        // Reset
        appState.currentOrcamento = { id:null, cliente:null, modoCobranca:'mao_de_obra', usarMaterial:'sim', tiposDeServico:[], items:[], maoDeObra:{tipo:'',valor:0}, desconto:{tipo:'nenhum',valor:0}, total:0 };
        
        // Popula Selects
        sel.innerHTML = '<option value="">Selecione</option>' + appState.clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
        populateMateriaisOrcamento();
        populateTiposDeServicoOrcamento();
        
        modal.classList.add('active');

        if (editObj) {
            document.getElementById('modal-title').textContent = 'Editar Or√ßamento';
            const clone = JSON.parse(JSON.stringify(editObj));
            // Defaults
            clone.modoCobranca = clone.modoCobranca || 'mao_de_obra';
            clone.usarMaterial = clone.usarMaterial || 'sim';
            clone.desconto = clone.desconto || {tipo:'nenhum', valor:0};
            clone.maoDeObra = clone.maoDeObra || {tipo:'', valor:0};
            
            appState.currentOrcamento = clone;

            // UI
            document.getElementById('orc-descricao-servico').value = clone.descricaoServico || '';
            if(clone.cliente?.id) sel.value = clone.cliente.id;
            document.getElementById('orc-status-aprovado').checked = (clone.status === 'aprovado');
            
            checkRadio('modo-cobranca', clone.modoCobranca);
            checkRadio('usar-material', clone.usarMaterial);
            checkRadio('tipo-obra', clone.tipoObra || 'residencial');

            // M√£o de Obra Inputs
            if(clone.maoDeObra.tipo) {
                checkRadio('tipo-servico', clone.maoDeObra.tipo);
                const map={'empreitada':'empreitada-valor', 'diaria':'diaria-qtd', 'ponto':'ponto-qtd', 'hora':'hora-qtd'};
                const inp = document.getElementById(map[clone.maoDeObra.tipo]);
                if(inp) inp.value = clone.maoDeObra.raw_value || '';
            }
            
            // Desconto
            document.getElementById('orc-desconto-tipo').value = clone.desconto.tipo;
            const dv = document.getElementById('orc-desconto-valor');
            dv.value = clone.desconto.valor || '';
            dv.disabled = (clone.desconto.tipo === 'nenhum');
            
            applyVisualToggles(clone.modoCobranca, clone.usarMaterial);

            setTimeout(() => {
               if(clone.items) restoreCheckboxes('orc-materiais-list', clone.items);
               if(clone.tiposDeServico) restoreCheckboxes('orc-tiposdeservico-list', clone.tiposDeServico);
               window.calculateMaoDeObra(); window.updateOrcamentoPreview();
            }, 200);

        } else {
            document.getElementById('modal-title').textContent = 'Criar Or√ßamento';
            document.getElementById('orc-descricao-servico').value = '';
            document.getElementById('orc-status-aprovado').checked = false;
            sel.value = '';
            
            // Reset Inputs
            document.querySelectorAll('#orc-mao-de-obra input[type="number"]').forEach(i=>i.value='');
            document.querySelectorAll('input[name="tipo-servico"]').forEach(r=>r.checked=false);
            
            checkRadio('modo-cobranca', 'mao_de_obra');
            checkRadio('usar-material', 'sim');
            applyVisualToggles('mao_de_obra', 'sim');
            window.updateOrcamentoPreview();
        }
    };
    
    window.closeOrcamentoModal = () => {
        document.getElementById('orcamento-modal').classList.remove('active');
        // Limpa visual das listas
        document.querySelectorAll('#orc-materiais-list input, #orc-tiposdeservico-list input').forEach(e=>{ if(e.type==='checkbox')e.checked=false; if(e.type==='number'){e.value=1;e.disabled=true;} });
    };
    
    function applyVisualToggles(modo, mat) {
        const mo = document.getElementById('orc-cobranca-mo-wrapper');
        const serv = document.getElementById('orc-cobranca-servico-wrapper');
        const mlist = document.getElementById('orc-cobranca-material-wrapper');
        if(modo==='por_servico') { mo.classList.add('hidden'); serv.classList.remove('hidden'); }
        else { mo.classList.remove('hidden'); serv.classList.add('hidden'); }
        if(mat==='nao') mlist.classList.add('hidden'); else mlist.classList.remove('hidden');
    }

    // ===== 6. SUBMITS E UTILS =====
    function updateConfigForm() {
        const c = appState.config || {};
        const set = (i,v) => { const e=document.getElementById(i); if(e) e.value=(v!==undefined)?v:''; };
        set('config-nome', c.nome); set('config-telefone', formatarTelefone(c.telefone));
        set('config-doc', formatarCPFCNPJ(c.doc)); set('config-cep', formatarCEP(c.cep));
        set('config-numero', c.numero); set('config-logradouro', c.logradouro);
        set('config-bairro', c.bairro); set('config-cidade', c.cidade); set('config-uf', c.uf);
        
        if(c.logo) {
            document.getElementById('config-logo').value=c.logo;
            document.getElementById('config-logo-preview').src=c.logo;
            document.getElementById('config-logo-preview-wrapper').classList.remove('hidden');
        }
        set('config-residencial-empreitada', c.residencial_empreitada);
        set('config-residencial-diaria', c.residencial_diaria);
        set('config-residencial-ponto', c.residencial_ponto);
        set('config-residencial-hora', c.residencial_hora);
        set('config-industrial-diaria', c.industrial_diaria);
        set('config-industrial-ponto', c.industrial_ponto);
        set('config-industrial-hora', c.industrial_hora);
        set('config-pix-chave', c.config_pix_chave);
        set('config-cartao-vezes', c.config_cartao_vezes);
        set('config-cartao-juros', c.config_cartao_juros);
        set('config-deposito-banco', c.config_deposito_banco);
        set('config-deposito-ag', c.config_deposito_ag);
        set('config-deposito-conta', c.config_deposito_conta);
        if(document.getElementById('config-pagamento-dinheiro')) document.getElementById('config-pagamento-dinheiro').checked = !!c.config_pagamento_dinheiro;
    }

    function setupManualListeners() {
        document.getElementById('btn-novo-orcamento')?.addEventListener('click', () => window.openOrcamentoModal());
        
        // Search
        document.getElementById('search-cliente')?.addEventListener('input', (e)=>{
            const q=e.target.value.toLowerCase();
            document.querySelectorAll('#clientes-list > div').forEach(d=>{ d.style.display=d.innerText.toLowerCase().includes(q)?'flex':'none'; });
        });
        document.getElementById('filter-tipos')?.addEventListener('input', (e)=>{
            const q=e.target.value.toLowerCase();
            document.querySelectorAll('#orc-tiposdeservico-list label span').forEach(s=>{ s.closest('label').parentElement.style.display=s.innerText.toLowerCase().includes(q)?'':'none'; });
        });

        // Toggles
        document.querySelectorAll('input[name="modo-cobranca"]').forEach(r => {
            r.addEventListener('change', (e) => { if(appState.currentOrcamento) appState.currentOrcamento.modoCobranca=e.target.value; applyVisualToggles(e.target.value, appState.currentOrcamento?.usarMaterial||'sim'); window.updateOrcamentoPreview(); });
        });
        document.querySelectorAll('input[name="usar-material"]').forEach(r => {
            r.addEventListener('change', (e) => { if(appState.currentOrcamento) appState.currentOrcamento.usarMaterial=e.target.value; applyVisualToggles(appState.currentOrcamento?.modoCobranca||'mao_de_obra', e.target.value); window.updateOrcamentoPreview(); });
        });

        // Listeners Modal
        document.getElementById('orc-cliente-select')?.addEventListener('change', (e)=>{
            if(!appState.currentOrcamento) resetCurrentOrcamento();
            appState.currentOrcamento.cliente = appState.clientes.find(x=>x.id===e.target.value) || null;
            window.updateOrcamentoPreview();
        });
        document.getElementById('orc-tipo-obra')?.addEventListener('change', (e)=>{ if(appState.currentOrcamento) appState.currentOrcamento.tipoObra = e.target.value==='industrial'?'industrial':'residencial'; window.calculateMaoDeObra(); window.updateOrcamentoPreview(); });
        document.getElementById('orc-mao-de-obra')?.addEventListener('input', ()=>{ window.calculateMaoDeObra(); window.updateOrcamentoPreview(); });
        document.getElementById('orc-descricao-servico')?.addEventListener('input', (e)=>{ if(appState.currentOrcamento) appState.currentOrcamento.descricaoServico=e.target.value; window.updateOrcamentoPreview(); });
        document.getElementById('orc-desconto-tipo')?.addEventListener('change', (e)=>{ const v=document.getElementById('orc-desconto-valor'); if(e.target.value==='nenhum'){v.disabled=true;v.value='';appState.currentOrcamento.desconto={tipo:'nenhum',valor:0};}else{v.disabled=false;appState.currentOrcamento.desconto.tipo=e.target.value;} window.updateOrcamentoPreview(); });
        document.getElementById('orc-desconto-valor')?.addEventListener('input', (e)=>{ appState.currentOrcamento.desconto.valor=parseFloat(e.target.value)||0; window.updateOrcamentoPreview(); });

        // Config Submit
        document.getElementById('form-config')?.addEventListener('submit', async(e)=>{e.preventDefault(); const g=(i)=>document.getElementById(i).value; const d={nome:g('config-nome'), telefone:g('config-telefone').replace(/\D/g,''), doc:g('config-doc').replace(/\D/g,''), cep:g('config-cep').replace(/\D/g,''), numero:g('config-numero'), logradouro:g('config-logradouro'), bairro:g('config-bairro'), cidade:g('config-cidade'), uf:g('config-uf'), logo:g('config-logo'), config_color_primary:g('config-color-primary'), config_color_secondary:g('config-color-secondary'), residencial_empreitada:parseFloat(g('config-residencial-empreitada'))||0, residencial_diaria:parseFloat(g('config-residencial-diaria'))||0, residencial_ponto:parseFloat(g('config-residencial-ponto'))||0, residencial_hora:parseFloat(g('config-residencial-hora'))||0, industrial_diaria:parseFloat(g('config-industrial-diaria'))||0, industrial_ponto:parseFloat(g('config-industrial-ponto'))||0, industrial_hora:parseFloat(g('config-industrial-hora'))||0, config_pix_chave:g('config-pix-chave'), config_cartao_vezes:parseInt(g('config-cartao-vezes'))||0, config_cartao_juros:parseFloat(g('config-cartao-juros'))||0, config_pagamento_dinheiro:document.getElementById('config-pagamento-dinheiro').checked, config_deposito_banco:g('config-deposito-banco'), config_deposito_ag:g('config-deposito-ag'), config_deposito_conta:g('config-deposito-conta')}; await setDoc(doc(db,`users/${userId}/config/main`), d, {merge:true}); alert('Salvo'); });
        
        // Outros Submits
        document.getElementById('form-cliente')?.addEventListener('submit', async(e)=>{e.preventDefault(); const d={nome:document.getElementById('cliente-nome').value, telefone:document.getElementById('cliente-telefone').value.replace(/\D/g,''), documento:document.getElementById('cliente-documento').value.replace(/\D/g,''), numeroCadastro:gerarNovoNumeroCliente(), cep:document.getElementById('cliente-cep').value.replace(/\D/g,''), numero:document.getElementById('cliente-numero').value, logradouro:document.getElementById('cliente-logradouro').value, bairro:document.getElementById('cliente-bairro').value, cidade:document.getElementById('cliente-cidade').value, uf:document.getElementById('cliente-uf').value}; await addDoc(collection(db,`users/${userId}/clientes`), d); e.target.reset(); alert('Salvo'); });
        document.getElementById('form-edit-cliente')?.addEventListener('submit', async(e)=>{e.preventDefault(); const id=document.getElementById('edit-cliente-id').value; const v=(i)=>document.getElementById(i).value; const d={nome:v('edit-cliente-nome'), numeroCadastro:v('edit-cliente-numerocadastro'), telefone:v('edit-cliente-telefone').replace(/\D/g,''), documento:v('edit-cliente-documento').replace(/\D/g,''), cep:v('edit-cliente-cep').replace(/\D/g,''), numero:v('edit-cliente-numero'), logradouro:v('edit-cliente-logradouro'), bairro:v('edit-cliente-bairro'), cidade:v('edit-cliente-cidade'), uf:v('edit-cliente-uf')}; await setDoc(doc(db,`users/${userId}/clientes/${id}`), d, {merge:true}); window.closeEditClienteModal(); alert('Atualizado'); });
        document.getElementById('form-material')?.addEventListener('submit', async(e)=>{e.preventDefault(); await addDoc(collection(db,`users/${userId}/materiais`),{nome:document.getElementById('material-nome').value, valor:parseFloat(document.getElementById('material-valor').value), unidade:document.getElementById('material-unidade').value}); e.target.reset(); alert('Salvo'); });
        document.getElementById('form-edit-material')?.addEventListener('submit', async(e)=>{e.preventDefault(); const id=document.getElementById('edit-material-id').value; const d={nome:document.getElementById('edit-material-nome').value, unidade:document.getElementById('edit-material-unidade').value, valor:parseFloat(document.getElementById('edit-material-valor').value)}; await setDoc(doc(db,`users/${userId}/materiais/${id}`), d); window.closeEditMaterialModal(); alert('Atualizado'); });
        document.getElementById('form-tiposervico')?.addEventListener('submit', async(e)=>{e.preventDefault(); const s=document.getElementById('tiposervico-categoria-select'); const c=s.value==='new_category'?document.getElementById('tiposervico-categoria-new').value:s.value; await addDoc(collection(db,`users/${userId}/tiposdeservico`),{categoria:c.toUpperCase(), descricao:document.getElementById('tiposervico-descricao').value, valor:parseFloat(document.getElementById('tiposervico-valor').value)}); e.target.reset(); alert('Salvo'); });
        document.getElementById('form-edit-tiposervico')?.addEventListener('submit', async(e)=>{e.preventDefault(); const id=document.getElementById('edit-tiposervico-id').value; const d={categoria:document.getElementById('edit-tiposervico-categoria').value.toUpperCase(), descricao:document.getElementById('edit-tiposervico-descricao').value, valor:parseFloat(document.getElementById('edit-tiposervico-valor').value)}; await setDoc(doc(db,`users/${userId}/tiposdeservico/${id}`), d); window.closeEditTipoServicoModal(); alert('Atualizado'); });
        
        // M√°scaras Listeners
        document.getElementById('config-doc')?.addEventListener('input', handleDocMask);
        document.getElementById('config-telefone')?.addEventListener('input', handleTelefoneMask);
        document.getElementById('config-cep')?.addEventListener('input', handleCEPMask);
    }

    function renderClientesList() {
        const el = document.getElementById('clientes-list');
        if(!appState.clientes.length) { el.innerHTML='<p class="text-gray-500 p-2">Vazio.</p>'; return; }
        el.innerHTML = appState.clientes.map(c => `
            <div class="flex justify-between items-center p-3 border rounded bg-white mb-2 hover:bg-gray-50">
                <div class="flex-grow cursor-pointer" onclick="window.openEditClienteModal('${c.id}')">
                    <p class="font-bold text-gray-800">${c.nome} <span class="text-xs bg-gray-200 px-2 rounded-full text-gray-600">${c.numeroCadastro||''}</span></p>
                    <p class="text-sm text-gray-600">${c.telefone ? formatarTelefone(c.telefone) : ''}</p>
                </div>
                <button onclick="window.deleteCliente('${c.id}')" class="text-red-500 hover:text-red-700 p-2 text-xl">&times;</button>
            </div>`).join('');
    }
    
    function renderMateriaisList() {
        const el = document.getElementById('materiais-list');
        if(!appState.materiais.length) { el.innerHTML='<p class="text-gray-500 p-2">Vazio.</p>'; return; }
        el.innerHTML = appState.materiais.map(m => `<div class="flex justify-between p-2 border rounded bg-white mb-1"><div class="flex-grow cursor-pointer" onclick="window.openEditMaterialModal('${m.id}')"><p class="font-medium">${m.nome}</p><p class="text-xs">R$ ${m.valor}</p></div><button onclick="window.deleteMaterial('${m.id}')" class="text-red-500 px-2">&times;</button></div>`).join('');
    }

    function renderTiposDeServicoList() {
        const el = document.getElementById('tiposdeservico-list');
        if(!appState.tiposDeServico.length) { el.innerHTML='<p class="text-gray-500 p-2">Vazio.</p>'; return; }
        const grp = appState.tiposDeServico.reduce((a,c)=>{const k=(c.categoria||'OUTROS').toUpperCase();(a[k]||(a[k]=[])).push(c);return a;},{});
        el.innerHTML = Object.keys(grp).sort().map(k=>`<details class="border rounded mb-1"><summary class="p-2 bg-gray-50 text-xs font-bold uppercase cursor-pointer">${k}</summary><div class="p-2">${grp[k].map(s=>`<div class="flex justify-between p-1 hover:bg-gray-50"><div class="flex-grow cursor-pointer" onclick="window.openEditTipoServicoModal('${s.id}')"><p class="text-sm">${s.descricao}</p><p class="text-xs text-green-600">R$ ${s.valor}</p></div><button onclick="window.deleteTipoDeServico('${s.id}')" class="text-red-500">&times;</button></div>`).join('')}</div></details>`).join('');
    }

    function renderOrcamentosList(isFull = false) {
        const el = isFull ? document.getElementById('all-orcamentos-list') : document.getElementById('orcamentos-list-recent');
        if(!el) return;
        let list = [...appState.orcamentos];
        if(!isFull) list = list.slice(0, 3);
        else {
            // Filtros
            const s=document.getElementById('filtro-status-orcamento').value;
            const m=document.getElementById('filtro-mes-orcamento').value;
            const a=document.getElementById('filtro-ano-orcamento').value;
            list=list.filter(o=>{
                const st=(o.status==='aprovado'||o.aprovado)?'aprovado':'pendente';
                if(s!=='todos' && st!==s) return false;
                const d=new Date(o.createdAt);
                if(m!=='todos' && d.getMonth().toString()!==m) return false;
                if(a!=='todos' && d.getFullYear().toString()!==a) return false;
                return true;
            });
        }
        if(!list.length) { el.innerHTML='<div class="text-center p-4 text-gray-500">Nenhum or√ßamento.</div>'; return; }
        el.innerHTML = list.map(o => {
            const cli = appState.clientes.find(c => c.id === o.cliente?.id);
            const nome = cli ? cli.nome : 'Cliente Exclu√≠do';
            const isAp = (o.status === 'aprovado' || o.aprovado);
            const badge = isAp ? '<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">APROVADO</span>' : '<span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded">PENDENTE</span>';
            
            // Checkbox para Full List
            const checkHtml = isFull ? `<input type="checkbox" data-id="${o.id}" ${appState.orcamentosParaExcluir.has(o.id)?'checked':''} onchange="window.toggleOrcamentoExclusao(this)" class="mr-3 h-5 w-5 text-red-600">` : '';
            
            return `
            <div class="bg-white p-3 rounded border shadow-sm mb-2 flex items-center">
                ${checkHtml}
                <div class="flex-grow overflow-hidden mr-2">
                    <div class="flex justify-between items-start mb-1">
                        <p class="font-bold truncate text-gray-800">${nome}</p>
                        ${badge}
                    </div>
                    <p class="text-xs text-gray-500">${o.numeroOrcamento||''} ‚Ä¢ R$ ${Number(o.total||0).toFixed(2)}</p>
                </div>
                <button onclick="window.editOrcamento('${o.id}')" class="bg-yellow-400 hover:bg-yellow-500 text-white p-2 rounded shadow-sm ml-2">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                </button>
            </div>`;
        }).join('');
        
        if(isFull) {
            const btn = document.getElementById('btn-delete-selected-orcamentos');
            if(btn) btn.disabled = (appState.orcamentosParaExcluir.size===0);
        }
    }

    // Preview e PDF
    window.shareOrViewPDF = async () => { const el=document.getElementById('pdf-preview'); const opt={margin:10,filename:'orcamento.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}; html2pdf().set(opt).from(el).save(); };
    window.sendWhatsAppText = () => { if(!appState.currentOrcamento?.cliente)return; const t=appState.currentOrcamento.cliente.telefone.replace(/\D/g,''); window.open(`https://wa.me/55${t}`, '_blank'); };
    window.loginWithGoogle=async()=>{try{await signInWithPopup(auth, new GoogleAuthProvider());}catch(e){alert('Erro login');}};
    window.logout=async()=>{if(confirm('Sair?'))await signOut(auth);};
    
    // Utils de Renderiza√ß√£o Interna do Modal
    window.calculateMaoDeObra = () => { /* (L√≥gica j√° inclusa nos listeners) */ const e = new Event('input'); document.getElementById('orc-mao-de-obra').dispatchEvent(e); }; // Mock para compatibilidade se chamado externamente
    function populateSelects(){/*...*/ const l=document.getElementById('orc-materiais-list'); if(l) l.innerHTML=appState.materiais.map(m=>`<div class="flex justify-between p-2 hover:bg-gray-50"><label class="flex flex-grow"><input type="checkbox" data-id="${m.id}" class="mr-2"><span class="text-sm">${m.nome} - R$ ${m.valor}</span></label><input type="number" min="1" value="1" data-id="${m.id}" class="w-16 border rounded text-sm" disabled></div>`).join(''); const s=document.getElementById('orc-tiposdeservico-list'); if(s){const g=groupBy(appState.tiposDeServico,'categoria'); s.innerHTML=Object.keys(g).sort().map(k=>`<details class="mb-1 border rounded"><summary class="p-2 bg-gray-50 text-xs font-bold uppercase">${k}</summary><div class="p-2">${g[k].map(i=>`<div class="flex justify-between p-1 hover:bg-gray-50"><label class="flex flex-grow"><input type="checkbox" data-id="${i.id}" class="mr-2"><span class="text-sm">${i.descricao} - R$ ${i.valor}</span></label><input type="number" min="1" value="1" data-id="${i.id}" class="w-16 border rounded text-sm" disabled></div>`).join('')}</div></details>`).join('');}
       // Re-attach listeners espec√≠ficos
       document.getElementById('orc-materiais-list').addEventListener('input', (e)=>{
           const t=e.target; const id=t.dataset.id; const m=appState.materiais.find(x=>x.id===id); if(!m)return;
           const q=document.querySelector(`#orc-materiais-list input[type="number"][data-id="${id}"]`);
           if(t.type==='checkbox'){if(t.checked){q.disabled=false; appState.currentOrcamento.items.push({...m,quantidade:1});}else{q.disabled=true; appState.currentOrcamento.items=appState.currentOrcamento.items.filter(x=>x.id!==id);}} else if(t.type==='number'){const i=appState.currentOrcamento.items.find(x=>x.id===id); if(i)i.quantidade=parseInt(t.value)||1;} window.updateOrcamentoPreview();
       });
       document.getElementById('orc-tiposdeservico-list').addEventListener('input', (e)=>{
           const t=e.target; const id=t.dataset.id; const s=appState.tiposDeServico.find(x=>x.id===id); if(!s)return;
           const q=document.querySelector(`#orc-tiposdeservico-list input[type="number"][data-id="${id}"]`);
           if(t.type==='checkbox'){if(t.checked){q.disabled=false; appState.currentOrcamento.tiposDeServico.push({...s,quantidade:1});}else{q.disabled=true; appState.currentOrcamento.tiposDeServico=appState.currentOrcamento.tiposDeServico.filter(x=>x.id!==id);}} else if(t.type==='number'){const i=appState.currentOrcamento.tiposDeServico.find(x=>x.id===id); if(i)i.quantidade=parseInt(t.value)||1;} window.updateOrcamentoPreview();
       });
    }

    function formatarTelefone(v){v=String(v).replace(/\D/g,''); return v.replace(/(\d{2})(\d{5})(\d{4})/,"($1) $2-$3");}
    function formatarCPFCNPJ(v){v=String(v).replace(/\D/g,''); if(v.length<=11)return v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4"); return v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,"$1.$2.$3/$4-$5");}
    function formatarCEP(v){v=String(v).replace(/\D/g,''); return v.replace(/(\d{5})(\d{3})/,"$1-$2");}
    function handleDocMask(e){e.target.value=formatarCPFCNPJ(e.target.value);}
    function handleTelefoneMask(e){e.target.value=formatarTelefone(e.target.value);}
    function handleCEPMask(e){e.target.value=formatarCEP(e.target.value);}
    function checkRadio(n,v){const el=document.querySelector(`input[name="${n}"][value="${v}"]`); if(el)el.checked=true;}
    function restoreCheckboxes(lid, items){ if(!items)return; items.forEach(i=>{const cb=document.querySelector(`#${lid} input[data-id="${i.id}"]`); const qt=document.querySelector(`#${lid} input[type="number"][data-id="${i.id}"]`); if(cb)cb.checked=true; if(qt){qt.disabled=false; qt.value=i.quantidade;}});}
    function populateCategorySelect(){const s=document.getElementById('tiposervico-categoria-select'); const c=[...new Set(appState.tiposDeServico.map(x=>x.categoria).filter(Boolean))].sort(); while(s.options.length>2)s.remove(2); c.forEach(k=>{const o=document.createElement('option'); o.value=k; o.text=k; s.add(o);});}
    function groupBy(arr, k) { return arr.reduce((acc,c)=>{ const key=(c[k]||'OUTROS').toUpperCase(); (acc[key]||(acc[key]=[])).push(c); return acc; },{}); }
    function gerarNovoNumeroCliente(){const ids=appState.clientes.map(c=>c.numeroCadastro).filter(x=>x&&x.startsWith('CL')); let max=0; ids.forEach(i=>{const n=parseInt(i.substring(2,5)); if(!isNaN(n)&&n>max)max=n;}); const seq=(max+1).toString().padStart(3,'0'); const d=new Date(); return `CL${seq}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getFullYear().toString().slice(-2)}`;}

  </script>
 
</body>
</html>
