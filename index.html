<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerador de Orçamentos 5.0 — Categorias & Submenus</title>
  <link rel="icon" href="https://eusoueletricista.com.br/wp-c...ds/2025/09/cropped-cropped-Mascote-Eletricista-5.0-1-1.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab.active { border-bottom: 2px solid #2563EB; color: #2563EB; font-weight: 600; }
   .modal { 
      display:none; 
      position:fixed; 
      inset:0; 
      background: rgba(0,0,0,.5); 
      z-index: 9999;
      align-items:center; 
      justify-content:center; 
    }
    .modal.active { display:flex; }
    /* Slim look for serviços */
    .servico-slim { font-size: 0.80rem; line-height: 1.1rem; font-weight: 300; }
    .servico-slim strong { font-weight: 500; }
    details > summary::-webkit-details-marker { display:none; }
    details .arrow { transition: transform .2s; }
    details[open] .arrow { transform: rotate(180deg); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-blue-500"></div>
    <p class="mt-3 text-gray-600">Conectando...</p>
  </div>

  <div id="delete-confirm-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-sm shadow-xl text-center">
      <h3 class="text-xl font-bold text-red-600 mb-4">Confirmação de Exclusão</h3>
      <p id="delete-confirm-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end gap-3">
        <button onclick="closeDeleteConfirmModal(false)" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
        <button onclick="closeDeleteConfirmModal(true)" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">OK, Excluir</button>
      </div>
      </div>
  </div>
  
  <div id="edit-cliente-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Cliente</h3>
      <form id="form-edit-cliente" class="space-y-4">
        <input type="hidden" id="edit-cliente-id">
        <div>
          <label for="edit-cliente-nome" class="block text-sm font-medium text-gray-700">Nome</label>
          <input type="text" id="edit-cliente-nome" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div>
          <label for="edit-cliente-telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
          <input type="tel" id="edit-cliente-telefone" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div>
          <label for="edit-cliente-endereco" class="block text-sm font-medium text-gray-700">Endereço</label>
          <input type="text" id="edit-cliente-endereco" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeEditClienteModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>
      
  <div id="edit-material-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Material</h3>
      <form id="form-edit-material" class="space-y-4">
        <input type="hidden" id="edit-material-id">
        <div>
          <label for="edit-material-nome" class="block text-sm font-medium text-gray-700">Descrição</label>
          <input type="text" id="edit-material-nome" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="edit-material-unidade" class="block text-sm font-medium text-gray-700">Unidade</label>
            <select id="edit-material-unidade" class="w-full p-2 border rounded-md mt-1 h-10">
              <option>UNID</option><option>Pç</option><option>m</option><option>cx</option><option>kit</option>
            </select>
          </div>
          <div>
            <label for="edit-material-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
            <input type="number" step="0.01" id="edit-material-valor" class="w-full p-2 border rounded-md mt-1" required>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeEditMaterialModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  <div id="edit-tiposervico-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
        <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Tipo de Serviço</h3>
        <form id="form-edit-tiposervico" class="space-y-4">
            <input type="hidden" id="edit-tiposervico-id">
            <div>
                <label for="edit-tiposervico-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                <input type="text" id="edit-tiposervico-categoria" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: INSTALAÇÕES" required>
            </div>
            <div>
                <label for="edit-tiposervico-descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                <input type="text" id="edit-tiposervico-descricao" class="w-full p-2 border rounded-md mt-1" required>
            </div>
            <div>
                <label for="edit-tiposervico-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                <input type="number" step="0.01" id="edit-tiposervico-valor" class="w-full p-2 border rounded-md mt-1" required>
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeEditTipoServicoModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Alterações</button>
            </div>
        </form>
    </div>
  </div>

  <div id="login-view" class="hidden h-screen flex flex-col justify-center items-center text-center p-6 bg-gray-100">
    <h1 class="text-4xl font-bold text-gray-800">Bem-vindo ao</h1>
    <h2 class="text-5xl font-extrabold text-blue-600 mb-8">Gerador de Orçamentos 5.0</h2>
    <p class="max-w-md mb-8 text-gray-600">Seus dados salvos na nuvem.</p>
    <button id="login-button" class="bg-white text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-shadow flex items-center">
      <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.138,44,30.025,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
      Entrar com Google
    </button>
  </div>

  <div id="app-view" class="hidden">
    <header class="bg-gray-900 text-white shadow-md">
      <div class="max-w-4xl mx-auto py-3 px-4 md:px-6 flex justify-between items-center">
        <h1 class="text-2xl sm:text-3xl font-bold text-left">
          Gerador de Orçamentos
          <span class="block text-3xl sm:text-4xl">ELETRICISTA 5.0</span>
        </h1>
        <img 
          src="https://eusoueletricista.com.br/wp-content/uploads/2025/09/cropped-cropped-Mascote-Eletricista-5.0-1-1.png" 
          alt="Logo Eletricista 5.0" 
          class="h-12 sm:h-14 w-auto"
        >
      </div>
    </header>

    <div id="main-view">
      <div class="max-w-4xl mx-auto p-4 md:p-6 w-full">
        <p class="text-md text-gray-600 text-left sm:text-center -mt-2 mb-6">Crie, gerencie e envie orçamentos de forma rápida.</p>

        <div class="mb-6 border-b border-gray-200 hidden sm:block">
          <nav class="flex -mb-px space-x-6">
            <button class="tab active py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="orcamentos" onclick="changeTab(event, 'orcamentos')">Tela Inicial</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="clientes" onclick="changeTab(event, 'clientes')">Clientes</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="materiais" onclick="changeTab(event, 'materiais')">Materiais</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="servicos" onclick="changeTab(event, 'servicos')">Serviços</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600 flex items-center" data-tab="configuracoes" onclick="changeTab(event, 'configuracoes')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.575 1.558.75.244.081.503.14.767.17.844.088 1.517.766 1.517 1.61z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Configurações
            </button>
          </nav>
        </div>
        <div class="mb-6 sm:hidden space-y-2">
            <div class="grid grid-cols-3 gap-2">
                <button class="mobile-tab active text-white p-3 rounded-lg shadow-md bg-blue-500" data-tab="orcamentos" onclick="changeTab(event, 'orcamentos')">Início</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-green-500" data-tab="clientes" onclick="changeTab(event, 'clientes')">Clientes</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-yellow-500" data-tab="materiais" onclick="changeTab(event, 'materiais')">Materiais</button>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-purple-500" data-tab="servicos" onclick="changeTab(event, 'servicos')">Serviços</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-gray-500 flex items-center justify-center" data-tab="configuracoes" onclick="changeTab(event, 'configuracoes')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 sm:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.575 1.558.75.244.081.503.14.767.17.844.088 1.517.766 1.517 1.61z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Conf.
                </button>
                <div class="h-full"></div> </div>
        </div>

        <main>
          <div id="orcamentos" class="tab-content active space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <button onclick="showAllOrcamentosPage()" class="bg-gray-800 text-white p-4 rounded-lg flex justify-center items-center shadow hover:bg-gray-900 transition-colors">
                <h2 class="text-xl font-semibold text-center">Orçamentos</h2>
              </button>
              <button onclick="openOrcamentoModal()" class="bg-blue-600 text-white p-4 rounded-lg shadow hover:bg-blue-700 transition-colors font-medium flex justify-center items-center">
                <span class="text-xl font-semibold">+ Novo Orçamento</span>
              </button>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 pt-4">Últimos 3 Orçamentos</h3>
            <div id="orcamentos-list-recent" class="space-y-3"></div>
          </div>

          <div id="clientes" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Cadastrar Novo Cliente</h2>
              <form id="form-cliente" class="space-y-4">
                <input type="text" id="cliente-nome" placeholder="Nome do Cliente" class="w-full p-2 border rounded-md" required>
                <input type="tel" id="cliente-telefone" placeholder="Telefone (com DDD)" class="w-full p-2 border rounded-md" required>
                <input type="text" id="cliente-endereco" placeholder="Endereço Completo" class="w-full p-2 border rounded-md" required>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar Cliente</button>
              </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Clientes Cadastrados</h2>
              <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4" role="alert">
                <p class="text-sm font-medium">Para editar um cliente, clique sobre o nome dele. Para excluir, clique no &times;.</p>
              </div>
              <div id="clientes-list" class="space-y-2"><p class="text-gray-500">Nenhum cliente cadastrado.</p></div>
            </div>
          </div>

          <div id="materiais" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Cadastrar Novo Material</h2>
              <form id="form-material" class="flex flex-col sm:flex-row items-stretch sm:items-end gap-4">
                <div class="flex-grow">
                  <label class="block text-sm font-medium text-gray-700">Descrição</label>
                  <input type="text" id="material-nome" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: Tomada Dupla 10A" required>
                </div>
                <div class="sm:w-32">
                  <label class="block text-sm font-medium text-gray-700">Unidade</label>
                  <select id="material-unidade" class="w-full p-2 border rounded-md mt-1 h-10">
                    <option>UNID</option><option>Pç</option><option>m</option><option>cx</option><option>kit</option>
                  </select>
                </div>
                <div class="sm:w-40">
                  <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                  <input type="number" step="0.01" id="material-valor" class="w-full p-2 border rounded-md mt-1" placeholder="25.50" required>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors h-10 w-full sm:w-auto">Salvar Item</button>
              </form>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-xl font-semibold mb-4">Importar Materiais</h2>
                <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                    <p class="text-sm text-gray-600 mb-2">Importar planilha (.xlsx) com as colunas <strong>Descrição</strong>, <strong>Unidade</strong> e <strong>Valor</strong>.</p>
                    <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                      <input type="file" id="materiais-xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-700 flex-1">
                      <button id="btn-import-materiais-xlsx" class="whitespace-nowrap bg-emerald-600 text-white px-4 py-2 rounded-lg shadow hover:bg-emerald-700 transition">Importar Materiais</button>
                      <button id="btn-clear-materiais" class="whitespace-nowrap bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">Limpar Materiais</button>
                    </div>
                    <p id="materiais-xlsx-status" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Itens Cadastrados</h2>
              <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4" role="alert">
                <p class="text-sm font-medium">Para editar um item, clique sobre o nome dele. Para excluir, clique no &times;.</p>
              </div>
              <div id="materiais-list" class="space-y-2"><p class="text-gray-500">Nenhum material cadastrado.</p></div>
            </div>
          </div>

          <div id="servicos" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Tipos de Serviço</h2>

              <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                <p class="text-sm text-gray-600 mb-2">Importar planilha (.xlsx) com as colunas <strong>Categoria</strong>, <strong>Descrição</strong> e <strong>Valor</strong>.</p>
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                  <input type="file" id="xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm text-gray-700 flex-1">
                  <button id="btn-import-xlsx" class="whitespace-nowrap bg-emerald-600 text-white px-4 py-2 rounded-lg shadow hover:bg-emerald-700 transition">Importar</button>
                  <button id="btn-clear-tiposervico" class="whitespace-nowrap bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">Limpar Tudo</button>
                </div>
                <p id="xlsx-status" class="text-xs text-gray-500 mt-2"></p>
              </div>

              <div class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md mb-4" role="alert">
                <p class="text-sm font-medium">Para editar um serviço, clique sobre o nome dele. Para excluir, clique no &times;.</p>
                <p class="text-sm mt-1">Adicione um novo serviço escolhendo uma das categorias, ou adicione uma nova categoria.</p>
              </div>
              <form id="form-tiposervico" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Categoria</label>
                    <select id="tiposervico-categoria-select" class="w-full p-2 border rounded-md mt-1">
                      <option value="">Selecionar existente</option>
                      <option value="new_category">+ Nova Categoria</option>
                    </select>
                    <input type="text" id="tiposervico-categoria-new" placeholder="Nome da Nova Categoria" class="w-full p-2 border rounded-md mt-2 hidden">
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="tiposervico-descricao" placeholder="Ex: Instalação de Padrão" class="w-full p-2 border rounded-md mt-1" required>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                    <input type="number" step="0.01" id="tiposervico-valor" placeholder="150.00" class="w-full p-2 border rounded-md mt-1" required>
                  </div>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar</button>
              </form>

              <div id="tiposdeservico-list" class="space-y-2 mt-6">
                <p class="text-gray-500">Nenhum tipo de serviço cadastrado.</p>
              </div>
            </div>
          </div>

          <div id="configuracoes" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Configurações Gerais</h2>
              <form id="form-config" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <div>
                  <h3 class="text-lg font-medium mb-4 border-b pb-2">Seus Dados Profissionais</h3>
                  <div class="space-y-4">
                    <input type="text" id="config-nome" placeholder="Seu Nome ou Nome da Empresa" class="w-full p-2 border rounded-md" required>
                    <input type="tel" id="config-telefone" placeholder="Seu Telefone" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="config-doc" placeholder="Seu CPF ou CNPJ" class="w-full p-2 border rounded-md" required>
                    <input type="text" id="config-endereco" placeholder="Seu Endereço" class="w-full p-2 border rounded-md">
                    <input type="text" id="config-logo" placeholder="URL da sua Logomarca (opcional)" class="w-full p-2 border rounded-md">
                  </div>
                </div>
                <div>
                  <div>
                    <h3 class="text-lg font-medium mb-4 border-b pb-2">Valores Mão de Obra - Residencial/Predial</h3>
                    <div class="space-y-4">
                      <label class="block"><span class="text-gray-700">Valor por Empreitada (R$)</span><input type="number" step="0.01" id="config-residencial-empreitada" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor da Diária (R$)</span><input type="number" step="0.01" id="config-residencial-diaria" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Ponto (R$)</span><input type="number" step="0.01" id="config-residencial-ponto" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Hora (R$)</span><input type="number" step="0.01" id="config-residencial-hora" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    </div>
                  </div>
                  <div class="mt-6">
                    <h3 class="text-lg font-medium mb-4 border-b pb-2">Valores Mão de Obra - Industrial</h3>
                    <div class="space-y-4">
                      <label class="block"><span class="text-gray-700">Valor da Diária (R$)</span><input type="number" step="0.01" id="config-industrial-diaria" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Equipamento (R$)</span><input type="number" step="0.01" id="config-industrial-ponto" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                      <label class="block"><span class="text-gray-700">Valor por Hora (R$)</span><input type="number" step="0.01" id="config-industrial-hora" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    </div>
                  </div>
                </div>
                
                <div>
                  <h3 class="text-lg font-medium mb-4 border-b pb-2">Formas de Pagamento</h3>
                  <div class="space-y-4">
                    <label class="block"><span class="text-gray-700">Chave PIX</span><input type="text" id="config-pix-chave" class="w-full p-2 border rounded-md mt-1" placeholder="Sua chave PIX"></label>
                    <label class="block"><span class="text-gray-700">Cartão (Nº de Parcelas)</span><input type="number" step="1" id="config-cartao-vezes" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 12"></label>
                    <label class="block"><span class="text-gray-700">Cartão (Juros % por parcela)</span><input type="number" step="0.01" id="config-cartao-juros" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 1.99"></label>
                    <label class="flex items-center"><input type="checkbox" id="config-pagamento-dinheiro" class="h-4 w-4 text-blue-600 border-gray-300 rounded mr-2"><span class="text-gray-700">Aceita Dinheiro</span></label>
                    <h4 class="text-md font-medium pt-2 border-t mt-2">Dados para Depósito</h4>
                    <label class="block"><span class="text-gray-700">Banco</span><input type="text" id="config-deposito-banco" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: Banco do Brasil"></label>
                    <label class="block"><span class="text-gray-700">Agência</span><input type="text" id="config-deposito-ag" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 0001"></label>
                    <label class="block"><span class="text-gray-700">Conta</span><input type="text" id="config-deposito-conta" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 12345-6"></label>
                  </div>
                </div>
                <div class="md:col-span-2 text-right">
                  <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors inline-flex items-center" id="save-config-btn">
                    <span id="save-config-text">Salvar Configurações</span>
                    <span id="save-config-spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </main>

      </div>
    </div>

    <div id="all-orcamentos-view" class="hidden max-w-4xl mx-auto p-4 md:p-6 w-full">
      <div class="flex items-center justify-between mb-4">
        <button onclick="closeAllOrcamentosPage()" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg hover:bg-gray-300 transition text-sm flex items-center">
          <span class="mr-1">&larr;</span> Voltar
        </button>
        <h2 class="text-xl font-semibold text-gray-800">Todos os Orçamentos</h2>
      </div>

      <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm mb-4">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm text-left">
            <thead class="text-xs uppercase text-gray-500 border-b">
              <tr>
                <th class="py-2 px-2">#</th>
                <th class="py-2 px-2">Cliente</th>
                <th class="py-2 px-2 hidden sm:table-cell">Endereço</th>
                <th class="py-2 px-2">Total</th>
                <th class="py-2 px-2 hidden sm:table-cell">Criado em</th>
                <th class="py-2 px-2 text-center">Excluir</th>
              </tr>
            </thead>
            <tbody id="tabela-orcamentos-list"></tbody>
          </table>
        </div>

        <div class="mt-4 text-right">
          <button class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center" id="btn-excluir-selecionados" disabled>
            <span id="btn-excluir-selecionados-texto">Excluir Selecionados</span>
            <span id="btn-excluir-spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>
          </button>
        </div>
      </div>

      <div class="text-sm text-gray-500 italic">Somente seus orçamentos estão listados aqui.</div>
    </div>

    <div id="orcamento-modal" class="fixed inset-0 bg-black/50 hidden z-[10000] items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-start p-4 border-b">
          <div>
            <h3 class="text-lg font-semibold text-gray-800 leading-tight flex flex-col sm:flex-row sm:items-center sm:gap-3">
              <span>Orçamento</span>
              <span class="text-xs font-normal text-gray-600 block sm:inline" id="orcamento-numero-label">(Novo)</span>
            </h3>
            <p class="text-xs text-gray-500" id="orcamento-versao-label"></p>
          </div>
          <button onclick="closeOrcamentoModal()" class="text-gray-400 hover:text-gray-700 text-2xl leading-none">&times;</button>
        </div>

        <div class="p-4 overflow-y-auto flex-1 space-y-6 text-sm">

          <div class="space-y-2">
            <label class="block text-gray-700 text-sm font-medium">Cliente</label>
            <select id="orc-cliente" class="w-full border p-2 rounded-md">
              <option value="">Selecione um cliente</option>
            </select>
          </div>

          <div class="space-y-2">
            <label class="block text-gray-700 text-sm font-medium">Serviços</label>
            <div class="flex flex-col sm:flex-row gap-2">
              <select id="orc-servico" class="w-full border p-2 rounded-md flex-1">
                <option value="">Selecionar serviço</option>
              </select>
              <button type="button" onclick="adicionarTipoDeServicoAoOrcamento()" class="bg-blue-600 text-white px-3 py-2 rounded-md shadow hover:bg-blue-700 transition-colors text-sm whitespace-nowrap">Adicionar Serviço</button>
            </div>
            <ul id="orc-servico-list" class="text-xs text-gray-700 border rounded-md p-2 space-y-1 bg-gray-50"></ul>
          </div>

          <div class="space-y-2">
            <label class="block text-gray-700 text-sm font-medium">Materiais</label>
            <div class="flex flex-col sm:flex-row gap-2">
              <select id="orc-item" class="w-full border p-2 rounded-md flex-1">
                <option value="">Selecionar material</option>
              </select>
              <input type="number" min="1" step="1" id="orc-item-qtd" class="border p-2 rounded-md w-full sm:w-24" placeholder="Qtd">
              <button type="button" onclick="adicionarItemAoOrcamento()" class="bg-blue-600 text-white px-3 py-2 rounded-md shadow hover:bg-blue-700 transition-colors text-sm whitespace-nowrap">Adicionar Material</button>
            </div>
            <ul id="orc-itens-list" class="text-xs text-gray-700 border rounded-md p-2 space-y-1 bg-gray-50"></ul>
          </div>

          <div class="space-y-2">
            <label class="block text-gray-700 text-sm font-medium">Tipo de Obra</label>
            <select id="orc-tipo-obra" class="w-full border p-2 rounded-md" onchange="updateMaoDeObraOptions()">
              <option value="residencial">Residencial / Predial</option>
              <option value="industrial">Industrial</option>
            </select>
          </div>

          <div class="space-y-2">
            <label class="block text-gray-700 text-sm font-medium">Mão de Obra</label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              <select id="mao-obra-tipo" class="w-full border p-2 rounded-md" onchange="updateMaoDeObraValor()">
                <option value="">Selecionar tipo</option>
                <option value="empreitada">Empreitada (Fixo)</option>
                <option value="diaria">Diária</option>
                <option value="ponto">Por Ponto / Equipamento</option>
                <option value="hora">Por Hora</option>
              </select>
              <input type="number" min="0" step="0.01" id="mao-obra-valor" class="border p-2 rounded-md w-full" placeholder="0.00" oninput="setMaoDeObraManual()">
            </div>
            <div class="text-xs text-gray-500 leading-snug">
              <div><strong>Empreitada:</strong> Valor fechado total.</div>
              <div><strong>Diária:</strong> Valor por dia de serviço.</div>
              <div><strong>Ponto / Equipamento:</strong> Valor fixo por instalação.</div>
              <div><strong>Hora:</strong> Valor por hora trabalhada.</div>
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-gray-700 text-sm font-medium">Observações Internas (não vai para o cliente)</label>
            <textarea id="orc-observacoes" class="w-full border p-2 rounded-md text-xs min-h-[60px]" placeholder="Ex.: Cliente pediu urgência; voltar com material X; acesso ao local restrito."></textarea>
          </div>

          <div class="space-y-2">
            <h4 class="text-gray-700 text-sm font-semibold">Pré-visualização (vai para o PDF)</h4>
            <div class="border rounded-lg bg-white max-h-[300px] overflow-y-auto p-3">
              <div id="orcamento-preview-note" class="text-xs text-gray-500 italic mb-2">
                Sempre confira antes de enviar.
              </div>
              <div id="orcamento-preview" class="text-xs leading-relaxed text-gray-800">
                <p class="text-gray-400">Nenhum cliente selecionado.</p>
              </div>
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-gray-700 text-sm font-medium">Texto para WhatsApp (opcional)</label>
            <textarea id="orc-whats-msg" class="w-full border p-2 rounded-md text-xs min-h-[60px]" placeholder="Mensagem personalizada que será enviada junto com o PDF."></textarea>
          </div>

        </div>

        <div class="border-t p-4 bg-gray-50 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="text-xs text-gray-500 leading-tight">
            <div id="orcamento-createdAt-label"></div>
            <div id="orcamento-debug-label" class="text-[10px] text-gray-400"></div>
          </div>

          <div class="flex flex-col sm:flex-row gap-2 sm:items-center w-full sm:w-auto">
            <button onclick="saveOrcamento()" class="bg-blue-600 text-white text-xs px-4 py-2 rounded-md shadow hover:bg-blue-700 transition-colors">Salvar Orçamento</button>
            <button onclick="shareOrViewPDF()" class="bg-green-600 text-white text-xs px-4 py-2 rounded-md shadow hover:bg-green-700 transition-colors">Enviar PDF</button>
            <button onclick="sendWhatsAppText()" class="bg-teal-500 text-white text-xs px-4 py-2 rounded-md shadow hover:bg-teal-600 transition-colors">Enviar (só texto)</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-gray-900 text-white text-center py-6 mt-12">
      <div class="max-w-4xl mx-auto px-4 md:px-6">
        <p class="mb-4">Para ajustes ou sugestões de melhorias, mande uma mensagem.</p>
        <a href="https://wa.me/5551999600889" target="_blank" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md inline-block">Enviar mensagem ao desenvolvedor</a>
      </div>
    </footer>

  </div> <script type="module">

    console.log("VERSÃO 4.1 (Pagamentos e Ajustes de Layout) CARREGADA"); 
    // ===== Firebase config (preservado do seu arquivo) =====
    const firebaseConfig = {
      apiKey: "AIzaSyB-0cfQ1Y9Cz12grbia7-Y4nSlWwmXrqWg",
      authDomain: "app-orcamentos-eletrica.firebaseapp.com",
      projectId: "app-orcamentos-eletrica",
      storageBucket: "app-orcamentos-eletrica.firebasestorage.app",
      messagingSenderId: "424397941585",
      appId: "1:424397941585:web:3d5a24606f1a4f6ae54170"
    };

    // Imports Firebase
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, collection, onSnapshot, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== Estado e elementos =====
    let app, db, auth, userId;
    setLogLevel('error'); // 'debug' | 'error'

    const loadingOverlay = document.getElementById('loading-overlay');
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const mainView = document.getElementById('main-view');
    const allOrcamentosView = document.getElementById('all-orcamentos-view');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');
    const userInfo = document.getElementById('user-info');

    const appState = {
      config: {}, clientes: [], materiais: [], orcamentos: [],
      tiposDeServico: [], currentOrcamento: null,
      orcamentosParaExcluir: new Set()
    };

    function resetCurrentOrcamento() {
      appState.currentOrcamento = {
        id: null, cliente: null, tiposDeServico: [], items: [],
        maoDeObra: { tipo: '', valor: 0, label: '', raw_value: '' },
        total: 0, tipoObra: 'residencial', createdAt: null,
        numeroOrcamento: null, versao: 1
      };
    }

    // ===== Inicialização Firebase e Auth =====
    async function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            userInfo.textContent = `Logado como: ${user.displayName || user.email}`;
            loadingOverlay.querySelector('p').textContent = 'Carregando seus dados...';
            loadAllData();
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            loadingOverlay.style.display = 'none';
          } else {
            userId = null;
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
            loadingOverlay.style.display = 'none';
          }
        });
      } catch (e) {
        console.error('Erro ao inicializar Firebase:', e);
        loadingOverlay.innerHTML = '<p class="text-red-600 font-semibold">Erro crítico ao conectar. Verifique as chaves do Firebase.</p>';
      }
    }

    function updateConfigForm() {
      const c = appState.config || {};
      document.getElementById('config-nome').value = c.nome || '';
      document.getElementById('config-telefone').value = c.telefone || '';
      document.getElementById('config-doc').value = c.doc || '';
      document.getElementById('config-endereco').value = c.endereco || '';
      document.getElementById('config-logo').value = c.logo || '';
      
      document.getElementById('config-residencial-empreitada').value = c.residencial_empreitada || '';
      document.getElementById('config-residencial-diaria').value = c.residencial_diaria || '';
      document.getElementById('config-residencial-ponto').value = c.residencial_ponto || '';
      document.getElementById('config-residencial-hora').value = c.residencial_hora || '';
      document.getElementById('config-industrial-diaria').value = c.industrial_diaria || '';
      document.getElementById('config-industrial-ponto').value = c.industrial_ponto || '';
      document.getElementById('config-industrial-hora').value = c.industrial_hora || '';

      // NOVOS CAMPOS
      document.getElementById('config-pix-chave').value = c.config_pix_chave || '';
      document.getElementById('config-cartao-vezes').value = c.config_cartao_vezes || '';
      document.getElementById('config-cartao-juros').value = c.config_cartao_juros || '';
      document.getElementById('config-pagamento-dinheiro').checked = c.config_pagamento_dinheiro || false;
      document.getElementById('config-deposito-banco').value = c.config_deposito_banco || '';
      document.getElementById('config-deposito-ag').value = c.config_deposito_ag || '';
      document.getElementById('config-deposito-conta').value = c.config_deposito_conta || '';
    }

    // ===== Form Config =====
    document.getElementById('form-config').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');

      const btn = document.getElementById('save-config-btn');
      const textSpan = document.getElementById('save-config-text');
      const spinSpan = document.getElementById('save-config-spinner');
      btn.disabled = true; textSpan.classList.add('hidden'); spinSpan.classList.remove('hidden');
      try {
        const data = {
          nome: document.getElementById('config-nome').value,
          telefone: document.getElementById('config-telefone').value,
          doc: document.getElementById('config-doc').value,
          endereco: document.getElementById('config-endereco').value,
          logo: document.getElementById('config-logo').value,
          
          residencial_empreitada: parseFloat(document.getElementById('config-residencial-empreitada').value) || 0,
          residencial_diaria: parseFloat(document.getElementById('config-residencial-diaria').value) || 0,
          residencial_ponto: parseFloat(document.getElementById('config-residencial-ponto').value) || 0,
          residencial_hora: parseFloat(document.getElementById('config-residencial-hora').value) || 0,
          industrial_diaria: parseFloat(document.getElementById('config-industrial-diaria').value) || 0,
          industrial_ponto: parseFloat(document.getElementById('config-industrial-ponto').value) || 0,
          industrial_hora: parseFloat(document.getElementById('config-industrial-hora').value) || 0,

          config_pix_chave: document.getElementById('config-pix-chave').value,
          config_cartao_vezes: document.getElementById('config-cartao-vezes').value,
          config_cartao_juros: document.getElementById('config-cartao-juros').value,
          config_pagamento_dinheiro: document.getElementById('config-pagamento-dinheiro').checked,
          config_deposito_banco: document.getElementById('config-deposito-banco').value,
          config_deposito_ag: document.getElementById('config-deposito-ag').value,
          config_deposito_conta: document.getElementById('config-deposito-conta').value,
        };
        await setDoc(doc(db, `users/${userId}/config/main`), data);
        alert('Configurações salvas!');
      } catch(e) { console.error(e); alert('Erro ao salvar.'); }
      finally { btn.disabled=false; textSpan.classList.remove('hidden'); spinSpan.classList.add('hidden'); }
    });

    // ===== Clientes =====
    document.getElementById('form-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        const nome = document.getElementById('cliente-nome').value;
        const telefone = document.getElementById('cliente-telefone').value;
        const endereco = document.getElementById('cliente-endereco').value;
        await addDoc(collection(db, `users/${userId}/clientes`), { nome, telefone, endereco });
        e.target.reset();
      } catch(e) { console.error(e); alert('Erro ao salvar cliente.'); }
      finally { btn.disabled=false; btn.textContent='Salvar Cliente'; }
    });

    function renderClientesList() {
      const listEl = document.getElementById('clientes-list');
      if (!appState.clientes.length) {
        listEl.innerHTML = '<p class="text-gray-500">Nenhum cliente cadastrado.</p>';
        return;
      }
      listEl.innerHTML = appState.clientes.map(c => `
        <div class="flex justify-between items-start bg-gray-50 border rounded-md p-3 text-sm">
          <div class="flex-1 min-w-0 cursor-pointer" onclick="openEditClienteModal('${c.id || ''}')">
            <div class="font-semibold text-gray-800 truncate">${c.nome}</div>
            <div class="text-gray-600 text-xs break-words">${c.telefone}</div>
            <div class="text-gray-500 text-[10px] leading-tight break-words">${c.endereco}</div>
          </div>
          <button class="text-red-600 hover:text-red-800 text-lg leading-none pl-3" onclick="deleteCliente('${c.id || ''}')">&times;</button>
        </div>
      `).join('');
    }

    function populateClientesDropdown() {
      const select = document.getElementById('orc-cliente');
      select.innerHTML = '<option value="">Selecione um cliente</option>';
      appState.clientes.forEach(c => {
        select.innerHTML += `<option value="${c.id}">${c.nome} - ${c.telefone}</option>`;
      });
      if (appState.currentOrcamento?.cliente?.id) {
        select.value = appState.currentOrcamento.cliente.id;
      }
    }

    window.deleteCliente = async (id) => {
      if (!confirm('Excluir este cliente?')) return;
      if (!userId) return alert('Faça login novamente.');
      try {
        await deleteDoc(doc(db, `users/${userId}/clientes/${id}`));
      } catch(err) {
        console.error(err);
        alert('Erro ao excluir cliente.');
      }
    };

    window.openEditClienteModal = (id) => {
      try {
        const cliente = appState.clientes.find(c => c.id === id);
        if (!cliente) return alert('Cliente não encontrado.');
        document.getElementById('edit-cliente-id').value = cliente.id || '';
        document.getElementById('edit-cliente-nome').value = cliente.nome || '';
        document.getElementById('edit-cliente-telefone').value = cliente.telefone || '';
        document.getElementById('edit-cliente-endereco').value = cliente.endereco || '';
        document.getElementById('edit-cliente-modal').classList.add('active');
      } catch (err) {
        console.error('[openEditClienteModal] Erro:', err);
        alert('Erro ao abrir modal de edição de cliente.');
      }
    };

    function closeEditClienteModal() {
      document.getElementById('edit-cliente-modal').classList.remove('active');
    }

    document.getElementById('form-edit-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('edit-cliente-id').value;
      const nome = document.getElementById('edit-cliente-nome').value;
      const telefone = document.getElementById('edit-cliente-telefone').value;
      const endereco = document.getElementById('edit-cliente-endereco').value;

      if (!id) return alert('Cliente inválido.');
      if (!userId) return alert('Faça login novamente.');

      try {
        await updateDoc(doc(db, `users/${userId}/clientes/${id}`), { nome, telefone, endereco });
        closeEditClienteModal();
      } catch (err) {
        console.error('[form-edit-cliente submit] Erro:', err);
        alert('Erro ao salvar alterações do cliente.');
      }
    });

    // ===== Materiais =====
    document.getElementById('form-material').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        const nome = document.getElementById('material-nome').value;
        const unidade = document.getElementById('material-unidade').value;
        const v = parseFloat(document.getElementById('material-valor').value) || 0;
        if (!nome || v<=0) throw new Error('Nome e valor devem ser preenchidos.');
        await addDoc(collection(db, `users/${userId}/materiais`), { nome, unidade, valor:v });
        e.target.reset();
      } catch(e) { console.error(e); alert('Erro ao salvar material.'); }
      finally { btn.disabled=false; btn.textContent='Salvar Item'; }
    });

    function renderMateriaisList() {
      const listEl = document.getElementById('materiais-list');
      const selectEl = document.getElementById('orc-item');
      listEl.innerHTML = '';
      selectEl.innerHTML = '<option value="">Selecionar material</option>';
      if (!appState.materiais.length) {
        listEl.innerHTML = '<p class="text-gray-500">Nenhum material cadastrado.</p>';
        return;
      }
      appState.materiais.forEach(item => {
        listEl.innerHTML += `
          <div class="flex justify-between items-start bg-gray-50 border rounded-md p-3 text-sm">
            <div class="flex-1 min-w-0 cursor-pointer" onclick="openEditMaterialModal('${item.id || ''}')">
              <div class="font-semibold text-gray-800 truncate">${item.nome}</div>
              <div class="text-gray-600 text-xs">${item.unidade || 'UN'} — R$ ${item.valor?.toFixed(2) || '0.00'}</div>
            </div>
            <button class="text-red-600 hover:text-red-800 text-lg leading-none pl-3" onclick="deleteMaterial('${item.id || ''}')">&times;</button>
          </div>
        `;
        selectEl.innerHTML += `<option value="${item.id}">${item.nome} - R$ ${item.valor?.toFixed(2) || '0.00'}</option>`;
      });
    }

    window.deleteMaterial = async (id) => {
      if (!confirm('Excluir este material?')) return;
      if (!userId) return alert('Faça login novamente.');
      try {
        await deleteDoc(doc(db, `users/${userId}/materiais/${id}`));
      } catch(e) { console.error(e); alert('Erro ao excluir item.'); }
    };

    window.openEditMaterialModal = (id) => {
      try {
        const mat = appState.materiais.find(m => m.id === id);
        if (!mat) return alert('Material não encontrado.');
        document.getElementById('edit-material-id').value = mat.id || '';
        document.getElementById('edit-material-nome').value = mat.nome || '';
        document.getElementById('edit-material-unidade').value = mat.unidade || '';
        document.getElementById('edit-material-valor').value = mat.valor || '';
        document.getElementById('edit-material-modal').classList.add('active');
      } catch (err) {
        console.error('[openEditMaterialModal] Erro:', err);
        alert('Erro ao abrir modal de edição de material.');
      }
    };

    function closeEditMaterialModal() {
      document.getElementById('edit-material-modal').classList.remove('active');
    }

    document.getElementById('form-edit-material').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('edit-material-id').value;
      const nome = document.getElementById('edit-material-nome').value;
      const unidade = document.getElementById('edit-material-unidade').value;
      const valor = parseFloat(document.getElementById('edit-material-valor').value) || 0;

      if (!id) return alert('Material inválido.');
      if (!userId) return alert('Faça login novamente.');

      try {
        await updateDoc(doc(db, `users/${userId}/materiais/${id}`), { nome, unidade, valor });
        closeEditMaterialModal();
      } catch (err) {
        console.error('[form-edit-material submit] Erro:', err);
        alert('Erro ao salvar alterações do material.');
      }
    });

    // Importar Materiais XLSX
    document.getElementById('btn-import-materiais-xlsx').addEventListener('click', async () => {
      if (!userId) return alert('Faça login novamente.');
      const fileInput = document.getElementById('materiais-xlsx-input');
      const statusEl = document.getElementById('materiais-xlsx-status');
      if (!fileInput.files[0]) {
        statusEl.textContent = 'Nenhum arquivo selecionado.';
        return;
      }
      statusEl.textContent = 'Lendo arquivo...';
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          const data = evt.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          const rows = json.slice(1);
          let count = 0;
          for (const row of rows) {
            const [descricao, unidade, valorStr] = row;
            if (!descricao) continue;
            const valor = parseFloat(valorStr) || 0;
            await addDoc(collection(db, `users/${userId}/materiais`), {
              nome: descricao,
              unidade: unidade || 'UNID',
              valor
            });
            count++;
          }
          statusEl.textContent = `${count} materiais importados com sucesso.`;
        } catch(e) {
          console.error(e);
          statusEl.textContent = 'Erro ao importar.';
        }
      };
      reader.readAsBinaryString(file);
    });

    document.getElementById('btn-clear-materiais').addEventListener('click', async () => {
      if (!confirm('Tem certeza que deseja apagar TODOS os materiais?')) return;
      if (!userId) return alert('Faça login novamente.');
      try {
        const snap = await getDocs(collection(db, `users/${userId}/materiais`));
        for (const docRef of snap.docs) {
          await deleteDoc(doc(db, `users/${userId}/materiais/${docRef.id}`));
        }
        alert('Todos os materiais foram apagados.');
      } catch(e) {
        console.error(e);
        alert('Erro ao limpar materiais.');
      }
    });

    // ===== Tipos de Serviço =====
    const catSelect = document.getElementById('tiposervico-categoria-select');
    const catNew = document.getElementById('tiposervico-categoria-new');

    catSelect.addEventListener('change', () => {
      if (catSelect.value === 'new_category') {
        catNew.classList.remove('hidden');
        catNew.focus();
      } else {
        catNew.classList.add('hidden');
      }
    });

    document.getElementById('form-tiposervico').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Faça login novamente.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        let categoria = (catSelect.value === 'new_category') ? (catNew.value||'').trim() : (catSelect.value||'').trim();
        categoria = categoria ? categoria.toUpperCase() : 'OUTROS';
        const descricao = document.getElementById('tiposervico-descricao').value;
        const valor = parseFloat(document.getElementById('tiposervico-valor').value);
        if (!categoria || !descricao || isNaN(valor)) throw new Error('Preencha categoria, descrição e valor.');
        if (valor <= 0) throw new Error('O valor deve ser maior que zero.');
        
        await addDoc(collection(db, `users/${userId}/tiposdeservico`), { descricao, valor, categoria });
        e.target.reset();
        catSelect.value = '';
        catNew.value = '';
        catNew.classList.add('hidden');
      } catch(e) {
        console.error(e);
        alert(e.message || 'Erro ao salvar serviço.');
      }
      finally { btn.disabled=false; btn.textContent='Salvar'; }
    });

    function renderTiposDeServicoList() {
      const listWrapper = document.getElementById('tiposdeservico-list');
      const orcServicoSelect = document.getElementById('orc-servico');
      if (!appState.tiposDeServico.length) {
        listWrapper.innerHTML = '<p class="text-gray-500">Nenhum tipo de serviço cadastrado.</p>';
        orcServicoSelect.innerHTML = '<option value="">Selecionar serviço</option>';
        return;
      }

      const byCat = {};
      appState.tiposDeServico.forEach(s => {
        const cat = s.categoria || 'OUTROS';
        if (!byCat[cat]) byCat[cat] = [];
        byCat[cat].push(s);
      });

      let html = '';
      let selectHTML = '<option value="">Selecionar serviço</option>';

      Object.keys(byCat).sort().forEach(cat => {
        const servicos = byCat[cat];
        html += `
          <details class="border rounded-md p-3 bg-gray-50">
            <summary class="flex items-center justify-between cursor-pointer">
              <span class="font-semibold text-gray-800 text-sm">${cat}</span>
              <span class="arrow text-gray-500 text-xs">&#9660;</span>
            </summary>
            <div class="mt-2 space-y-2">
              ${servicos.map(s => `
                <div class="flex justify-between items-start bg-white border rounded-md p-2 text-[0.8rem] leading-tight servico-slim">
                  <div class="flex-1 min-w-0 cursor-pointer" onclick="openEditTipoServicoModal('${s.id || ''}')">
                    <div class="font-semibold text-gray-800 truncate">${s.descricao}</div>
                    <div class="text-gray-600 text-[0.7rem]">R$ ${s.valor?.toFixed(2) || '0.00'}</div>
                  </div>
                  <button class="text-red-600 hover:text-red-800 text-lg leading-none pl-3" onclick="deleteTipoDeServico('${s.id || ''}')">&times;</button>
                </div>
              `).join('')}
            </div>
          </details>`;
        servicos.forEach(s => {
          selectHTML += `<option value="${s.id}">${cat} - ${s.descricao} (R$ ${s.valor?.toFixed(2) || '0.00'})</option>`;
        });
      });

      listWrapper.innerHTML = html;
      orcServicoSelect.innerHTML = selectHTML;
    }

    window.deleteTipoDeServico = async (id) => {
      if (confirm('Excluir este tipo de serviço?')) { await deleteDoc(doc(db, `users/${userId}/tiposdeservico/${id}`)); }
    };

    window.openEditTipoServicoModal = (id) => {
      try {
        const servico = appState.tiposDeServico.find(s => s.id === id);
        if (!servico) return alert('Serviço não encontrado.');
        document.getElementById('edit-tiposervico-id').value = servico.id || '';
        document.getElementById('edit-tiposervico-categoria').value = servico.categoria || '';
        document.getElementById('edit-tiposervico-descricao').value = servico.descricao || '';
        document.getElementById('edit-tiposervico-valor').value = servico.valor || '';
        document.getElementById('edit-tiposervico-modal').classList.add('active');
      } catch (err) {
        console.error('[openEditTipoServicoModal] Erro:', err);
        alert('Erro ao abrir modal de edição de serviço.');
      }
    };

    function closeEditTipoServicoModal() {
      document.getElementById('edit-tiposervico-modal').classList.remove('active');
    }

    document.getElementById('form-edit-tiposervico').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('edit-tiposervico-id').value;
      const categoria = document.getElementById('edit-tiposervico-categoria').value;
      const descricao = document.getElementById('edit-tiposervico-descricao').value;
      const valor = parseFloat(document.getElementById('edit-tiposervico-valor').value) || 0;
      if (!id) return alert('Serviço inválido.');
      if (!userId) return alert('Faça login novamente.');
      try {
        await updateDoc(doc(db, `users/${userId}/tiposdeservico/${id}`), { categoria, descricao, valor });
        closeEditTipoServicoModal();
      } catch (err) {
        console.error('[form-edit-tiposervico submit] Erro:', err);
        alert('Erro ao salvar alterações do serviço.');
      }
    });

    // Importar Serviços XLSX
    document.getElementById('btn-import-xlsx').addEventListener('click', async () => {
      if (!userId) return alert('Faça login novamente.');
      const fileInput = document.getElementById('xlsx-input');
      const statusEl = document.getElementById('xlsx-status');
      if (!fileInput.files[0]) {
        statusEl.textContent = 'Nenhum arquivo selecionado.';
        return;
      }
      statusEl.textContent = 'Lendo arquivo...';
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          const data = evt.target.result;
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          const rows = json.slice(1);
          let count = 0;
          for (const row of rows) {
            const [categoriaBruta, descricao, valorStr] = row;
            if (!descricao) continue;
            let categoria = (categoriaBruta || 'OUTROS').toString().toUpperCase().trim();
            const valor = parseFloat(valorStr) || 0;
            await addDoc(collection(db, `users/${userId}/tiposdeservico`), {
              categoria,
              descricao,
              valor
            });
            count++;
          }
          statusEl.textContent = `${count} serviços importados com sucesso.`;
        } catch(e) {
          console.error(e);
          statusEl.textContent = 'Erro ao importar.';
        }
      };
      reader.readAsBinaryString(file);
    });

    document.getElementById('btn-clear-tiposervico').addEventListener('click', async () => {
      if (!confirm('Tem certeza que deseja apagar TODOS os serviços?')) return;
      if (!userId) return alert('Faça login novamente.');
      try {
        const snap = await getDocs(collection(db, `users/${userId}/tiposdeservico`));
        for (const docRef of snap.docs) {
          await deleteDoc(doc(db, `users/${userId}/tiposdeservico/${docRef.id}`));
        }
        alert('Todos os serviços foram apagados.');
      } catch(e) {
        console.error(e);
        alert('Erro ao limpar serviços.');
      }
    });

    // ===== ORÇAMENTOS =====

    function openOrcamentoModal(id = null) {
      resetCurrentOrcamento();
      if (id) {
        const orc = appState.orcamentos.find(o => o.id === id);
        if (orc) {
          appState.currentOrcamento = JSON.parse(JSON.stringify(orc));
        }
      }
      populateClientesDropdown();
      populateOrcamentoItemsLists();
      fillOrcamentoModalFields();
      updateMaoDeObraOptions();
      updateOrcamentoPreview();
      document.getElementById('orcamento-modal').classList.remove('hidden');
      document.getElementById('orcamento-modal').classList.add('flex');
    }

    function closeOrcamentoModal() {
      document.getElementById('orcamento-modal').classList.add('hidden');
      document.getElementById('orcamento-modal').classList.remove('flex');
    }

    function populateOrcamentoItemsLists() {
      const orcItensUl = document.getElementById('orc-itens-list');
      const orcServUl = document.getElementById('orc-servico-list');
      orcItensUl.innerHTML = '';
      orcServUl.innerHTML = '';

      if (appState.currentOrcamento.items.length === 0) {
        orcItensUl.innerHTML = '<li class="text-gray-400">Nenhum material adicionado.</li>';
      } else {
        appState.currentOrcamento.items.forEach((it, idx) => {
          orcItensUl.innerHTML += `
            <li class="flex justify-between text-xs bg-white border rounded p-2 leading-tight">
              <div class="flex-1 min-w-0">
                <div class="font-medium text-gray-800 break-words">${it.nome}</div>
                <div class="text-gray-600 text-[10px]">
                  ${it.quantidade || 1} ${it.unidade || 'UNID'} x R$ ${it.valor.toFixed(2)} = R$ ${(it.valor * (it.quantidade || 1)).toFixed(2)}
                </div>
              </div>
              <button class="text-red-600 hover:text-red-800 text-lg leading-none pl-3" onclick="removerItemOrcamento(${idx})">&times;</button>
            </li>`;
        });
      }

      if (appState.currentOrcamento.tiposDeServico.length === 0) {
        orcServUl.innerHTML = '<li class="text-gray-400">Nenhum serviço adicionado.</li>';
      } else {
        appState.currentOrcamento.tiposDeServico.forEach((sv, idx) => {
          orcServUl.innerHTML += `
            <li class="flex justify-between text-xs bg-white border rounded p-2 leading-tight">
              <div class="flex-1 min-w-0">
                <div class="font-medium text-gray-800 break-words">${sv.categoria} - ${sv.descricao}</div>
                <div class="text-gray-600 text-[10px]">R$ ${sv.valor.toFixed(2)}</div>
              </div>
              <button class="text-red-600 hover:text-red-800 text-lg leading-none pl-3" onclick="removerServicoOrcamento(${idx})">&times;</button>
            </li>`;
        });
      }
    }

    function fillOrcamentoModalFields() {
      const o = appState.currentOrcamento;
      if (!o) return;
      const clienteSelect = document.getElementById('orc-cliente');
      if (o.cliente?.id) clienteSelect.value = o.cliente.id;
      else clienteSelect.value='';
      document.getElementById('orc-observacoes').value = o.observacoes || '';
      document.getElementById('orc-whats-msg').value = o.whatsMsg || '';
      document.getElementById('orc-tipo-obra').value = o.tipoObra || 'residencial';
      const maoSelect = document.getElementById('mao-obra-tipo');
      const maoValorInput = document.getElementById('mao-obra-valor');
      maoSelect.value = o.maoDeObra.tipo || '';
      maoValorInput.value = o.maoDeObra.raw_value || o.maoDeObra.valor || '';
      document.getElementById('orcamento-numero-label').textContent = o.numeroOrcamento ? `Orçamento #${o.numeroOrcamento}` : '(Novo)';
      document.getElementById('orcamento-versao-label').textContent = o.versao ? `Versão ${o.versao}` : '';
      if (o.createdAt) {
        const createdDate = o.createdAt.toDate ? o.createdAt.toDate() : o.createdAt;
        document.getElementById('orcamento-createdAt-label').textContent = 'Criado em: ' + (createdDate ? new Date(createdDate).toLocaleString() : '');
      } else {
        document.getElementById('orcamento-createdAt-label').textContent = '';
      }
      document.getElementById('orcamento-debug-label').textContent = `ID interno: ${o.id || '(ainda não salvo)'}`;
    }

    document.getElementById('orc-cliente').addEventListener('change', () => {
      const id = document.getElementById('orc-cliente').value;
      const cliente = appState.clientes.find(c => c.id === id);
      if (cliente) {
        appState.currentOrcamento.cliente = { ...cliente };
      } else {
        appState.currentOrcamento.cliente = null;
      }
      updateOrcamentoPreview();
    });

    // ADD SERVIÇO
    window.adicionarTipoDeServicoAoOrcamento = () => {
      const sel = document.getElementById('orc-servico').value;
      const entry = appState.tiposDeServico.find(s => s.id === sel);
      if (!entry) return;
      appState.currentOrcamento.tiposDeServico.push({ ...entry });
      populateOrcamentoItemsLists();
      updateOrcamentoPreview();
    };

    // REMOVE SERVIÇO
    window.removerServicoOrcamento = (idx) => {
      appState.currentOrcamento.tiposDeServico.splice(idx,1);
      populateOrcamentoItemsLists();
      updateOrcamentoPreview();
    };

    // ADD ITEM
    window.adicionarItemAoOrcamento = () => {
      const sel = document.getElementById('orc-item').value;
      if (!sel) return;
      const entry = appState.materiais.find(m => m.id === sel);
      if (!entry) return;
      const qtd = parseFloat(document.getElementById('orc-item-qtd').value) || 1;
      appState.currentOrcamento.items.push({
        nome: entry.nome,
        unidade: entry.unidade,
        valor: entry.valor,
        quantidade: qtd
      });
      populateOrcamentoItemsLists();
      updateOrcamentoPreview();
    };

    // REMOVE ITEM
    window.removerItemOrcamento = (idx) => {
      appState.currentOrcamento.items.splice(idx,1);
      populateOrcamentoItemsLists();
      updateOrcamentoPreview();
    };

    // MÃO DE OBRA
    function updateMaoDeObraOptions() {
      const tipoObra = document.getElementById('orc-tipo-obra').value;
      const maoSelect = document.getElementById('mao-obra-tipo');
      const maoValorInput = document.getElementById('mao-obra-valor');

      const optionsMap = {
        residencial: {
          empreitada: appState.config.residencial_empreitada || 0,
          diaria: appState.config.residencial_diaria || 0,
          ponto: appState.config.residencial_ponto || 0,
          hora: appState.config.residencial_hora || 0
        },
        industrial: {
          empreitada: 0,
          diaria: appState.config.industrial_diaria || 0,
          ponto: appState.config.industrial_ponto || 0,
          hora: appState.config.industrial_hora || 0
        }
      };

      const tipoAtual = maoSelect.value;
      if (tipoAtual && optionsMap[tipoObra][tipoAtual] !== undefined) {
        maoValorInput.value = optionsMap[tipoObra][tipoAtual] || '';
      }
      appState.currentOrcamento.tipoObra = tipoObra;
      updateMaoDeObraValor();
      updateOrcamentoPreview();
    }

    document.getElementById('orc-tipo-obra').addEventListener('change', () => {
      updateMaoDeObraOptions();
    });

    document.getElementById('mao-obra-tipo').addEventListener('change', () => {
      updateMaoDeObraValor();
      updateOrcamentoPreview();
    });

    document.getElementById('mao-obra-valor').addEventListener('input', () => {
      setMaoDeObraManual();
      updateOrcamentoPreview();
    });

    function updateMaoDeObraValor() {
      const maoSelect = document.getElementById('mao-obra-tipo');
      const maoValorInput = document.getElementById('mao-obra-valor');
      const tipo = maoSelect.value;
      const tipoObra = appState.currentOrcamento.tipoObra || 'residencial';
      let valor = 0;
      let label = '';
      let raw_value = '';

      const rates = {
        empreitada: appState.config.residencial_empreitada || 0,
        diaria: (tipoObra === 'industrial' ? appState.config.industrial_diaria : appState.config.residencial_diaria) || 0,
        ponto: (tipoObra === 'industrial' ? appState.config.industrial_ponto : appState.config.residencial_ponto) || 0,
        hora: (tipoObra === 'industrial' ? appState.config.industrial_hora : appState.config.residencial_hora) || 0,
      };
      
      switch(tipo) {
        case 'empreitada':
          if (tipoObra === 'residencial' && rates.empreitada > 0) {
              valor = rates.empreitada;
              label = 'Empreitada (Valor Fixo da Configuração)';
              raw_value = rates.empreitada;
          } else {
              raw_value = parseFloat(document.getElementById('empreitada-valor').value) || 0;
              valor = raw_value; 
              label = 'Empreitada (Valor Manual)';
          }
          break;
        case 'diaria':
          if (rates.diaria > 0) {
              valor = rates.diaria;
              label = 'Diária (Valor Fixo da Configuração)';
              raw_value = rates.diaria;
          } else {
              raw_value = parseFloat(maoValorInput.value) || 0;
              valor = raw_value;
              label = 'Diária (Valor Manual)';
          }
          break;
        case 'ponto':
          if (rates.ponto > 0) {
              valor = rates.ponto;
              label = (tipoObra === 'industrial') ? 'Por Equipamento (Valor Configurado)' : 'Por Ponto (Valor Configurado)';
              raw_value = rates.ponto;
          } else {
              raw_value = parseFloat(maoValorInput.value) || 0;
              valor = raw_value;
              label = (tipoObra === 'industrial') ? 'Por Equipamento (Valor Manual)' : 'Por Ponto (Valor Manual)';
          }
          break;
        case 'hora':
          if (rates.hora > 0) {
              valor = rates.hora;
              label = 'Por Hora (Valor Configurado)';
              raw_value = rates.hora;
          } else {
              raw_value = parseFloat(maoValorInput.value) || 0;
              valor = raw_value;
              label = 'Por Hora (Valor Manual)';
          }
          break;
        default:
          raw_value = parseFloat(maoValorInput.value) || 0;
          valor = raw_value;
          label = '';
      }

      maoValorInput.value = raw_value || '';

      if (!appState.currentOrcamento.maoDeObra) {
        appState.currentOrcamento.maoDeObra = { tipo: '', valor: 0, label: '', raw_value: '' };
      }

      appState.currentOrcamento.maoDeObra.tipo = tipo;
      appState.currentOrcamento.maoDeObra.valor = valor;
      appState.currentOrcamento.maoDeObra.label = label;
      appState.currentOrcamento.maoDeObra.raw_value = raw_value;
    }

    function setMaoDeObraManual() {
      const maoSelect = document.getElementById('mao-obra-tipo');
      const maoValorInput = document.getElementById('mao-obra-valor');
      const tipo = maoSelect.value;
      if (!tipo) return;
      const entered = parseFloat(maoValorInput.value) || 0;
      let labelTxt = '';
      switch(tipo) {
        case 'empreitada': labelTxt='Empreitada (Valor Manual)'; break;
        case 'diaria': labelTxt='Diária (Valor Manual)'; break;
        case 'ponto': labelTxt='Por Ponto / Equipamento (Valor Manual)'; break;
        case 'hora': labelTxt='Por Hora (Valor Manual)'; break;
        default: labelTxt='';
      }
      appState.currentOrcamento.maoDeObra = {
        tipo,
        valor: entered,
        label: labelTxt,
        raw_value: entered
      };
    }

    function updateOrcamentoPreview() {
      const { config, currentOrcamento } = appState;
      const previewEl = document.getElementById('pdf-preview');
      if (!currentOrcamento || !currentOrcamento.cliente) {
        previewEl.innerHTML = '<p class="text-gray-500 text-center mt-8">Selecione um cliente para começar.</p>';
        return;
      }
      const fullClient = currentOrcamento.cliente;

      let tiposDeServicoHtml = '';
      if (currentOrcamento.tiposDeServico && currentOrcamento.tiposDeServico.length > 0) {
        const servicosContent = currentOrcamento.tiposDeServico.map(s => `<tr><td style="padding: 4px 2px; text-align: left;">${s.categoria} - ${s.descricao}</td><td style="padding: 4px 2px; text-align: right;">R$ ${s.valor.toFixed(2)}</td></tr>`).join('');
        tiposDeServicoHtml = `
        <h4 style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">TIPOS DE SERVIÇO:</h4>
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em; margin-bottom: 10px;">
          <thead><tr><th style="text-align: left; padding: 4px 2px; border-bottom: 1px solid #ccc;">Descrição</th><th style="text-align: right; padding: 4px 2px; border-bottom: 1px solid #ccc;">Valor</th></tr></thead>
          <tbody>${servicosContent}</tbody>
        </table>`;
      }

      let subtotalServicos = 0;
      if (currentOrcamento.tiposDeServico && currentOrcamento.tiposDeServico.length > 0) {
        subtotalServicos = currentOrcamento.tiposDeServico.reduce((sum, s) => sum + (s.valor || 0), 0);
      }
      let subtotalMateriais = 0;
      if (currentOrcamento.items && currentOrcamento.items.length > 0) {
        subtotalMateriais = currentOrcamento.items.reduce((sum, it) => {
          const qtd = it.quantidade || 1;
          return sum + (it.valor * qtd);
        }, 0);
      }

      // PAGAMENTOS
      let pagamentoHtml = `
        <div style="font-size: 0.9em; margin-top: 20px;">
          <h4 style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">FORMAS DE PAGAMENTO</h4>
          <div style="margin-bottom: 5px;"><strong>PIX:</strong> ${config.config_pix_chave || ''}</div>
          <div style="margin-bottom: 5px;"><strong>Cartão:</strong> até ${config.config_cartao_vezes || ''}x (${config.config_cartao_juros || ''}% a.m.)</div>
          <div style="margin-bottom: 5px;"><strong>Dinheiro:</strong> ${config.config_pagamento_dinheiro ? 'Aceito' : 'Não informado'}</div>
          <div style="margin-bottom: 5px;"><strong>Depósito:</strong> ${config.config_deposito_banco || ''} / Ag: ${config.config_deposito_ag || ''} / Cc: ${config.config_deposito_conta || ''}</div>
        </div>
      `;

      const itemsHtml = currentOrcamento.items.map(item => {
        const itemTotal = item.valor * (item.quantidade || 1);
        return `<tr>
          <td style="padding: 4px 2px; text-align: left;">${item.nome}</td>
          <td style="padding: 4px 2px; text-align: center;">${item.quantidade || 1} ${item.unidade || 'UNID'}</td>
          <td style="padding: 4px 2px; text-align: right;">R$ ${item.valor.toFixed(2)}</td>
          <td style="padding: 4px 2px; text-align: right;">R$ ${itemTotal.toFixed(2)}</td>
        </tr>`;
      }).join('');
      const totalMaoDeObra = currentOrcamento.maoDeObra.valor || 0;
      currentOrcamento.total = subtotalServicos + subtotalMateriais + totalMaoDeObra;
      const maoDeObraLabel = currentOrcamento.maoDeObra.label || 'Não definida';
      previewEl.innerHTML = `
        <div style="padding: 10px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding: 0 10px;">
            <div style="text-align: left; max-width: 70%;">
              <strong style="font-size: 1.2em; display: block;">${config.nome || 'Nome do Profissional'}</strong>
              <span style="display: block; font-size: 0.9em;">${config.endereco || ''}</span>
              <span style="display: block; font-size: 0.9em;">Telefone: ${config.telefone || ''} | Doc: ${config.doc || ''}</span>
            </div>
            ${config.logo ? `<div style="text-align: right; flex-shrink: 0;"><img src="${config.logo}" alt="Logomarca" style="max-width: 150px; max-height: 80px;"></div>` : ''}
          </div>
          <hr style="margin: 15px 0;">
          <h4 style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px;">Orçamento para:</h4>
          <strong style="display: block;">${fullClient.nome}</strong>
          <span style="display: block;">${fullClient.endereco}</span>
          <span style="display: block;">Telefone: ${fullClient.telefone}</span>
          <hr style="margin: 15px 0;">
          ${tiposDeServicoHtml}
          <h4 style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px;">DESCRIÇÃO DOS MATERIAIS:</h4>
          <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
            ${currentOrcamento.items.length > 0 ? `<thead><tr><th style="text-align: left; padding: 4px 2px; border-bottom: 1px solid #ccc;">Item</th><th style="text-align: center; padding: 4px 2px; border-bottom: 1px solid #ccc;">Qtd</th><th style="text-align: right; padding: 4px 2px; border-bottom: 1px solid #ccc;">Unitário</th><th style="text-align: right; padding: 4px 2px; border-bottom: 1px solid #ccc;">Total</th></tr></thead><tbody>${itemsHtml}</tbody>` : '<tbody><tr><td colspan="4" style="text-align: center; color: #888;">Nenhum material adicionado.</td></tr></tbody>'}
          </table>
          ${currentOrcamento.items.length > 0 ? `<div style="text-align: right; font-size: 0.9em; margin-top: 5px;"><span>Subtotal Materiais: R$ ${subtotalMateriais.toFixed(2)}</span></div>` : ''}
          <h4 style="font-size: 1.1em; font-weight: bold; margin-top: 15px; margin-bottom: 5px;">MÃO DE OBRA:</h4>
          <div style="text-align: right;"><span>${maoDeObraLabel}: R$ ${totalMaoDeObra.toFixed(2)}</span></div>
          <div style="text-align: right; font-size: 1.2em; font-weight: bold; margin-top: 10px;">
            <span>TOTAL: R$ ${currentOrcamento.total.toFixed(2)}</span>
          </div>
          
          ${pagamentoHtml}
          <div style="font-size: 0.8em; margin-top: 20px; color: #555;">
            <div style="text-align: center; color: #888;">Orçamento válido por 15 dias.</div>
          </div>
        </div>`;
    }

    window.saveOrcamento = async () => {
      if (!appState.currentOrcamento?.cliente) return alert('Selecione um cliente.');
      const data = { ...appState.currentOrcamento };
      try {
        if (data.id) {
          data.versao = (data.versao || 1) + 1;
          const ref = doc(db, `users/${userId}/orcamentos/${data.id}`);
          delete data.createdAt;
          await setDoc(ref, data, { merge: true });
          alert('Orçamento atualizado!');
        } else {
          const maxNumero = appState.orcamentos.reduce((max, o) => Math.max(max, o.numeroOrcamento || 0), 0);
          data.numeroOrcamento = maxNumero + 1;
          data.versao = 1;
          data.createdAt = serverTimestamp();
          const ref = await addDoc(collection(db, `users/${userId}/orcamentos`), data);
          appState.currentOrcamento.id = ref.id;
          appState.currentOrcamento.numeroOrcamento = data.numeroOrcamento;
          alert('Orçamento salvo! Você já pode gerar o PDF.');
        }
        closeOrcamentoModal();
      } catch(e) {
        console.error(e); alert('Erro ao salvar.');
      }
    };

    window.shareOrViewPDF = async () => {
      if (!appState.currentOrcamento?.cliente) return alert('Selecione um cliente para gerar o PDF.');
      // Atualiza a visualização antes de capturar o PDF (garante logo e dados mais recentes)
      updateOrcamentoPreview();
      const hidden = document.createElement('div');
      hidden.style.position = 'absolute'; hidden.style.left = '-9999px'; hidden.style.top = '-9999px';
      hidden.style.width = '210mm';
      hidden.innerHTML = document.getElementById('pdf-preview').innerHTML;
      document.body.appendChild(hidden);
      const { jsPDF } = window.jspdf;
      const clienteNome = appState.currentOrcamento?.cliente?.nome?.replace(/\s+/g, '-') || 'cliente';
      const fileName = `orcamento-${clienteNome}.pdf`;
      try {
        const canvas = await html2canvas(hidden, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        if (navigator.share && navigator.canShare) {
          const blob = pdf.output('blob');
          const file = new File([blob], fileName, { type: 'application/pdf' });
          if (navigator.canShare({ files: [file] })) {
            await navigator.share({ title: `Orçamento - ${clienteNome}`, text: 'Segue o orçamento em anexo.', files: [file] });
            document.body.removeChild(hidden);
            return;
          }
        }
        pdf.save(fileName);
      } catch(e) {
        console.error(e);
        if (e.name !== 'AbortError') alert('Erro ao gerar o PDF.');
      } finally {
        document.body.removeChild(hidden);
      }
    };

    window.sendWhatsAppText = () => {
      if (!appState.currentOrcamento?.cliente) return alert('Selecione um cliente primeiro.');
      const fullClient = appState.currentOrcamento.cliente;
      if (!fullClient) return alert('Cliente não encontrado.');
      const telefone = fullClient.telefone.replace(/\D/g, '');
      const obs = document.getElementById('orc-whats-msg').value || '';
      const textoBase = `
Olá ${fullClient.nome}, segue o orçamento:

Total: R$ ${appState.currentOrcamento.total?.toFixed(2) || '0,00'}

Formas de pagamento:
- PIX: ${appState.config.config_pix_chave || ''}
- Cartão: até ${appState.config.config_cartao_vezes || ''}x (${appState.config.config_cartao_juros || ''}% a.m.)
- Depósito: ${appState.config.config_deposito_banco || ''}, Ag ${appState.config.config_deposito_ag || ''}, Cc ${appState.config.config_deposito_conta || ''}

${obs}
`.trim();
      const encoded = encodeURIComponent(textoBase);
      window.open(`https://wa.me/55${telefone}?text=${encoded}`, '_blank');
    };

    // ===== LISTAGEM DE ORÇAMENTOS (TELA INICIAL E TELA "TODOS") =====
    function renderOrcamentosList(onlyRecent=false) {
      const containerRecent = document.getElementById('orcamentos-list-recent');
      const tabelaList = document.getElementById('tabela-orcamentos-list');
      if (!appState.orcamentos.length) {
        if (onlyRecent && tabelaList) tabelaList.innerHTML = '';
        if (!onlyRecent && containerRecent) {
          containerRecent.innerHTML = '<p class="text-gray-500 text-sm">Nenhum orçamento salvo ainda.</p>';
        }
        return;
      }

      const sorted = [...appState.orcamentos].sort((a,b) => (b.numeroOrcamento||0)-(a.numeroOrcamento||0));
      const recent3 = sorted.slice(0,3);

      if (!onlyRecent && containerRecent) {
        containerRecent.innerHTML = recent3.map(o => {
          const dataCriacao = o.createdAt
            ? (o.createdAt.toDate ? o.createdAt.toDate() : o.createdAt)
            : null;
          const dataTexto = dataCriacao ? new Date(dataCriacao).toLocaleString() : '';
          return `
            <div class="bg-white border rounded-lg p-4 flex flex-col sm:flex-row sm:justify-between sm:items-start text-sm">
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-800 mb-1">#${o.numeroOrcamento || '?'} - ${o.cliente?.nome || 'Cliente'}</div>
                <div class="text-gray-600 text-xs leading-tight">${o.cliente?.endereco || ''}</div>
                <div class="text-gray-500 text-[10px] leading-tight">${o.cliente?.telefone || ''}</div>
                <div class="text-gray-400 text-[10px] leading-tight">Criado: ${dataTexto}</div>
              </div>
              <div class="flex gap-2 mt-3 sm:mt-0">
                <button class="bg-blue-600 text-white px-2 py-1 rounded text-[10px] hover:bg-blue-700 transition" onclick="openOrcamentoModal('${o.id || ''}')">Abrir</button>
              </div>
            </div>`;
        }).join('');
      }

      if (onlyRecent && tabelaList) {
        tabelaList.innerHTML = sorted.map(o => {
          const checked = appState.orcamentosParaExcluir.has(o.id) ? 'checked' : '';
          const dataCriacao = o.createdAt
            ? (o.createdAt.toDate ? o.createdAt.toDate() : o.createdAt)
            : null;
          const dataTexto = dataCriacao ? new Date(dataCriacao).toLocaleString() : '';
          return `
            <tr class="border-b text-xs">
              <td class="py-2 px-2 font-semibold text-gray-800 whitespace-nowrap">#${o.numeroOrcamento || '?'}</td>
              <td class="py-2 px-2">${o.cliente?.nome || ''}</td>
              <td class="py-2 px-2 hidden sm:table-cell text-gray-500">${o.cliente?.endereco || ''}</td>
              <td class="py-2 px-2 font-semibold text-right text-gray-800">R$ ${o.total?.toFixed(2) || '0,00'}</td>
              <td class="py-2 px-2 hidden sm:table-cell text-gray-500">${dataTexto}</td>
              <td class="py-2 px-2 text-center">
                <input type="checkbox" class="h-4 w-4 text-red-600 border-gray-300 rounded" data-id="${o.id || ''}" onchange="toggleSelectOrcamentoParaExcluir('${o.id || ''}', this.checked)" ${checked}>
              </td>
            </tr>`;
        }).join('');
      }

      atualizarBotaoExcluirSelecionados();
    }

    function showAllOrcamentosPage() {
      mainView.classList.add('hidden');
      allOrcamentosView.classList.remove('hidden');
      renderOrcamentosList(true);
    }

    function closeAllOrcamentosPage() {
      allOrcamentosView.classList.add('hidden');
      mainView.classList.remove('hidden');
      renderOrcamentosList();
    }

    function toggleSelectOrcamentoParaExcluir(id, marcado) {
      if (marcado) {
        appState.orcamentosParaExcluir.add(id);
      } else {
        appState.orcamentosParaExcluir.delete(id);
      }
      atualizarBotaoExcluirSelecionados();
    }

    function atualizarBotaoExcluirSelecionados() {
      const btn = document.getElementById('btn-excluir-selecionados');
      const txt = document.getElementById('btn-excluir-selecionados-texto');
      const count = appState.orcamentosParaExcluir.size;
      btn.disabled = count === 0;
      txt.textContent = count === 0
        ? 'Excluir Selecionados'
        : (count === 1
          ? 'Excluir 1 Orçamento Selecionado'
          : `Excluir ${count} Orçamentos Selecionados`);
    }

    document.getElementById('btn-excluir-selecionados').addEventListener('click', async () => {
      const count = appState.orcamentosParaExcluir.size;
      if (count === 0) return;
      const confirmMsg = count === 1
        ? 'Tem certeza que deseja excluir este orçamento?'
        : `Tem certeza que deseja excluir estes ${count} orçamentos?`;
      if (!confirm(confirmMsg)) return;
      if (!userId) return alert('Faça login novamente.');
      const btn = document.getElementById('btn-excluir-selecionados');
      const spin = document.getElementById('btn-excluir-spinner');
      const txt = document.getElementById('btn-excluir-selecionados-texto');
      btn.disabled = true;
      spin.classList.remove('hidden');
      txt.classList.add('opacity-50');
      try {
        for (const id of appState.orcamentosParaExcluir) {
          await deleteDoc(doc(db, `users/${userId}/orcamentos/${id}`));
        }
        appState.orcamentosParaExcluir.clear();
        renderOrcamentosList(true);
      } catch (err) {
        console.error(err);
        alert('Erro ao excluir orçamentos.');
      } finally {
        spin.classList.add('hidden');
        txt.classList.remove('opacity-50');
        atualizarBotaoExcluirSelecionados();
      }
    });

    // ===== CARREGAR DADOS =====
    function loadAllData() {
      if (!userId) return;
      const prefix = `users/${userId}`;

      onSnapshot(doc(db, `${prefix}/config/main`), (snap) => {
        if (snap.exists()) appState.config = snap.data();
        updateConfigForm();
      });

      onSnapshot(query(collection(db, `${prefix}/clientes`)), (snapshot) => {
        appState.clientes = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
        renderClientesList();
        renderOrcamentosList();
        renderOrcamentosList(true);
      });

      onSnapshot(query(collection(db, `${prefix}/materiais`)), (snapshot) => {
        appState.materiais = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
        renderMateriaisList();
      });

      onSnapshot(query(collection(db, `${prefix}/tiposdeservico`)), (snapshot) => {
        appState.tiposDeServico = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
        renderTiposDeServicoList();
      });

      onSnapshot(query(collection(db, `${prefix}/orcamentos`)), (snapshot) => {
        console.log(`[DEBUG] Recebeu ${snapshot.docs.length} orçamentos do Firebase.`);
        appState.orcamentos = snapshot.docs.map(d => {
          const data = d.data();
          if (data.createdAt?.toDate) data.createdAt = data.createdAt.toDate();
          console.log(`[DEBUG] Mapeando doc. ID do Firebase (d.id):`, d.id);
          return { ...data, id: d.id };
        });
        appState.orcamentos.sort((a,b) => (b.numeroOrcamento||0) - (a.numeroOrcamento||0));
        
        renderOrcamentosList();
        renderOrcamentosList(true); 
      });
    }

    // ===== BOTÕES LOGIN / LOGOUT =====
    loginButton.addEventListener('click', async () => {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch(e) {
        console.error(e);
        alert('Erro ao fazer login.');
      }
    });

    logoutButton.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch(e) {
        console.error(e);
        alert('Erro ao sair.');
      }
    });

    // ===== TROCAR ABAS =====
    function changeTab(evt, tabId) {
      document.querySelectorAll('.tab, .mobile-tab').forEach(btn => {
        if (btn.getAttribute('data-tab') === tabId) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      document.querySelectorAll('.tab-content').forEach(tc => {
        if (tc.id === tabId) {
          tc.classList.add('active');
        } else {
          tc.classList.remove('active');
        }
      });
    }

    // start
    initializeFirebase();

  </script>
</body>
</html>
