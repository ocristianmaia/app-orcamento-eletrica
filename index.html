<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerador de Or√ßamentos 5.0 ‚Äî Categorias & Submenus</title>
  <link rel="icon" href="icons/icon-32x32.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>

    @media (max-width: 640px) {
  .orcamento-nome {
    font-size: 0.95rem !important;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 180px;
  }
}
    
    body { font-family: 'Inter', sans-serif; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab.active { border-bottom: 2px solid #2563EB; color: #2563EB; font-weight: 600; }
   .modal { 
      display:none; 
      position:fixed; 
      inset:0; 
      background: rgba(0,0,0,.5); 
      z-index: 9999;
      align-items:center; 
      justify-content:center; 
    }
    .modal.active { display:flex; }
    /* Slim look for servi√ßos */
    .servico-slim { font-size: 0.80rem; line-height: 1.1rem; font-weight: 300; }
    .servico-slim strong { font-weight: 500; }
    details > summary::-webkit-details-marker { display:none; }
    details .arrow { transition: transform .2s; }
    details[open] .arrow { transform: rotate(180deg); }
  </style>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-180x180.png">
  <meta name="theme-color" content="#0a2245">
</head>
<body class="bg-gray-100 text-gray-800">
  <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-blue-500"></div>
    <p class="mt-3 text-gray-600">Conectando...</p>
  </div>

  <div id="delete-confirm-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-sm shadow-xl text-center">
      <h3 class="text-xl font-bold text-red-600 mb-4">Confirma√ß√£o de Exclus√£o</h3>
      <p id="delete-confirm-message" class="text-gray-700 mb-6"></p>
      <div class="flex justify-end gap-3">
        <button onclick="closeDeleteConfirmModal(false)" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
        <button onclick="closeDeleteConfirmModal(true)" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">OK, Excluir</button>
      </div>
      </div>
  </div>
  
  <div id="edit-cliente-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Cliente</h3>
      <form id="form-edit-cliente" class="space-y-4">
        <input type="hidden" id="edit-cliente-id">
        <div>
          <label for="edit-cliente-numerocadastro" class="block text-sm font-medium text-gray-700">ID do Cliente (Ex: CL0011125)</label>
          <input type="text" id="edit-cliente-numerocadastro" class="w-full p-2 border rounded-md mt-1 bg-gray-100" placeholder="CL0011125">
        </div>
        <div>
          <label for="edit-cliente-telefone" class="block text-sm font-medium text-gray-700">Telefone</label>
          <input type="tel" id="edit-cliente-telefone" class="w-full p-2 border rounded-md mt-1" required>
        </div>
       <div class="grid grid-cols-3 gap-4">
          <div class="col-span-2">
            <label for="edit-cliente-cep" class="block text-sm font-medium text-gray-700">CEP</label>
            <input type="text" id="edit-cliente-cep" 
                   onchange="buscarCEP(this.value, { logradouro: 'edit-cliente-logradouro', bairro: 'edit-cliente-bairro', cidade: 'edit-cliente-cidade', uf: 'edit-cliente-uf', numero: 'edit-cliente-numero' })" 
                   placeholder="00000-000" class="w-full p-2 border rounded-md mt-1">
          </div>
          <div>
            <label for="edit-cliente-numero" class="block text-sm font-medium text-gray-700">N√∫mero</label>
            <input type="text" id="edit-cliente-numero" placeholder="Ex: 106" class="w-full p-2 border rounded-md mt-1" required>
          </div>
        </div>
        <div>
          <label for="edit-cliente-logradouro" class="block text-sm font-medium text-gray-700">Rua / Logradouro</label>
          <input type="text" id="edit-cliente-logradouro" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
        </div>
        <div>
          <label for="edit-cliente-bairro" class="block text-sm font-medium text-gray-700">Bairro</label>
          <input type="text" id="edit-cliente-bairro" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div class="col-span-2">
            <label for="edit-cliente-cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
            <input type="text" id="edit-cliente-cidade" placeholder="Preenchido pelo CEP" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
          </div>
          <div>
            <label for="edit-cliente-uf" class="block text-sm font-medium text-gray-700">UF</label>
            <input type="text" id="edit-cliente-uf" placeholder="UF" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
          </div>
        </div>

        <div>
          <label for="edit-cliente-documento" class="block text-sm font-medium text-gray-700">CPF ou CNPJ</label>
          <input type="text" id="edit-cliente-documento" class="w-full p-2 border rounded-md mt-1">
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeEditClienteModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>
      
  <div id="edit-material-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
      <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Material</h3>
      <form id="form-edit-material" class="space-y-4">
        <input type="hidden" id="edit-material-id">
        <div>
          <label for="edit-material-nome" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
          <input type="text" id="edit-material-nome" class="w-full p-2 border rounded-md mt-1" required>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="edit-material-unidade" class="block text-sm font-medium text-gray-700">Unidade</label>
            <select id="edit-material-unidade" class="w-full p-2 border rounded-md mt-1 h-10">
              <option>UNID</option><option>P√ß</option><option>m</option><option>cx</option><option>kit</option>
            </select>
          </div>
          <div>
            <label for="edit-material-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
            <input type="number" step="0.01" id="edit-material-valor" class="w-full p-2 border rounded-md mt-1" required>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeEditMaterialModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Altera√ß√µes</button>
        </div>
      </form>
    </div>
  </div>

  <div id="edit-tiposervico-modal" class="modal">
    <div class="bg-white rounded-lg p-6 w-[95%] max-w-lg shadow-xl">
        <h3 class="text-xl font-bold text-gray-800 mb-6">Editar Tipo de Servi√ßo</h3>
        <form id="form-edit-tiposervico" class="space-y-4">
            <input type="hidden" id="edit-tiposervico-id">
            <div>
                <label for="edit-tiposervico-categoria" class="block text-sm font-medium text-gray-700">Categoria</label>
                <input type="text" id="edit-tiposervico-categoria" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: INSTALA√á√ïES" required>
            </div>
            <div>
                <label for="edit-tiposervico-descricao" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                <input type="text" id="edit-tiposervico-descricao" class="w-full p-2 border rounded-md mt-1" required>
            </div>
            <div>
                <label for="edit-tiposervico-valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                <input type="number" step="0.01" id="edit-tiposervico-valor" class="w-full p-2 border rounded-md mt-1" required>
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeEditTipoServicoModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Salvar Altera√ß√µes</button>
            </div>
        </form>
    </div>
  </div>

  <div id="login-view" class="hidden h-screen flex flex-col justify-center items-center text-center p-6 bg-gray-100">
    <h1 class="text-4xl font-bold text-gray-800">Bem-vindo ao</h1>
    <h2 class="text-5xl font-extrabold text-blue-600 mb-8">Gerador de Or√ßamentos 5.0</h2>
    <p class="max-w-md mb-8 text-gray-600">Seus dados salvos na nuvem.</p>
    <button id="login-button" class="bg-white text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-shadow flex items-center">
      <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.138,44,30.025,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
      Entrar com Google
    </button>
  </div>

  <div id="app-view" class="hidden">
    <header class="bg-gray-900 text-white shadow-md">
      <div class="max-w-4xl mx-auto py-3 px-4 md:px-6 flex justify-between items-center">
        <h1 class="font-bold text-left leading-tight">
          <span class="block text-3xl sm:text-4xl lg:text-5xl">QUOTEX</span>
          <span class="block text-lg sm:text-xl lg:text-2xl mt-1">Or√ßamento Inteligente</span>
        </h1>
        <img src="https://i.postimg.cc/T3VYRRgx/Orcamento-Inteligente.png" alt="Or√ßamento Inteligente" class="h-14 sm:h-16 lg:h-20 w-auto">
      </div>
    </header>

    <div id="main-view">
      <div class="max-w-4xl mx-auto p-4 md:p-6 w-full">
        <p class="text-md text-gray-600 text-left sm:text-center -mt-2 mb-6">Crie, gerencie e envie or√ßamentos de forma r√°pida.</p>

        <div class="mb-6 border-b border-gray-200 hidden sm:block">
          <nav class="flex -mb-px space-x-6">
            <button class="tab active py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="orcamentos" onclick="changeTab(event, 'orcamentos')">Tela Inicial</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="clientes" onclick="changeTab(event, 'clientes')">Clientes</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="materiais" onclick="changeTab(event, 'materiais')">Materiais</button>
            <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="servicos" onclick="changeTab(event, 'servicos')">Servi√ßos</button>
                        <button class="tab py-4 px-1 text-gray-500 hover:text-blue-600" data-tab="financeiro" onclick="changeTab(event, 'financeiro')">
              Financeiro
            </button>
<button class="tab py-4 px-1 text-gray-500 hover:text-blue-600 flex items-center" data-tab="configuracoes" onclick="changeTab(event, 'configuracoes')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.575 1.558.75.244.081.503.14.767.17.844.088 1.517.766 1.517 1.61z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Configura√ß√µes
            </button>
          </nav>
        </div>
        <div class="mb-6 sm:hidden space-y-2">
            <div class="grid grid-cols-3 gap-2">
                <button class="mobile-tab active text-white p-3 rounded-lg shadow-md bg-blue-500" data-tab="orcamentos" onclick="changeTab(event, 'orcamentos')">In√≠cio</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-green-500" data-tab="clientes" onclick="changeTab(event, 'clientes')">Clientes</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-yellow-500" data-tab="materiais" onclick="changeTab(event, 'materiais')">Materiais</button>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-red-500" data-tab="servicos" onclick="changeTab(event, 'servicos')">Servi√ßos</button>
                <button class="mobile-tab text-white p-3 rounded-lg shadow-md bg-gray-500 flex items-center justify-center" data-tab="configuracoes" onclick="changeTab(event, 'configuracoes')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 sm:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.322 1.017.575 1.558.75.244.081.503.14.767.17.844.088 1.517.766 1.517 1.61z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Conf.
                </button>
                <button class="mobile-tab text-white p-3 rounded-lg bg-green-500/80" data-tab="financeiro" onclick="changeTab(event, 'financeiro')">
                    Financeiro
                </button> </div>
        </div>

        <main>
          <div id="orcamentos" class="tab-content active space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <button onclick="showAllOrcamentosPage()" class="bg-gray-800 text-white p-4 rounded-lg flex justify-center items-center shadow hover:bg-gray-900 transition-colors">
                <h2 class="text-xl font-semibold text-center">Or√ßamentos</h2>
              </button>
              <button type="button" onclick="openOrcamentoModal()" class="bg-blue-600 text-white p-4 rounded-lg shadow hover:bg-blue-700 transition-colors font-medium flex justify-center items-center">
                <span class="text-xl font-semibold">+ Novo Or√ßamento</span>
              </button>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 pt-4">√öltimos 3 Or√ßamentos</h3>
            <div id="orcamentos-list-recent" class="space-y-3"></div>
          </div>

         <div id="clientes" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Gerenciar Clientes</h2>

              <div class="relative mb-4">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                  </div>
                  <input type="text" id="search-cliente" class="block w-full pl-10 p-3 border rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" placeholder="Pesquisar cliente por nome...">
              </div>

              <details class="group border rounded-lg mb-4">
                <summary class="flex items-center justify-between p-4 cursor-pointer bg-white hover:bg-gray-50 rounded-lg font-bold text-gray-700 border-b group-open:border-gray-200 transition-colors select-none">
                    <span class="flex items-center gap-2 text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        Cadastrar Novo Cliente
                    </span>
                    <svg class="w-5 h-5 text-gray-400 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </summary>
                <div class="p-6 bg-gray-50 rounded-b-lg">
                  <form id="form-cliente" class="space-y-4">
                    <input type="text" id="cliente-nome" placeholder="Nome do Cliente" class="w-full p-2 border rounded-md bg-white" required>
                    <input type="tel" id="cliente-telefone" placeholder="Telefone (com DDD)" class="w-full p-2 border rounded-md bg-white" required>
                    <div class="grid grid-cols-3 gap-4">
                      <div class="col-span-2"><input type="text" id="cliente-cep" onchange="buscarCEP(this.value, { logradouro: 'cliente-logradouro', bairro: 'cliente-bairro', cidade: 'cliente-cidade', uf: 'cliente-uf', numero: 'cliente-numero' })" placeholder="CEP" class="w-full p-2 border rounded-md bg-white"></div>
                      <div><input type="text" id="cliente-numero" placeholder="N¬∫" class="w-full p-2 border rounded-md bg-white" required></div>
                    </div>
                    <input type="text" id="cliente-logradouro" placeholder="Rua" class="w-full p-2 border bg-gray-100" readonly>
                    <input type="text" id="cliente-bairro" placeholder="Bairro" class="w-full p-2 border bg-gray-100" readonly>
                    <div class="grid grid-cols-3 gap-4">
                      <div class="col-span-2"><input type="text" id="cliente-cidade" placeholder="Cidade" class="w-full p-2 border bg-gray-100" readonly></div>
                      <div><input type="text" id="cliente-uf" placeholder="UF" class="w-full p-2 border bg-gray-100" readonly></div>
                    </div>
                    <input type="text" id="cliente-documento" placeholder="CPF ou CNPJ" class="w-full p-2 border rounded-md bg-white">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg w-full sm:w-auto shadow hover:bg-blue-700 transition-colors font-medium">Salvar Cliente</button>
                  </form>
                </div>
              </details>
              
              <details class="group border rounded-lg" open>
                  <summary class="flex items-center justify-between p-4 cursor-pointer bg-white hover:bg-gray-50 rounded-t-lg border-b select-none">
                      <span class="font-bold text-gray-700">üìã Lista de Clientes</span>
                      <svg class="w-5 h-5 text-gray-400 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </summary>
                  <div id="clientes-list" class="space-y-2 p-2 bg-white max-h-[600px] overflow-y-auto"></div>
              </details>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="font-semibold mb-2">Importar Clientes</h3>
                <div class="mb-4 text-xs text-gray-500">Planilha (.xlsx) com: Nome, Telefone, Documento, CEP, Numero, Logradouro, Bairro, Cidade, UF.</div>
                <div class="flex flex-col sm:flex-row gap-2">
                  <input type="file" id="clientes-xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm border p-1 rounded">
                  <button id="btn-import-clientes-xlsx" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 font-medium">Importar</button>
                  <button id="btn-clear-clientes" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 font-medium">Limpar Tudo</button>
                </div>
                <p id="clientes-xlsx-status" class="text-xs text-gray-500 mt-1"></p>
            </div>
          </div>

          <div id="materiais" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              
              <details class="group border rounded-lg mb-4">
                  <summary class="flex items-center justify-between p-4 cursor-pointer bg-gray-100 hover:bg-gray-200 rounded-lg font-bold text-gray-700">
                      <span>‚ûï Cadastrar Material</span>
                      <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </summary>
                  <form id="form-material" class="flex flex-col gap-4 p-4 border-t bg-gray-50">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="material-nome" class="flex-grow p-2 border rounded-md" placeholder="Descri√ß√£o do Item" required>
                        <select id="material-unidade" class="w-24 p-2 border rounded-md"><option>UNID</option><option>P√ß</option><option>m</option><option>cx</option><option>kit</option></select>
                        <input type="number" step="0.01" id="material-valor" class="w-32 p-2 border rounded-md" placeholder="Valor R$" required>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="material-is-estoque" class="h-5 w-5 text-blue-600 rounded">
                        <label for="material-is-estoque" class="text-sm font-medium text-gray-700 cursor-pointer">Cadastrar como <strong>Material de Estoque</strong> (Sobressalente)</label>
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full sm:w-auto">Salvar Item</button>
                  </form>
              </details>

              <details class="group border rounded-lg mb-2" open>
                  <summary class="flex items-center justify-between p-4 cursor-pointer bg-white hover:bg-gray-50 rounded-t-lg border-b">
                      <span class="font-bold text-gray-700">üìã Lista de Compras (Padr√£o)</span>
                      <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </summary>
                  <div id="materiais-list-padrao" class="p-4 space-y-2 bg-white">
                      <p class="text-gray-500 text-sm">Nenhum item cadastrado.</p>
                  </div>
              </details>

              <details class="group border rounded-lg">
                  <summary class="flex items-center justify-between p-4 cursor-pointer bg-blue-50 hover:bg-blue-100 rounded-t-lg border-b border-blue-100">
                      <span class="font-bold text-blue-800">üì¶ Material de Estoque (Dispon√≠vel)</span>
                      <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </summary>
                  <div id="materiais-list-estoque" class="p-4 space-y-2 bg-white">
                      <p class="text-gray-500 text-sm">Nenhum item em estoque.</p>
                  </div>
              </details>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="font-semibold mb-2">Importar via Excel</h3>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 text-sm text-blue-800">
                    <p class="font-bold">Dica para Estoque:</p>
                    <p>Adicione uma coluna chamada <strong>"Estoque"</strong> na sua planilha.</p>
                    <p>Se voc√™ escrever <strong>"SIM"</strong> ou <strong>"ESTOQUE"</strong> nessa coluna, o item vai automaticamente para a lista azul.</p>
                </div>

                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="file" id="materiais-xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm border p-1 rounded">
                    <button id="btn-import-materiais-xlsx" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Importar</button>
                    <button id="btn-clear-materiais" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">Limpar Tudo</button>
                </div>
                <p id="materiais-xlsx-status" class="text-xs text-gray-500 mt-1"></p>
            </div>
          </div>

          <div id="servicos" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm">
              <h2 class="text-xl font-semibold mb-4">Gerenciar Servi√ßos</h2>

              <details class="group border rounded-lg mb-4">
                  <summary class="flex items-center justify-between p-4 cursor-pointer bg-gray-100 hover:bg-gray-200 rounded-lg font-bold text-gray-700">
                      <span>‚ûï Cadastrar Servi√ßo</span>
                      <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </summary>
                  <form id="form-tiposervico" class="space-y-4 p-6 border-t bg-gray-50">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700">Categoria</label>
                        <select id="tiposervico-categoria-select" class="w-full p-2 border rounded-md mt-1"><option value="">Selecionar...</option><option value="new_category">+ Nova</option></select>
                        <input type="text" id="tiposervico-categoria-new" placeholder="Nome da Categoria" class="w-full p-2 border rounded-md mt-2 hidden">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                        <input type="text" id="tiposervico-descricao" placeholder="Ex: Instala√ß√£o" class="w-full p-2 border rounded-md mt-1" required>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                        <input type="number" step="0.01" id="tiposervico-valor" placeholder="0.00" class="w-full p-2 border rounded-md mt-1" required>
                      </div>
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors w-full sm:w-auto">Salvar Servi√ßo</button>
                  </form>
              </details>

              <details class="group border rounded-lg" open>
                  <summary class="flex items-center justify-between p-4 cursor-pointer bg-white hover:bg-gray-50 rounded-t-lg border-b">
                      <span class="font-bold text-gray-700">üìã Lista de Servi√ßos Cadastrados</span>
                      <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                  </summary>
                  <div id="tiposdeservico-list" class="p-4 space-y-2 bg-white"></div>
              </details>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h3 class="font-semibold mb-2">Importar Servi√ßos</h3>
                <div class="mb-4 text-xs text-gray-500">Planilha (.xlsx) com as colunas: Categoria, Descri√ß√£o e Valor.</div>
                <div class="flex flex-col sm:flex-row gap-2">
                  <input type="file" id="xlsx-input" accept=".xlsx,.xls" class="block w-full text-sm border p-1 rounded">
                  <button id="btn-import-xlsx" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Importar</button>
                  <button id="btn-clear-tiposervico" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">Limpar Tudo</button>
                </div>
                <p id="xlsx-status" class="text-xs text-gray-500 mt-1"></p>
            </div>
          </div>

          <div id="financeiro" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-lg shadow-sm space-y-4">
              <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                <div>
                  <h2 class="text-xl font-semibold mb-1">Financeiro / Faturamento</h2>
                  <p class="text-sm text-gray-500">Acompanhe o valor bruto gerado em or√ßamentos e o valor l√≠quido apenas dos aprovados.</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                  <div class="flex items-center gap-2">
                    <label for="fat-ano" class="text-sm text-gray-600">Ano:</label>
                    <select id="fat-ano" class="border rounded px-2 py-1 text-sm">
                      <option value="todos">Todos</option>
                      <option value="2023">2023</option>
                      <option value="2024">2024</option>
                      <option value="2025">2025</option>
                      <option value="2026">2026</option>
                      <option value="2027">2027</option>
                    </select>
                  </div>
                  <div class="flex items-center gap-2">
                    <label for="fat-mes" class="text-sm text-gray-600">M√™s:</label>
                    <select id="fat-mes" class="border rounded px-2 py-1 text-sm">
                      <option value="all">Todos</option>
                      <option value="0">Janeiro</option>
                      <option value="1">Fevereiro</option>
                      <option value="2">Mar√ßo</option>
                      <option value="3">Abril</option>
                      <option value="4">Maio</option>
                      <option value="5">Junho</option>
                      <option value="6">Julho</option>
                      <option value="7">Agosto</option>
                      <option value="8">Setembro</option>
                      <option value="9">Outubro</option>
                      <option value="10">Novembro</option>
                      <option value="11">Dezembro</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="mt-4 grid gap-4 md:grid-cols-3">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                  <p class="text-xs font-medium text-yellow-700 uppercase tracking-wide">Valor Bruto (gerado)</p>
                  <p id="fat-bruto" class="mt-1 text-lg font-semibold text-yellow-800">R$ 0,00</p>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                  <p class="text-xs font-medium text-green-700 uppercase tracking-wide">Valor L√≠quido (aprovado)</p>
                  <p id="fat-liquido" class="mt-1 text-lg font-extrabold text-green-800">R$ 0,00</p>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <p class="text-xs font-medium text-blue-700 uppercase tracking-wide">Or√ßamentos (aprovados x pendentes)</p>
                  <p id="fat-contagem" class="mt-1 text-sm text-blue-800">0 aprovados / 0 pendentes</p>
                </div>
              </div>

              <div class="mt-6 bg-gray-50 p-3 rounded-lg border flex flex-col sm:flex-row justify-between items-center gap-3">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-gray-700">Visualiza√ß√£o:</span>
                  <select id="chart-periodo" class="border rounded px-2 py-1 text-sm bg-white" onchange="updateFinanceiroView()">
                    <option value="mensal">Mensal (Detalhado)</option>
                    <option value="anual">Anual (M√™s a M√™s)</option>
                  </select>
                </div>
                
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-gray-700">Tipo:</span>
                  <div class="flex bg-white rounded border overflow-hidden">
                    <button type="button" class="px-3 py-1 text-sm hover:bg-gray-100 border-r text-xl" onclick="mudarTipoGrafico('bar')" title="Colunas">
                      üìä
                    </button>
                    <button type="button" class="px-3 py-1 text-sm hover:bg-gray-100 text-xl" onclick="mudarTipoGrafico('pie')" title="Pizza">
                      üçï
                    </button>
                  </div>
                </div>
              </div>

              <div class="mt-2 bg-white p-4 rounded-lg border shadow-sm">
                <div class="relative h-[300px] w-full">
                    <canvas id="finance-chart"></canvas>
                </div>
              </div>

              <div class="mt-6 border-t pt-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-3">Exportar faturamento</h3>
                <div class="grid gap-3 md:grid-cols-[repeat(3,minmax(0,1fr))] md:items-end">
                  <div>
                    <label for="fat-data-inicio" class="block text-xs font-medium text-gray-600">Data inicial</label>
                    <input type="date" id="fat-data-inicio" class="mt-1 block w-full border rounded px-2 py-1 text-sm" />
                  </div>
                  <div>
                    <label for="fat-data-fim" class="block text-xs font-medium text-gray-600">Data final</label>
                    <input type="date" id="fat-data-fim" class="mt-1 block w-full border rounded px-2 py-1 text-sm" />
                  </div>
                  <div class="flex gap-2">
                    <button id="btn-atualizar-financeiro" class="flex-1 inline-flex justify-center items-center px-3 py-2 border border-indigo-500 text-indigo-600 text-sm font-medium rounded-md hover:bg-indigo-50">
                      Atualizar dados
                    </button>
                    <button id="btn-exportar-financeiro" class="flex-1 inline-flex justify-center items-center px-3 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50">
                      Exportar (.xlsx)
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="configuracoes" class="tab-content space-y-4">
    <div class="bg-white p-6 rounded-lg shadow-sm min-h-[500px]">
        
        <div id="config-menu-view">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Configura√ß√µes</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button onclick="showConfigSection('section-empresa')" class="flex flex-col items-center justify-center p-6 border-2 border-gray-100 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all group">
                    <div class="bg-blue-100 p-4 rounded-full mb-3 group-hover:bg-blue-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <span class="font-semibold text-gray-700 text-lg">Dados da Empresa</span>
                    <span class="text-xs text-gray-500 mt-1">Nome, Endere√ßo e Logo</span>
                </button>

                <button onclick="showConfigSection('section-valores')" class="flex flex-col items-center justify-center p-6 border-2 border-gray-100 rounded-xl hover:border-green-500 hover:bg-green-50 transition-all group">
                    <div class="bg-green-100 p-4 rounded-full mb-3 group-hover:bg-green-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <span class="font-semibold text-gray-700 text-lg">M√£o de Obra</span>
                    <span class="text-xs text-gray-500 mt-1">Valores de servi√ßos</span>
                </button>

                <button onclick="showConfigSection('section-pagamento')" class="flex flex-col items-center justify-center p-6 border-2 border-gray-100 rounded-xl hover:border-yellow-500 hover:bg-yellow-50 transition-all group">
                    <div class="bg-yellow-100 p-4 rounded-full mb-3 group-hover:bg-yellow-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                        </svg>
                    </div>
                    <span class="font-semibold text-gray-700 text-lg">Formas de Pagamento</span>
                    <span class="text-xs text-gray-500 mt-1">Pix, Cart√£o e Bancos</span>
                </button>

                <button onclick="showConfigSection('section-cores')" class="flex flex-col items-center justify-center p-6 border-2 border-gray-100 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all group">
                    <div class="bg-purple-100 p-4 rounded-full mb-3 group-hover:bg-purple-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                        </svg>
                    </div>
                    <span class="font-semibold text-gray-700 text-lg">Padr√£o de Cores</span>
                    <span class="text-xs text-gray-500 mt-1">Personaliza√ß√£o do PDF</span>
                </button>
            </div>
            <div class="mt-12 border-t pt-6 text-center">
                <p id="user-info" class="text-gray-600 mb-4 text-sm"></p>
                <button id="logout-button" class="text-red-500 hover:text-red-700 font-medium text-sm flex items-center justify-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    Sair da Conta
                </button>
            </div>
        </div>

        <div id="section-empresa" class="config-section hidden">
            <div class="flex items-center justify-between mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800">Dados da Empresa</h3>
                <button type="button" onclick="hideConfigSection()" class="text-gray-500 hover:text-blue-600 font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    Voltar
                </button>
            </div>
            <div class="space-y-4">
                <input type="text" id="config-nome" placeholder="Seu Nome ou Nome da Empresa" class="w-full p-2 border rounded-md">
                <input type="tel" id="config-telefone" placeholder="Seu Telefone" class="w-full p-2 border rounded-md">
                <input type="text" id="config-doc" placeholder="Seu CPF ou CNPJ" class="w-full p-2 border rounded-md">

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">CEP</label>
                        <input type="text" id="config-cep" onchange="buscarCEP(this.value, { logradouro: 'config-logradouro', bairro: 'config-bairro', cidade: 'config-cidade', uf: 'config-uf', numero: 'config-numero' })" placeholder="00000-000" class="w-full p-2 border rounded-md mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">N√∫mero</label>
                        <input type="text" id="config-numero" placeholder="Ex: 106" class="w-full p-2 border rounded-md mt-1">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Rua / Logradouro</label>
                    <input type="text" id="config-logradouro" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Bairro</label>
                    <input type="text" id="config-bairro" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Cidade</label>
                        <input type="text" id="config-cidade" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">UF</label>
                        <input type="text" id="config-uf" class="w-full p-2 border rounded-md mt-1 bg-gray-50" readonly>
                    </div>
                </div>
                <input type="hidden" id="config-logo">
                <div class="pt-4 border-t mt-4">
                    <label class="block text-sm font-medium text-gray-700">Logomarca (opcional)</label>
                    <input type="file" id="config-logo-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-700 border rounded-md p-2 bg-white">
                    <div id="config-logo-preview-wrapper" class="mt-2 hidden">
                        <p class="text-xs text-gray-600 mb-1">Pr√©-visualiza√ß√£o:</p>
                        <div class="flex items-center gap-3">
                            <img id="config-logo-preview" src="" alt="Logo" class="max-h-16 object-contain border rounded-md bg-white p-1">
                            <button type="button" id="config-logo-clear" class="text-xs text-red-600 hover:underline">Remover</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button type="button" onclick="saveConfigData()" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors w-full sm:w-auto">Salvar Dados da Empresa</button>
            </div>
        </div>

        <div id="section-valores" class="config-section hidden">
            <div class="flex items-center justify-between mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800">Valores de M√£o de Obra</h3>
                <button type="button" onclick="hideConfigSection()" class="text-gray-500 hover:text-blue-600 font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    Voltar
                </button>
            </div>
            <div>
                <h4 class="text-md font-semibold text-blue-800 mb-4 bg-blue-50 p-2 rounded">Residencial / Predial</h4>
                <div class="space-y-4">
                    <label class="block"><span class="text-gray-700">Valor por Empreitada (R$)</span><input type="number" step="0.01" id="config-residencial-empreitada" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    <label class="block"><span class="text-gray-700">Valor da Di√°ria (R$)</span><input type="number" step="0.01" id="config-residencial-diaria" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    <label class="block"><span class="text-gray-700">Valor por Ponto (R$)</span><input type="number" step="0.01" id="config-residencial-ponto" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    <label class="block"><span class="text-gray-700">Valor por Hora (R$)</span><input type="number" step="0.01" id="config-residencial-hora" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                </div>
            </div>
            <div class="mt-8">
                <h4 class="text-md font-semibold text-gray-800 mb-4 bg-gray-100 p-2 rounded">Industrial</h4>
                <div class="space-y-4">
                    <label class="block"><span class="text-gray-700">Valor da Di√°ria (R$)</span><input type="number" step="0.01" id="config-industrial-diaria" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    <label class="block"><span class="text-gray-700">Valor por Equipamento (R$)</span><input type="number" step="0.01" id="config-industrial-ponto" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                    <label class="block"><span class="text-gray-700">Valor por Hora (R$)</span><input type="number" step="0.01" id="config-industrial-hora" class="w-full p-2 border rounded-md mt-1" placeholder="0.00"></label>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button type="button" onclick="saveConfigData()" class="bg-green-600 text-white px-6 py-2 rounded-lg shadow hover:bg-green-700 transition-colors w-full sm:w-auto">Salvar Valores</button>
            </div>
        </div>

        <div id="section-pagamento" class="config-section hidden">
            <div class="flex items-center justify-between mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800">Formas de Pagamento</h3>
                <button type="button" onclick="hideConfigSection()" class="text-gray-500 hover:text-blue-600 font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    Voltar
                </button>
            </div>
            <div class="space-y-4">
                <label class="block"><span class="text-gray-700">Chave PIX</span><input type="text" id="config-pix-chave" class="w-full p-2 border rounded-md mt-1" placeholder="Sua chave PIX"></label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block"><span class="text-gray-700">Cart√£o (Parcelas)</span><input type="number" step="1" id="config-cartao-vezes" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 12"></label>
                    </div>
                    <div>
                        <label class="block"><span class="text-gray-700">Juros % a.m.</span><input type="number" step="0.01" id="config-cartao-juros" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 1.99"></label>
                    </div>
                </div>
                <label class="flex items-center mt-2 p-2 bg-gray-50 rounded border cursor-pointer">
                    <input type="checkbox" id="config-pagamento-dinheiro" class="h-5 w-5 text-blue-600 border-gray-300 rounded mr-2">
                    <span class="text-gray-800 font-medium">Aceita Dinheiro</span>
                </label>
                
                <h4 class="text-md font-medium pt-4 border-t mt-4 text-gray-800">Dados para Dep√≥sito</h4>
                <div class="space-y-3">
                    <label class="block"><span class="text-gray-700">Banco</span><input type="text" id="config-deposito-banco" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: Banco do Brasil"></label>
                    <label class="block"><span class="text-gray-700">Ag√™ncia</span><input type="text" id="config-deposito-ag" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 0001"></label>
                    <label class="block"><span class="text-gray-700">Conta</span><input type="text" id="config-deposito-conta" class="w-full p-2 border rounded-md mt-1" placeholder="Ex: 12345-6"></label>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button type="button" onclick="saveConfigData()" class="bg-yellow-500 text-white px-6 py-2 rounded-lg shadow hover:bg-yellow-600 transition-colors w-full sm:w-auto">Salvar Pagamento</button>
            </div>
        </div>

        <div id="section-cores" class="config-section hidden">
            <div class="flex items-center justify-between mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800">Padr√£o de Cores</h3>
                <button type="button" onclick="hideConfigSection()" class="text-gray-500 hover:text-blue-600 font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                    Voltar
                </button>
            </div>
            <div class="flex flex-col gap-6">
                <label class="block p-4 border rounded-lg bg-gray-50 cursor-pointer">
                    <span class="text-lg font-medium text-gray-800 block mb-2">Cor Prim√°ria (T√≠tulos)</span>
                    <div class="flex items-center gap-4">
                        <input type="color" id="config-color-primary" class="w-16 h-16 p-1 border rounded-md" value="#000000">
                        <span class="text-gray-500 text-sm">Cor usada nos t√≠tulos principais do PDF.</span>
                    </div>
                </label>
                <label class="block p-4 border rounded-lg bg-gray-50 cursor-pointer">
                    <span class="text-lg font-medium text-gray-800 block mb-2">Cor Secund√°ria (Total)</span>
                    <div class="flex items-center gap-4">
                        <input type="color" id="config-color-secondary" class="w-16 h-16 p-1 border rounded-md" value="#333333">
                        <span class="text-gray-500 text-sm">Cor usada no valor total e detalhes.</span>
                    </div>
                </label>
            </div>
            <div class="mt-6 text-right">
                <button type="button" onclick="saveConfigData()" class="bg-purple-600 text-white px-6 py-2 rounded-lg shadow hover:bg-purple-700 transition-colors w-full sm:w-auto">Salvar Cores</button>
            </div>
        </div>
    </div>
</div>
        </main>
      </div>
    </div>

    <div id="all-orcamentos-view" class="hidden">

      
      <div class="max-w-4xl mx-auto p-4 md:p-6 w-full">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
          <h2 class="text-2xl font-semibold">Todos os Or√ßamentos</h2>
          <div class="flex gap-2 w-full sm:w-auto justify-end">
             <button onclick="showMainPage()" class="bg-gray-500 text-white px-5 py-2 rounded-lg shadow hover:bg-gray-600 transition-colors font-medium">Voltar</button>
             <button id="btn-delete-selected-orcamentos" onclick="confirmDeleteSelectedOrcamentos()" class="bg-red-600 text-white px-5 py-2 rounded-lg shadow hover:bg-red-700 transition-colors font-medium disabled:opacity-50" disabled>Excluir Selecionados</button>
          </div>
        </div>
        <div id="all-orcamentos-list-container">
              <div class="mb-4 grid gap-3 md:grid-cols-4">
                <div>
                  <label for="filtro-status-orcamento" class="block text-xs font-medium text-gray-600">Status</label>
                  <select id="filtro-status-orcamento" class="mt-1 block w-full border rounded px-2 py-1 text-sm">
                    <option value="todos">Todos</option>
                    <option value="aprovado">Aprovados</option>
                    <option value="pendente">Pendentes</option>
                  </select>
                </div>
                <div>
                  <label for="filtro-mes-orcamento" class="block text-xs font-medium text-gray-600">M√™s</label>
                  <select id="filtro-mes-orcamento" class="mt-1 block w-full border rounded px-2 py-1 text-sm">
                    <option value="todos">Todos</option>
                    <option value="0">Janeiro</option>
                    <option value="1">Fevereiro</option>
                    <option value="2">Mar√ßo</option>
                    <option value="3">Abril</option>
                    <option value="4">Maio</option>
                    <option value="5">Junho</option>
                    <option value="6">Julho</option>
                    <option value="7">Agosto</option>
                    <option value="8">Setembro</option>
                    <option value="9">Outubro</option>
                    <option value="10">Novembro</option>
                    <option value="11">Dezembro</option>
                  </select>
                </div>
                <div>
                  <label for="filtro-ano-orcamento" class="block text-xs font-medium text-gray-600">Ano</label>
                  <select id="filtro-ano-orcamento" class="mt-1 block w-full border rounded px-2 py-1 text-sm">
                    <option value="todos">Todos</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <button id="btn-limpar-filtros-orcamento" class="inline-flex justify-center items-center w-full px-3 py-2 border border-gray-300 text-gray-700 text-xs font-medium rounded-md hover:bg-gray-50">
                    Limpar filtros
                  </button>
                </div>
              </div>
             </div> <div id="all-orcamentos-list" class="space-y-3"></div>
      </div>
    </div>
    <div id="orcamento-modal" class="modal">
      <div class="bg-white rounded-lg p-6 w-[95%] max-w-[960px] max-height-[90vh] max-h-[90vh] overflow-y-auto shadow-xl">
        <div class="flex justify-between items-center mb-6">
          <h2 id="modal-title" class="text-2xl font-bold">Criar Novo Or√ßamento</h2>
          <button onclick="closeOrcamentoModal()" class="text-gray-500 text-2xl font-bold">&times;</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="space-y-6">
            
            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">Selecione o Cliente</h4>
              <select id="orc-cliente-select" class="w-full p-2 border rounded-md">
                <option value="">Selecione um cliente</option>
              </select>
            </div>

            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">Modo de Cobran√ßa</h4>
              <div id="orc-modo-cobranca" class="flex gap-3">
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="modo-cobranca" value="mao_de_obra" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                  <span class="ml-3 text-sm font-medium text-gray-900">M√£o de Obra</span>
                </label>
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="modo-cobranca" value="por_servico" class="h-4 w-4 text-blue-600 border-gray-300">
                  <span class="ml-3 text-sm font-medium text-gray-900">Por Servi√ßo</span>
                </label>
              </div>
            </div>

            <div id="orc-cobranca-mo-wrapper" class="space-y-6">
              <div>
                <h4 class="text-md font-medium text-gray-800 mb-2">ESPECIALIDADE</h4>
                <div id="orc-tipo-obra" class="flex gap-3">
                  <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                    <input type="radio" name="tipo-obra" value="residencial" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                    <span class="ml-3 text-sm font-medium text-gray-900">Residencial/Predial</span>
                  </label>
                  <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                    <input type="radio" name="tipo-obra" value="industrial" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span class="ml-3 text-sm font-medium text-gray-900">Industrial</span>
                  </label>
                </div>
              </div>

              <div>
                <h4 class="text-md font-medium text-gray-800 mb-2">M√£o de Obra</h4>
                <div id="orc-mao-de-obra" class="space-y-2">
                  <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo-servico" value="empreitada" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span class="ml-3 text-sm font-medium text-gray-900">Empreitada</span>
                    <input type="number" step="0.01" id="empreitada-valor" placeholder="Valor total R$" class="ml-auto w-32 p-1 border rounded-md text-sm">
                  </label>
                  <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo-servico" value="diaria" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span class="ml-3 text-sm font-medium text-gray-900">Di√°ria</span>
                    <input type="number" step="1" id="diaria-qtd" placeholder="Qtd. dias" class="ml-auto w-32 p-1 border rounded-md text-sm">
                  </label>
                  <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo-servico" value="ponto" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span id="ponto-label-span" class="ml-3 text-sm font-medium text-gray-900">Por Ponto</span>
                    <input type="number" step="1" id="ponto-qtd" placeholder="Qtd. pontos" class="ml-auto w-32 p-1 border rounded-md text-sm">
                  </label>
                  <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo-servico" value="hora" class="h-4 w-4 text-blue-600 border-gray-300">
                    <span class="ml-3 text-sm font-medium text-gray-900">Por Hora</span>
                    <input type="number" step="0.5" id="hora-qtd" placeholder="Qtd. horas" class="ml-auto w-32 p-1 border rounded-md text-sm">
                  </label>
                </div>
              </div>
            </div>
            
            <div id="orc-cobranca-servico-wrapper" class="space-y-6 hidden">
               <div>
                <h4 class="text-md font-medium text-gray-800 mb-2">Tipos de Servi√ßo</h4>
                <input id="filter-tipos" placeholder="Pesquisar servi√ßo..." class="w-full p-2 border rounded-md mb-2 text-sm" />
                <div id="orc-tiposdeservico-list" class="h-48 overflow-y-auto border rounded-md p-2 space-y-2 bg-gray-50"></div>
              </div>
            </div>
            
            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">Materiais</h4>
              <div id="orc-usar-material" class="flex gap-3">
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="usar-material" value="sim" class="h-4 w-4 text-blue-600 border-gray-300" checked>
                  <span class="ml-3 text-sm font-medium text-gray-900">Usar Materiais</span>
                </label>
                <label class="flex-1 flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer">
                  <input type="radio" name="usar-material" value="nao" class="h-4 w-4 text-blue-600 border-gray-300">
                  <span class="ml-3 text-sm font-medium text-gray-900">N√£o Incluir</span>
                </label>
              </div>
            </div>
            
           <div id="orc-cobranca-material-wrapper">
                <div class="flex gap-2 mb-2 border-b pb-2">
                    <button id="tab-mat-compra" onclick="filtrarMateriaisModal('padrao')" class="text-xs font-bold px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-blue-700">üìã Compras</button>
                    <button id="tab-mat-estoque" onclick="filtrarMateriaisModal('estoque')" class="text-xs font-bold px-3 py-1 bg-white border rounded hover:bg-gray-100 text-gray-600">üì¶ Estoque</button>
                </div>
                <div id="orc-materiais-list" class="h-40 overflow-y-auto border p-2 bg-gray-50 rounded"></div>
            </div>
            
            <div>
              <h4 class="text-md font-medium text-gray-800 mb-2">Desconto (Opcional)</h4>
              <div class="flex gap-3">
                <select id="orc-desconto-tipo" class="p-2 border rounded-md bg-gray-50">
                  <option value="nenhum">Sem Desconto</option>
                  <option value="percent">% (Porcentagem)</option>
                  <option value="valor">R$ (Valor Fixo)</option>
                </select>
                <input type="number" step="0.01" id="orc-desconto-valor" class="w-full p-2 border rounded-md" placeholder="0.00" disabled>
              </div>
            </div>

            <div class="mt-4">
              <label for="orc-descricao-servico" class="block text-sm font-medium text-gray-700">
                Descri√ß√£o do servi√ßo realizado (empreitada, por hora, etc.)
              </label>
              <textarea
                id="orc-descricao-servico"
                class="mt-1 w-full p-2 border rounded-md text-sm"
                rows="3"
                placeholder="Ex.: Instala√ß√£o de pontos de ilumina√ß√£o, troca de disjuntores, revis√£o geral do quadro, etc."
              ></textarea>
            </div>
            
          </div>
          <div class="bg-gray-50 p-4 rounded-lg border h-full flex flex-col">
            <h3 class="text-lg font-semibold mb-4 text-center">Pr√©-visualiza√ß√£o do Or√ßamento</h3>
            <div id="pdf-preview" class="flex-grow text-sm">
              <p class="text-gray-500 text-center mt-8">Selecione um cliente e adicione itens para ver o or√ßamento.</p>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row gap-2 justify-end">
              <button onclick="saveOrcamento()" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar Or√ßamento</button>
              <button onclick="shareOrViewPDF()" class="bg-green-600 text-white px-5 py-2 rounded-lg shadow hover:bg-green-700 transition-colors">Enviar PDF</button>
              <button onclick="sendWhatsAppText()" class="bg-teal-500 text-white px-5 py-2 rounded-lg shadow hover:bg-teal-600 transition-colors">Enviar (s√≥ texto)</button>
            </div>
          </div>
        </div>
      </div>
    </div>
      
<footer class="bg-gray-900 text-white text-center py-6 mt-12">
      <div class="max-w-4xl mx-auto px-4 md:px-6">
        <p class="mb-4">D√∫vidas e sugest√µes? Mande uma mensagem ao desenvolvedor.</p>
        <a href="https://wa.me/5551999600889" target="_blank" rel="noopener noreferrer" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md inline-block">Enviar Mensagem</a>
      </div>
    </footer>
      
  </div> <script type="module">

    console.log("VERS√ÉO 6.0 (Modo de Cobran√ßa) CARREGADA"); 
    // ===== Firebase config (preservado do seu arquivo) =====
    const firebaseConfig = {
      apiKey: "AIzaSyB-0cfQ1Y9Cz12grbia7-Y4nSlWwmXrqWg",
      authDomain: "app-orcamentos-eletrica.firebaseapp.com",
      projectId: "app-orcamentos-eletrica",
      storageBucket: "app-orcamentos-eletrica.firebasestorage.app",
      messagingSenderId: "424397941585",
      appId: "1:424397941585:web:3d5a24606f1a4f6ae54170"
    };

    // Imports Firebase
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, setDoc, deleteDoc, onSnapshot, collection, query, addDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===== Estado e elementos =====
    let app, db, auth, userId;
    setLogLevel('error'); // 'debug' | 'error'

    const loadingOverlay = document.getElementById('loading-overlay');
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const mainView = document.getElementById('main-view');
    const allOrcamentosView = document.getElementById('all-orcamentos-view');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button');
    const userInfo = document.getElementById('user-info');

    const appState = {
      config: {}, clientes: [], materiais: [], orcamentos: [],
      tiposDeServico: [], currentOrcamento: null,
      orcamentosParaExcluir: new Set()
    };

    let financeChart = null;


    let chartType = 'bar';

    function resetCurrentOrcamento() {
      appState.currentOrcamento = {
        id: null, cliente: null, 
        modoCobranca: 'mao_de_obra', // NOVO
        usarMaterial: 'sim', // NOVO
        tiposDeServico: [], 
        items: [],
        maoDeObra: { tipo: '', valor: 0, label: '', raw_value: '' },
        desconto: { tipo: 'nenhum', valor: 0 },
        total: 0, tipoObra: 'residencial', createdAt: null,
        status: 'pendente',
        numeroOrcamento: null, versao: 1
      };
    }
// Fun√ß√£o para selecionar automaticamente o m√™s e ano atuais
    function setupInitialDates() {
      const hoje = new Date();
      const anoAtual = hoje.getFullYear().toString();
      const mesAtual = hoje.getMonth().toString(); // 0 a 11

      const elAno = document.getElementById('fat-ano');
      const elMes = document.getElementById('fat-mes');

      if (elAno) {
        // Verifica se o ano atual existe nas op√ß√µes, se n√£o, mant√©m o padr√£o
        const optionExists = [...elAno.options].some(o => o.value === anoAtual);
        if (optionExists) elAno.value = anoAtual;
      }
      
      if (elMes) {
        elMes.value = mesAtual;
      }
    }
    // ===== Inicializa√ß√£o Firebase e Auth =====
    async function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            userInfo.textContent = `Logado como: ${user.displayName || user.email}`;
            loadingOverlay.querySelector('p').textContent = 'Carregando seus dados...';
            setupInitialDates();
            loadAllData();
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            loadingOverlay.style.display = 'none';

            // ===== Aplicar M√°scaras CPF/CNPJ =====
            document.getElementById('config-doc')?.addEventListener('input', handleDocMask);
            document.getElementById('cliente-documento')?.addEventListener('input', handleDocMask);
            document.getElementById('edit-cliente-documento')?.addEventListener('input', handleDocMask);
            
            // ===== Aplicar M√°scaras de Telefone =====
            document.getElementById('config-telefone')?.addEventListener('input', handleTelefoneMask);
            document.getElementById('cliente-telefone')?.addEventListener('input', handleTelefoneMask);
            document.getElementById('edit-cliente-telefone')?.addEventListener('input', handleTelefoneMask);
            
            // ===== Aplicar M√°scaras de CEP =====
            document.getElementById('config-cep')?.addEventListener('input', handleCEPMask);
            document.getElementById('cliente-cep')?.addEventListener('input', handleCEPMask);
            document.getElementById('edit-cliente-cep')?.addEventListener('input', handleCEPMask);
            document.getElementById('search-cliente')?.addEventListener('input', handleSearchCliente);
            // ===============================================

          } else {
            userId = null;
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
            loadingOverlay.style.display = 'none';
          }
        });
      } catch (e) {
        console.error('Erro ao inicializar Firebase:', e);
        loadingOverlay.innerHTML = '<p class="text-red-600">Erro cr√≠tico ao conectar. Verifique as chaves do Firebase.</p>';
      }
    }

    const loginWithGoogle = async () => {
      const provider = new GoogleAuthProvider();
      try { loadingOverlay.style.display = 'flex'; await signInWithPopup(auth, provider); }
      catch (e) { console.error(e); alert('Falha no login Google.'); loadingOverlay.style.display = 'none'; }
    };

    const logout = async () => {
      if (confirm('Tem certeza que deseja sair da sua conta?')) {
        try { await signOut(auth); } catch(e) { alert('Erro ao sair.'); }
      }
    };

    loginButton?.addEventListener('click', loginWithGoogle);
    logoutButton?.addEventListener('click', logout);

    document.getElementById('orc-cliente-select').addEventListener('change', (e) => {
      if (!appState.currentOrcamento) resetCurrentOrcamento();
      
      const clienteId = e.target.value;
      if (clienteId) {
        const cliente = appState.clientes.find(c => c.id === clienteId);
        if (cliente) {
          appState.currentOrcamento.cliente = cliente;
        } else {
          appState.currentOrcamento.cliente = null;
        }
      } else {
        appState.currentOrcamento.cliente = null;
      }
      updateOrcamentoPreview();
    });

    // ===== Carregamento reativo de dados =====
    function loadAllData() {
      if (!userId) return;
      const prefix = `users/${userId}`;

      onSnapshot(doc(db, `${prefix}/config/main`), (snap) => {
        if (snap.exists()) appState.config = snap.data();
        updateConfigForm();
      });

      onSnapshot(query(collection(db, `${prefix}/clientes`)), (snapshot) => {
        appState.clientes = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
        renderClientesList();
        renderOrcamentosList();
        renderOrcamentosList(true);
        updateFinanceiroView();
      });

      onSnapshot(query(collection(db, `${prefix}/materiais`)), (snapshot) => {
        appState.materiais = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMateriaisList();
      });

      onSnapshot(query(collection(db, `${prefix}/tiposdeservico`)), (snapshot) => {        
        appState.tiposDeServico = snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                                              .filter(s => s.descricao && s.valor > 0);
        
        renderTiposDeServicoList();
        populateCategorySelect();
      });

      onSnapshot(query(collection(db, `${prefix}/orcamentos`)), (snapshot) => {
        console.log(`[DEBUG] Recebeu ${snapshot.docs.length} or√ßamentos do Firebase.`);
        appState.orcamentos = snapshot.docs.map(d => {
          const data = d.data();
          if (data.createdAt?.toDate) data.createdAt = data.createdAt.toDate();
          console.log(`[DEBUG] Mapeando doc. ID do Firebase (d.id):`, d.id);
          return {
            ...data,
            id: d.id,
            status: data.status || (data.aprovado ? 'aprovado' : 'pendente'),
            aprovado: data.aprovado ?? (data.status === 'aprovado')
          };
        });
        appState.orcamentos.sort((a,b) => (b.numeroOrcamento||0) - (a.numeroOrcamento||0));
        
        renderOrcamentosList();
        renderOrcamentosList(true); 
        updateFinanceiroView();
      });
    }

    // ===== Config =====
    function updateConfigForm() {
      const c = appState.config || {};
      const el = (id) => document.getElementById(id);

      el('config-nome').value = c.nome || '';
      el('config-telefone').value = formatarTelefone(c.telefone || '');
      el('config-doc').value = formatarCPFCNPJ(c.doc || '');

      // NOVO: Popula campos de endere√ßo
      el('config-cep').value = formatarCEP(c.cep || '');
      el('config-numero').value = c.numero || '';
      el('config-logradouro').value = c.logradouro || '';
      el('config-bairro').value = c.bairro || '';
      el('config-cidade').value = c.cidade || '';
      el('config-uf').value = c.uf || '';

      // Atualiza campo oculto + preview da logomarca
      const logoHiddenInput = el('config-logo');
      const logoPreviewWrapper = el('config-logo-preview-wrapper');
      const logoPreview = el('config-logo-preview');

      if (logoHiddenInput) logoHiddenInput.value = c.logo || '';

      if (logoPreviewWrapper && logoPreview) {
        if (c.logo) {
          logoPreview.src = c.logo;
          logoPreviewWrapper.classList.remove('hidden');
        } else {
          logoPreview.src = '';
          logoPreviewWrapper.classList.add('hidden');
        }
      }

      el('config-color-primary').value = c.config_color_primary || '#000000';
      el('config-color-secondary').value = c.config_color_secondary || '#333333';

      el('config-residencial-empreitada').value = c.residencial_empreitada || '';
      el('config-residencial-diaria').value = c.residencial_diaria || '';
      el('config-residencial-ponto').value = c.residencial_ponto || '';
      el('config-residencial-hora').value = c.residencial_hora || '';
      el('config-industrial-diaria').value = c.industrial_diaria || '';
      el('config-industrial-ponto').value = c.industrial_ponto || '';
      el('config-industrial-hora').value = c.industrial_hora || '';

      el('config-pix-chave').value = c.config_pix_chave || '';
      el('config-cartao-vezes').value = c.config_cartao_vezes || '';
      el('config-cartao-juros').value = c.config_cartao_juros || '';
      el('config-pagamento-dinheiro').checked = c.config_pagamento_dinheiro || false;
      el('config-deposito-banco').value = c.config_deposito_banco || '';
      el('config-deposito-ag').value = c.config_deposito_ag || '';
      el('config-deposito-conta').value = c.config_deposito_conta || '';
    }

    // ===== Upload da Logomarca (arquivo -> Data URL) =====
    const logoHiddenInput = document.getElementById('config-logo');
    const logoFileInput = document.getElementById('config-logo-file');
    const logoPreviewWrapper = document.getElementById('config-logo-preview-wrapper');
    const logoPreview = document.getElementById('config-logo-preview');
    const logoClearBtn = document.getElementById('config-logo-clear');

    function applyLogoToPreview(src) {
      if (!logoHiddenInput || !logoPreviewWrapper || !logoPreview) return;

      if (src) {
        logoHiddenInput.value = src;
        logoPreview.src = src;
        logoPreviewWrapper.classList.remove('hidden');
      } else {
        logoHiddenInput.value = '';
        logoPreview.src = '';
        logoPreviewWrapper.classList.add('hidden');
      }
    }

    if (logoFileInput) {
      logoFileInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
          alert('Por favor, selecione um arquivo de imagem (PNG, JPG, etc.).');
          logoFileInput.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          applyLogoToPreview(dataUrl);
        };
        reader.onerror = () => {
          alert('N√£o foi poss√≠vel ler a imagem. Tente novamente.');
          logoFileInput.value = '';
        };
        reader.readAsDataURL(file);
      });
    }

    if (logoClearBtn) {
      logoClearBtn.addEventListener('click', () => {
        applyLogoToPreview('');
        if (logoFileInput) logoFileInput.value = '';
      });
    }

// ===== NOVO: Fun√ß√£o helper para ler valores do form =====
function getVal(id) {
    const el = document.getElementById(id);
    return el ? el.value : '';
}

    // ===== Clientes =====
    document.getElementById('form-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Fa√ßa login novamente.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      
      try {
        const data = {
            nome: getVal('cliente-nome'),
            telefone: getVal('cliente-telefone').replace(/\D/g, ''),
            documento: getVal('cliente-documento').replace(/\D/g, ''),
            numeroCadastro: gerarNovoNumeroCliente(),
            
            // NOVO: Campos de endere√ßo
            cep: getVal('cliente-cep').replace(/\D/g, ''),
            numero: getVal('cliente-numero'),
            logradouro: getVal('cliente-logradouro'),
            bairro: getVal('cliente-bairro'),
            cidade: getVal('cliente-cidade'),
            uf: getVal('cliente-uf'),
        };
        
        // Remove 'endereco' antigo se existir
        delete data.endereco;
        
        await addDoc(collection(db, `users/${userId}/clientes`), data);
        e.target.reset();
        
        // Limpa campos readonly
        document.getElementById('cliente-logradouro').value = '';
        document.getElementById('cliente-bairro').value = '';
        document.getElementById('cliente-cidade').value = '';
        document.getElementById('cliente-uf').value = '';

      } catch(e) { console.error(e); alert('Erro ao salvar cliente.'); }
      finally { btn.disabled=false; btn.textContent='Salvar Cliente'; }
    });
    
    document.getElementById('form-edit-cliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Fa√ßa login novamente.');

      const clienteId = getVal('edit-cliente-id');
      if (!clienteId) return alert('Erro: ID do cliente n√£o encontrado.');

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';

      try {
        const data = {
          nome: getVal('edit-cliente-nome'),
          numeroCadastro: getVal('edit-cliente-numerocadastro'),
          telefone: getVal('edit-cliente-telefone').replace(/\D/g, ''),
          documento: getVal('edit-cliente-documento').replace(/\D/g, ''),
          
          // NOVO: Campos de endere√ßo
          cep: getVal('edit-cliente-cep').replace(/\D/g, ''),
          numero: getVal('edit-cliente-numero'),
          logradouro: getVal('edit-cliente-logradouro'),
          bairro: getVal('edit-cliente-bairro'),
          cidade: getVal('edit-cliente-cidade'),
          uf: getVal('edit-cliente-uf'),
        };

        const originalCliente = appState.clientes.find(c => c.id === clienteId);
        
        // Remove 'endereco' antigo
        delete data.endereco;

        await setDoc(doc(db, `users/${userId}/clientes/${clienteId}`), data);

        alert('Cliente atualizado com sucesso!');
        closeEditClienteModal();
      } catch(e) {
        console.error(e); 
        alert('Erro ao atualizar cliente.'); 
      } finally { 
        btn.disabled=false; 
        btn.textContent='Salvar Altera√ß√µes'; 
      }
    });
    
    // NOVO: Helper para formatar endere√ßo completo
    function formatarEnderecoCompleto(cliente) {
        if (!cliente) return 'Endere√ßo n√£o informado';
        // Se ainda tiver o 'endereco' antigo (legado)
        if (cliente.endereco) return cliente.endereco;
        
        // Novo formato
        if (!cliente.logradouro && !cliente.cidade) return 'Endere√ßo n√£o informado';
        
        const rua = cliente.logradouro || '';
        const num = cliente.numero || 's/n';
        const bairro = cliente.bairro || '';
        const cidade = cliente.cidade || '';
        const uf = cliente.uf || '';
        
        return `${rua}, ${num} - ${bairro} - ${cidade}/${uf}`;
    }
    
    function renderClientesList() {
      const el = document.getElementById('clientes-list');
      if (!appState.clientes.length) { el.innerHTML = '<p class="text-gray-500">Nenhum cliente cadastrado.</p>'; return; }
      
      el.innerHTML = appState.clientes.map(c => {
        // NOVO: Usa a fun√ß√£o helper de endere√ßo
        const enderecoFormatado = formatarEnderecoCompleto(c);
        const { label: docLabel, valor: docValor } = getLabelEValorDoc(c.documento);

        return `
        <div class="flex justify-between items-center p-2 border rounded-md">
          <div class="flex-grow cursor-pointer" onclick="openEditClienteModal('${c.id}')">
            <p class="font-medium">${c.nome} <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">${c.numeroCadastro||''}</span></p>
            <p class="text-sm text-gray-600">${formatarTelefone(c.telefone)} | ${enderecoFormatado}</p>
            ${c.documento ? `<p class="text-xs text-gray-500">${docLabel} ${docValor}</p>` : ''}
          </div>
          <button onclick="deleteCliente('${c.id}')" class="text-red-500 hover:text-red-700 text-2xl ml-3 flex-shrink-0">&times;</button>
        </div>`
      }).join('');
    }

    window.deleteCliente = async (id) => {
      if (confirm('Excluir este cliente?')) { await deleteDoc(doc(db, `users/${userId}/clientes/${id}`)); }
    };

    window.openEditClienteModal = (id) => {
      try {
        const cliente = appState.clientes.find(c => c.id === id);
        if (!cliente) throw new Error('Cliente n√£o encontrado no appState.');

        const modalEl = document.getElementById('edit-cliente-modal');
        if (!modalEl) throw new Error("Elemento 'edit-cliente-modal' n√£o foi encontrado!");

        // Helper para preencher
        const setVal = (elId, valor, formatFunc = null) => {
            const el = document.getElementById(elId);
            if (el) el.value = formatFunc ? formatFunc(valor || '') : (valor || '');
        };

        setVal('edit-cliente-id', cliente.id);
        setVal('edit-cliente-nome', cliente.nome);
        setVal('edit-cliente-numerocadastro', cliente.numeroCadastro);
        setVal('edit-cliente-telefone', cliente.telefone, formatarTelefone);
        setVal('edit-cliente-documento', cliente.documento, formatarCPFCNPJ);
        
        // NOVO: Preenche campos de endere√ßo
        setVal('edit-cliente-cep', cliente.cep, formatarCEP);
        setVal('edit-cliente-numero', cliente.numero);
        setVal('edit-cliente-logradouro', cliente.logradouro);
        setVal('edit-cliente-bairro', cliente.bairro);
        setVal('edit-cliente-cidade', cliente.cidade);
        setVal('edit-cliente-uf', cliente.uf);
        
        modalEl.classList.add('active');

      } catch (e) {
        console.error("[ERRO CR√çTICO] Falha ao abrir o modal de edi√ß√£o:", e.message);
        alert("Ocorreu um erro ao tentar abrir a edi√ß√£o. Verifique o console (F12).");
      }
    };

    window.closeEditClienteModal = () => {
      document.getElementById('edit-cliente-modal').classList.remove('active');
      document.getElementById('form-edit-cliente').reset();
    };

    // ===== Materiais =====
document.getElementById('form-material').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Fa√ßa login.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; 
      try {
        const nome = document.getElementById('material-nome').value;
        const valor = parseFloat(document.getElementById('material-valor').value);
        const unidade = document.getElementById('material-unidade').value;
        // Verifica se √© estoque
        const isEstoque = document.getElementById('material-is-estoque').checked;
        
        await addDoc(collection(db, `users/${userId}/materiais`), { 
            nome, valor, unidade, 
            tipo: isEstoque ? 'estoque' : 'padrao' // Salva o tipo
        });
        e.target.reset();
      } catch(e) { console.error(e); alert('Erro ao salvar item.'); }
      finally { btn.disabled=false; }
    });

    document.getElementById('form-edit-material').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Fa√ßa login novamente.');
      const materialId = document.getElementById('edit-material-id').value;
      if (!materialId) return alert('Erro: ID do material n√£o encontrado.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        const data = {
          nome: document.getElementById('edit-material-nome').value,
          unidade: document.getElementById('edit-material-unidade').value,
          valor: parseFloat(document.getElementById('edit-material-valor').value) || 0,
        };
        await setDoc(doc(db, `users/${userId}/materiais/${materialId}`), data);
        alert('Material atualizado com sucesso!');
        closeEditMaterialModal();
      } catch(e) { console.error(e); alert('Erro ao atualizar material.'); }
      finally { btn.disabled=false; btn.textContent='Salvar Altera√ß√µes'; }
    });

  function renderMateriaisList() {
      const elPadrao = document.getElementById('materiais-list-padrao');
      const elEstoque = document.getElementById('materiais-list-estoque');
      
      if (!elPadrao || !elEstoque) return; // Seguran√ßa

      const lista = appState.materiais || [];
      
      const padraoItems = lista.filter(m => m.tipo !== 'estoque');
      const estoqueItems = lista.filter(m => m.tipo === 'estoque');

      const criarHTML = (itens) => {
          if(!itens.length) return '<p class="text-gray-500 text-xs p-2">Vazio.</p>';
          return itens.map(m => `
            <div class="flex justify-between items-center p-2 border-b last:border-0 hover:bg-gray-50">
              <div class="flex-grow cursor-pointer" onclick="openEditMaterialModal('${m.id}')">
                <p class="servico-slim text-sm">
                    ${m.tipo === 'estoque' ? '<span class="text-blue-600 font-bold">#</span> ' : ''}
                    <strong>${m.nome}</strong> (${m.unidade || 'UNID'}) ‚Äî R$ ${m.valor.toFixed(2)}
                </p>
              </div>
              <button onclick="deleteMaterial('${m.id}')" class="text-red-500 hover:text-red-700 font-bold px-2">&times;</button>
            </div>`).join('');
      };

      elPadrao.innerHTML = criarHTML(padraoItems);
      elEstoque.innerHTML = criarHTML(estoqueItems);
    }

    window.deleteMaterial = async (id) => {
      if (confirm('Excluir este item?')) { await deleteDoc(doc(db, `users/${userId}/materiais/${id}`)); }
    };

    window.openEditMaterialModal = (id) => {
      try {
        const material = appState.materiais.find(m => m.id === id);
        if (!material) throw new Error('Material n√£o encontrado no appState.');
        const modalEl = document.getElementById('edit-material-modal'); if (!modalEl) throw new Error("Elemento 'edit-material-modal' n√£o foi encontrado!");
        const idInput = document.getElementById('edit-material-id'); if (!idInput) throw new Error("Elemento 'edit-material-id' n√£o foi encontrado!");
        const nomeInput = document.getElementById('edit-material-nome'); if (!nomeInput) throw new Error("Elemento 'edit-material-nome' n√£o foi encontrado!");
        const unInput = document.getElementById('edit-material-unidade'); if (!unInput) throw new Error("Elemento 'edit-material-unidade' n√£o foi encontrado!");
        const valInput = document.getElementById('edit-material-valor'); if (!valInput) throw new Error("Elemento 'edit-material-valor' n√£o foi encontrado!");
        idInput.value = material.id; nomeInput.value = material.nome || ''; unInput.value = material.unidade || 'UNID'; valInput.value = material.valor || 0;
        modalEl.classList.add('active');
      } catch (e) { console.error("[ERRO CR√çTICO] Falha ao abrir o modal de edi√ß√£o material:", e.message); alert("Ocorreu um erro ao tentar abrir a edi√ß√£o de material. Verifique o console (F12)."); }
    };
    window.closeEditMaterialModal = () => { document.getElementById('edit-material-modal').classList.remove('active'); document.getElementById('form-edit-material').reset(); };


    // ===== Tipos de Servi√ßo com Categoria & Submenu (AGORA EM #servicos) =====
    const catSelect = document.getElementById('tiposervico-categoria-select');
    const catNew = document.getElementById('tiposervico-categoria-new');

    function populateCategorySelect() {
      while (catSelect.options.length > 2) catSelect.remove(2);
      const cats = [...new Set(appState.tiposDeServico.map(s => s.categoria).filter(Boolean))].sort();
      cats.forEach(cat => { const o=document.createElement('option'); o.value=cat; o.textContent=cat; catSelect.appendChild(o); });
    }

    catSelect.addEventListener('change', () => {
      if (catSelect.value === 'new_category') { catNew.classList.remove('hidden'); catNew.focus(); }
      else { catNew.classList.add('hidden'); }
    });

    document.getElementById('form-tiposervico').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Fa√ßa login novamente.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        let categoria = (catSelect.value === 'new_category') ? (catNew.value||'').trim() : (catSelect.value||'').trim();
        categoria = categoria ? categoria.toUpperCase() : 'OUTROS';
        const descricao = document.getElementById('tiposervico-descricao').value;
        const valor = parseFloat(document.getElementById('tiposervico-valor').value);
        if (!categoria || !descricao || isNaN(valor)) throw new Error('Preencha categoria, descri√ß√£o e valor.');
        if (valor <= 0) throw new Error('O valor deve ser maior que zero.');
        
        await addDoc(collection(db, `users/${userId}/tiposdeservico`), { descricao, valor, categoria });
        e.target.reset();
        catNew.classList.add('hidden');
        catSelect.value='';
      } catch(e) { console.error(e); alert('Erro ao salvar tipo de servi√ßo: ' + e.message); }
      finally { btn.disabled=false; btn.textContent='Salvar'; }
    });

    document.getElementById('form-edit-tiposervico').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!userId) return alert('Fa√ßa login novamente.');
      const tipoServicoId = document.getElementById('edit-tiposervico-id').value;
      if (!tipoServicoId) return alert('Erro: ID do tipo de servi√ßo n√£o encontrado.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent='Salvando...';
      try {
        const categoria = document.getElementById('edit-tiposervico-categoria').value.toUpperCase().trim() || 'OUTROS';
        const descricao = document.getElementById('edit-tiposervico-descricao').value;
        const valor = parseFloat(document.getElementById('edit-tiposervico-valor').value);
        if (!categoria || !descricao || isNaN(valor) || valor <= 0) throw new Error('Preencha categoria, descri√ß√£o e um valor v√°lido maior que zero.');
        const data = { categoria, descricao, valor };
        await setDoc(doc(db, `users/${userId}/tiposdeservico/${tipoServicoId}`), data);
        alert('Tipo de servi√ßo atualizado com sucesso!');
        closeEditTipoServicoModal();
      } catch(e) { console.error(e); alert('Erro ao atualizar tipo de servi√ßo: ' + e.message); }
      finally { btn.disabled=false; btn.textContent='Salvar Altera√ß√µes'; }
    });

    function groupBy(arr, key) { return arr.reduce((acc,cur)=>{ const k=cur[key]||'OUTROS'; (acc[k]||(acc[k]=[])).push(cur); return acc; },{}); }

    function renderTiposDeServicoList() {
      const el = document.getElementById('tiposdeservico-list');
      if (!appState.tiposDeServico.length) { el.innerHTML = '<p class="text-gray-500">Nenhum tipo de servi√ßo cadastrado.</p>'; return; }
      const byCat = groupBy(appState.tiposDeServico, 'categoria');
      const cats = Object.keys(byCat).sort();
      el.innerHTML = cats.map(cat => {
        const servicos = byCat[cat].sort((a,b) => (a.descricao || '').localeCompare(b.descricao || ''));
        return `
          <details class="border rounded-md mb-2">
            <summary class="flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-gray-100">
              <span class="text-sm font-medium text-gray-800">${cat}</span>
              <svg class="w-4 h-4 arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </summary>
            <div class="p-2 space-y-1">
              ${
                servicos.map(s => `
                  <div class="flex justify-between items-center p-1 border-b border-gray-100">
                    <div class="flex-grow cursor-pointer" onclick="openEditTipoServicoModal('${s.id}')">
                       <p class="servico-slim">${s.descricao} ‚Äî <span class="text-gray-700">R$ ${s.valor.toFixed(2)}</span></p>
                    </div>
                    <button onclick="deleteTipoDeServico('${s.id}')" class="text-red-500 hover:text-red-700 text-xl leading-none ml-3 flex-shrink-0">&times;</button>
                  </div>
                `).join('')
              }
            </div>
          </details>`;
      }).join('');
    }

    window.deleteTipoDeServico = async (id) => {
      if (confirm('Excluir este tipo de servi√ßo?')) { await deleteDoc(doc(db, `users/${userId}/tiposdeservico/${id}`)); }
    };

    window.openEditTipoServicoModal = (id) => {
      try {
        const servico = appState.tiposDeServico.find(s => s.id === id);
        if (!servico) throw new Error('Tipo de servi√ßo n√£o encontrado no appState.');
        const modalEl = document.getElementById('edit-tiposervico-modal'); if (!modalEl) throw new Error("Elemento 'edit-tiposervico-modal' n√£o foi encontrado!");
        const idInput = document.getElementById('edit-tiposervico-id'); if (!idInput) throw new Error("Elemento 'edit-tiposervico-id' n√£o foi encontrado!");
        const catInput = document.getElementById('edit-tiposervico-categoria'); if (!catInput) throw new Error("Elemento 'edit-tiposervico-categoria' n√£o foi encontrado!");
        const descInput = document.getElementById('edit-tiposervico-descricao'); if (!descInput) throw new Error("Elemento 'edit-tiposervico-descricao' n√£o foi encontrado!");
        const valInput = document.getElementById('edit-tiposervico-valor'); if (!valInput) throw new Error("Elemento 'edit-tiposervico-valor' n√£o foi encontrado!");
        idInput.value = servico.id; catInput.value = servico.categoria || 'OUTROS'; descInput.value = servico.descricao || ''; valInput.value = servico.valor || 0;
        modalEl.classList.add('active');
      } catch (e) { console.error("[ERRO CR√çTICO] Falha ao abrir o modal de edi√ß√£o de servi√ßo:", e.message); alert("Ocorreu um erro ao tentar abrir a edi√ß√£o de servi√ßo. Verifique o console (F12)."); }
    };
    window.closeEditTipoServicoModal = () => { document.getElementById('edit-tiposervico-modal').classList.remove('active'); document.getElementById('form-edit-tiposervico').reset(); };


    // ===== Importar Excel (Servi√ßos) =====
    document.getElementById('btn-import-xlsx').addEventListener('click', async () => {
      const inp = document.getElementById('xlsx-input');
      const status = document.getElementById('xlsx-status');
      if (!inp.files || !inp.files[0]) { alert('Selecione um arquivo .xlsx'); return; }
      const f = inp.files[0];
      try {
        status.textContent = 'Lendo planilha...';
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

        const norm = (s) => String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
        const headerMapCandidates = {
          categoria: ['categoria','grupo','setor'],
          descricao: ['descricao','descri√ß√£o','servico','servi√ßo','atividade','item'],
          valor: ['valor','preco','pre√ßo','price']
        };

        const keys = rows.length ? Object.keys(rows[0]) : [];
        const colMap = { categoria: null, descricao: null, valor: null };
        keys.forEach(k => {
          const nk = norm(k);
          for (const fld of Object.keys(headerMapCandidates)) {
            if (headerMapCandidates[fld].some(alias => nk.includes(alias))) colMap[fld] = k;
          }
        });

        if (!colMap.categoria || !colMap.descricao || !colMap.valor) {
          alert('N√£o encontrei colunas suficientes. Garanta que a planilha tenha: Categoria, Descri√ß√£o e Valor.');
          return;
        }

        const prefix = `users/${userId}`;
        const batch = writeBatch(db);
        let count = 0;

        rows.forEach(r => {
          const categoria = String(r[colMap.categoria]||'').toUpperCase().trim() || 'OUTROS';
          const descricao = String(r[colMap.descricao]||'').trim();
          const rawValor = (r[colMap.valor] ?? '').toString().replace(',', '.').replace(/\s/g,'');
          const valor = parseFloat(rawValor) || 0;
          if (!categoria || !descricao || !valor) return;
          const ref = doc(collection(db, `${prefix}/tiposdeservico`));
          batch.set(ref, { categoria, descricao, valor });
          count++;
        });

        if (!count) { alert('Nenhuma linha v√°lida encontrada.'); return; }
        status.textContent = 'Enviando para o banco...';
        await batch.commit();
        status.textContent = `Importa√ß√£o conclu√≠da: ${count} itens adicionados.`;
      } catch(e) {
        console.error(e);
        alert('Erro ao importar planilha.');
      }
    });

    async function clearAllTiposDeServico() {
      if (!userId) return alert('Fa√ßa login.');
      if (!confirm('ATEN√á√ÉO!\n\nIsso apagar√° TODOS os Tipos de Servi√ßo cadastrados. Deseja continuar?')) return;
      
      const status = document.getElementById('xlsx-status');
      status.textContent = 'Apagando todos os servi√ßos...';
      try {
        const prefix = `users/${userId}`;
        const ref = collection(db, `${prefix}/tiposdeservico`);
        const snapshot = await getDocs(ref);
        
        if (snapshot.empty) {
          status.textContent = 'Nenhum servi√ßo para apagar.';
          return;
        }
        
        const batch = writeBatch(db);
        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();
        
        status.textContent = `Todos os ${snapshot.size} servi√ßos foram apagados.`;
      } catch(e) {
        console.error(e);
        status.textContent = 'Erro ao apagar os servi√ßos.';
        alert('Erro ao apagar.');
      }
    }
    document.getElementById('btn-clear-tiposervico').addEventListener('click', clearAllTiposDeServico);

    // ADICIONADO: Se√ß√£o de Importar/Limpar Materiais
    // IMPORTA√á√ÉO DE MATERIAIS COM COLUNA DE ESTOQUE
    document.getElementById('btn-import-materiais-xlsx').addEventListener('click', async () => {
        const inp = document.getElementById('materiais-xlsx-input');
        const status = document.getElementById('materiais-xlsx-status');
        if (!inp.files || !inp.files[0]) { alert('Selecione um arquivo .xlsx para materiais.'); return; }
        
        const f = inp.files[0];
        try {
            status.textContent = 'Lendo planilha...';
            const buf = await f.arrayBuffer(); 
            const wb = XLSX.read(buf, { type:'array' }); 
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
            
            const norm = (s) => String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
            
            // MAPA DE COLUNAS (Adicionado 'estoque')
            const headerMapCandidates = { 
                nome: ['descricao','descri√ß√£o','material','item'], 
                unidade: ['unidade','unid','und'], 
                valor: ['valor','preco','pre√ßo','price'],
                estoque: ['estoque', 'tipo', 'categoria'] // Procura por estas palavras no cabe√ßalho
            };
            
            const keys = rows.length ? Object.keys(rows[0]) : [];
            const colMap = { nome: null, unidade: null, valor: null, estoque: null };
            
            keys.forEach(k => { 
                const nk = norm(k); 
                for (const fld of Object.keys(headerMapCandidates)) { 
                    if (headerMapCandidates[fld].some(alias => nk.includes(alias))) colMap[fld] = k; 
                } 
            });
            
            if (!colMap.nome || !colMap.valor) throw new Error('Colunas obrigat√≥rias n√£o encontradas: Descri√ß√£o e Valor.');
            
            const prefix = `users/${userId}`; 
            const batch = writeBatch(db); 
            let count = 0;
            
            rows.forEach(r => {
                const nome = String(r[colMap.nome]||'').trim();
                const unidade = String(r[colMap.unidade]||'').trim().toUpperCase() || 'UNID';
                const rawValor = (r[colMap.valor] ?? '').toString().replace(',', '.').replace(/\s/g,'');
                const valor = parseFloat(rawValor) || 0;
                
                // L√ìGICA DE ESTOQUE
                let tipo = 'padrao';
                if (colMap.estoque) {
                    const valEstoque = String(r[colMap.estoque]||'').toUpperCase().trim();
                    // Se estiver escrito SIM, S, ESTOQUE ou YES, vira estoque
                    if (['SIM', 'S', 'ESTOQUE', 'YES', 'X'].includes(valEstoque)) {
                        tipo = 'estoque';
                    }
                }

                if (!nome || isNaN(valor) || valor <= 0) return;
                
                const ref = doc(collection(db, `${prefix}/materiais`)); 
                batch.set(ref, { nome, unidade, valor, tipo }); 
                count++;
            });
            
            if (!count) { alert('Nenhuma linha v√°lida encontrada.'); return; }
            status.textContent = 'Enviando...'; 
            await batch.commit();
            status.textContent = `Sucesso! ${count} itens importados.`; 
            inp.value = '';
            
        } catch(e) { 
            console.error(e); 
            alert('Erro na importa√ß√£o: ' + e.message); 
            status.textContent = 'Falha.'; 
        }
    });
    
    async function clearAllMateriais() {
        if (!userId) return alert('Fa√ßa login.');
        if (!confirm('ATEN√á√ÉO!\n\nIsso apagar√° TODOS os Materiais cadastrados. Deseja continuar?')) return;
        const status = document.getElementById('materiais-xlsx-status');
        status.textContent = 'Apagando todos os materiais...';
        try {
            const prefix = `users/${userId}`; const ref = collection(db, `${prefix}/materiais`); const snapshot = await getDocs(ref);
            if (snapshot.empty) { status.textContent = 'Nenhum material para apagar.'; return; }
            const batch = writeBatch(db); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit();
            status.textContent = `Todos os ${snapshot.size} materiais foram apagados.`;
        } catch(e) { console.error(e); status.textContent = 'Erro ao apagar os materiais.'; alert('Erro ao apagar materiais.'); }
    }
    document.getElementById('btn-clear-materiais').addEventListener('click', clearAllMateriais);

    // ==========================================================
    // NOVO BLOCO: IMPORTAR / LIMPAR CLIENTES
    // ==========================================================
    
    document.getElementById('btn-import-clientes-xlsx')?.addEventListener('click', async () => {
        const inp = document.getElementById('clientes-xlsx-input');
        const status = document.getElementById('clientes-xlsx-status');
        if (!inp.files || !inp.files[0]) { alert('Selecione um arquivo .xlsx para clientes.'); return; }
        const f = inp.files[0];
        
        try {
            status.textContent = 'Lendo planilha de clientes...';
            const buf = await f.arrayBuffer();
            const wb = XLSX.read(buf, { type:'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
            
            // Mapeamento flex√≠vel de colunas
            const norm = (s) => String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
            const headerMapCandidates = {
                nome: ['nome', 'cliente', 'razao social'],
                telefone: ['telefone', 'fone', 'celular'],
                documento: ['documento', 'cpf', 'cnpj'],
                cep: ['cep'],
                numero: ['numero', 'num'],
                logradouro: ['logradouro', 'rua', 'endereco'],
                bairro: ['bairro'],
                cidade: ['cidade'],
                uf: ['uf', 'estado']
            };
            
            const keys = rows.length ? Object.keys(rows[0]) : [];
            const colMap = {};
            Object.keys(headerMapCandidates).forEach(field => colMap[field] = null);

            keys.forEach(k => {
                const nk = norm(k);
                for (const field of Object.keys(headerMapCandidates)) {
                    if (headerMapCandidates[field].some(alias => nk.includes(alias))) {
                        colMap[field] = k;
                    }
                }
            });

            if (!colMap.nome || !colMap.telefone) {
                throw new Error('Planilha inv√°lida. Colunas m√≠nimas necess√°rias: Nome, Telefone.');
            }

            const prefix = `users/${userId}`;
            const batch = writeBatch(db);
            let count = 0;

            // L√≥gica para gerar IDs sequenciais √∫nicos dentro deste lote
            const agora = new Date();
            const mes = (agora.getMonth() + 1).toString().padStart(2, '0'); // MM
            const ano = agora.getFullYear().toString().slice(-2); // YY
            
            // Pega o ID sequencial m√°ximo ATUAL
            let maxSeq = 0;
            appState.clientes.map(c => c.numeroCadastro).filter(id => id && id.startsWith('CL')).forEach(id => {
                let seqNum = 0;
                const numPart = id.substring(2); 
                if (numPart.length === 7) seqNum = parseInt(numPart.substring(0, 3), 10);
                else if (numPart.length === 4) seqNum = parseInt(numPart, 10);
                else if (numPart.length === 6) seqNum = parseInt(numPart.substring(0, 2), 10);
                if (!isNaN(seqNum) && seqNum > maxSeq) maxSeq = seqNum;
            });

            rows.forEach(r => {
                const nome = String(r[colMap.nome] || '').trim();
                if (!nome) return; // Pula linha se n√£o tiver nome

                // Incrementa o ID para este novo cliente
                maxSeq++;
                const proximoSeq = maxSeq.toString().padStart(3, '0');
                const novoID = `CL${proximoSeq}${mes}${ano}`;

                const data = {
                    nome: nome,
                    telefone: String(r[colMap.telefone] || '').replace(/\D/g, ''),
                    documento: String(r[colMap.documento] || '').replace(/\D/g, ''),
                    cep: String(r[colMap.cep] || '').replace(/\D/g, ''),
                    numero: String(r[colMap.numero] || ''),
                    logradouro: String(r[colMap.logradouro] || ''),
                    bairro: String(r[colMap.bairro] || ''),
                    cidade: String(r[colMap.cidade] || ''),
                    uf: String(r[colMap.uf] || ''),
                    numeroCadastro: novoID
                };
                
                const ref = doc(collection(db, `${prefix}/clientes`));
                batch.set(ref, data);
                count++;
            });

            if (!count) {
                alert('Nenhuma linha v√°lida (com "Nome") foi encontrada na planilha.');
                return;
            }
            
            status.textContent = `Enviando ${count} clientes para o banco...`;
            await batch.commit();
            status.textContent = `Importa√ß√£o de clientes conclu√≠da: ${count} clientes adicionados.`;
            inp.value = '';
        } catch(e) {
            console.error(e);
            alert('Erro ao importar planilha de clientes: ' + e.message);
            status.textContent = 'Falha na importa√ß√£o de clientes.';
        }
    });
    
    async function clearAllClientes() {
        if (!userId) return alert('Fa√ßa login.');
        if (!confirm('ATEN√á√ÉO M√ÅXIMA!\n\nIsso apagar√° TODOS os Clientes cadastrados. Esta a√ß√£o √© irrevers√≠vel. Deseja continuar?')) return;
        
        const status = document.getElementById('clientes-xlsx-status');
        status.textContent = 'Apagando todos os clientes...';
        try {
            const prefix = `users/${userId}`;
            const ref = collection(db, `${prefix}/clientes`);
            const snapshot = await getDocs(ref);
            
            if (snapshot.empty) {
                status.textContent = 'Nenhum cliente para apagar.';
                return;
            }
            
            const batch = writeBatch(db);
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            
            status.textContent = `Todos os ${snapshot.size} clientes foram apagados.`;
        } catch(e) {
            console.error(e);
            status.textContent = 'Erro ao apagar os clientes.';
            alert('Erro ao apagar clientes.');
        }
    }
    document.getElementById('btn-clear-clientes')?.addEventListener('click', clearAllClientes);

    // ==========================================================
    // FIM DO NOVO BLOCO
    // ==========================================================


    // ===== Or√ßamentos (lista / modal etc.) =====
    function updateDeleteButtonState() {
        const btn = document.getElementById('btn-delete-selected-orcamentos');
        if (btn) {
            btn.disabled = appState.orcamentosParaExcluir.size === 0;
        }
    }
function renderOrcamentosList(isFullList = false) {
  const el = isFullList
    ? document.getElementById('all-orcamentos-list')
    : document.getElementById('orcamentos-list-recent');

  if (!el) return;

  let list = [...appState.orcamentos];

  if (isFullList) {
    const statusFiltro = document.getElementById('filtro-status-orcamento')?.value || 'todos';
    const mesFiltro = document.getElementById('filtro-mes-orcamento')?.value || 'todos';
    const anoFiltro = document.getElementById('filtro-ano-orcamento')?.value || 'todos';

    list = list.filter(orc => {
      let st = (orc.status || (orc.aprovado ? 'aprovado' : 'pendente')).toLowerCase();
      if (statusFiltro !== 'todos' && st !== statusFiltro) return false;

      if (!orc.createdAt) return true;
      const d = new Date(orc.createdAt);
      const mes = d.getMonth().toString();
      const ano = d.getFullYear().toString();

      if (mesFiltro !== 'todos' && mes !== mesFiltro) return false;
      if (anoFiltro !== 'todos' && ano !== anoFiltro) return false;

      return true;
    });
  } else {
    // TELA INICIAL ‚Üí s√≥ os 3 mais recentes
    list = list.slice(0, 3);
  }

  if (!list.length) {
    el.innerHTML = `
      <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center w-full">
        <p class="text-sm text-gray-500">Nenhum or√ßamento encontrado.</p>
      </div>
    `;
    if (isFullList) updateDeleteButtonState();
    return;
  }

  el.innerHTML = list.map(orc => {
    const cliente = appState.clientes.find(c => c.id === orc.cliente?.id);
    const numeroSeq = String(orc.numeroOrcamento || '').padStart(3, '0');
    const date = orc.createdAt || new Date();
    const anoFull = (new Date(date)).getFullYear();
    const codigoCliente = cliente?.numeroCadastro || 'SEM-COD';
    const codigoOrcamento = `${codigoCliente}-${numeroSeq}/${anoFull}`;
    const total = Number(orc.total || 0);
    const valorOrc = (total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const d = new Date(date);
    const dateStr = d.toLocaleDateString('pt-BR');

    const nome = cliente ? cliente.nome : 'Cliente Exclu√≠do';
    const partesNome = nome.split(' ');
    const nomeAbreviado = partesNome[0] || nome;
    const isMobile = window.innerWidth <= 640;
    const nomeParaExibir = isMobile ? nomeAbreviado : nome;

    let statusValue = (orc.status || (orc.aprovado ? 'aprovado' : 'pendente')).toLowerCase();
    
    // --- LISTA COMPLETA (Visual Novo) ---
    if (isFullList) {
      const isChecked = appState.orcamentosParaExcluir.has(orc.id);

      return `
        <div class="bg-white p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center w-full gap-4 border border-gray-100 hover:shadow-md transition-shadow">
          <div class="flex items-start gap-3 flex-1 w-full">
            <label class="flex items-start cursor-pointer flex-1">
              <input type="checkbox" data-id="${orc.id}" ${isChecked ? 'checked' : ''} onchange="toggleOrcamentoExclusao(this)" class="h-5 w-5 mt-1 text-red-600 border-gray-300 rounded focus:ring-red-500 flex-shrink-0">
              <div class="ml-3 flex-1">
                <p class="orcamento-nome font-bold text-lg text-gray-800">${nomeParaExibir}</p>
                <p class="text-xs text-gray-500">${codigoOrcamento} ‚Ä¢ ${dateStr}</p>
                <div class="mt-2">
                  <span class="inline-block text-base font-bold text-gray-900 bg-gray-50 border border-gray-200 rounded px-3 py-1">
                    ${valorOrc}
                  </span>
                </div>
              </div>
            </label>
          </div>

          <div class="flex flex-row sm:flex-col items-center sm:items-end gap-3 w-full sm:w-auto justify-between sm:justify-end">
            <div class="flex flex-col items-end">
               <span class="text-[10px] font-bold text-gray-400 uppercase mb-1 hidden sm:block">STATUS</span>
               <select onchange="changeOrcamentoStatus(this)" data-id="${orc.id}" class="block w-36 rounded-md border-gray-300 bg-white py-1.5 text-xs font-semibold text-gray-700 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 cursor-pointer border">
                  <option value="pendente" ${statusValue === 'pendente' ? 'selected' : ''}>PENDENTE</option>
                  <option value="aprovado" ${statusValue === 'aprovado' ? 'selected' : ''}>‚úÖ APROVADO</option>
                  <option value="concluido" ${statusValue === 'concluido' ? 'selected' : ''}>üèÅ CONCLU√çDO</option>
                  <option value="faturado" ${statusValue === 'faturado' ? 'selected' : ''}>üí≤ FATURADO</option>
               </select>
            </div>

            <button onclick="editOrcamento('${orc.id}')" class="group flex items-center justify-center w-10 h-10 rounded-lg border border-gray-200 bg-white text-gray-500 shadow-sm hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-all" title="Editar or√ßamento">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    // --- TELA INICIAL (Visual Novo) ---
    let statusClass = 'bg-gray-100 text-gray-800';
    if (statusValue === 'aprovado') statusClass = 'bg-green-100 text-green-800 border-green-200';
    else if (statusValue === 'concluido') statusClass = 'bg-blue-100 text-blue-800 border-blue-200';
    else if (statusValue === 'faturado') statusClass = 'bg-purple-100 text-purple-800 border-purple-200';
    else statusClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';

    return `
      <div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center w-full border border-gray-100 hover:border-blue-200 transition-colors">
        <div class="flex-grow mr-2">
          <p class="orcamento-nome font-medium text-base text-gray-800 truncate">${nomeParaExibir}</p>
          <p class="text-xs text-gray-500">${codigoOrcamento} ‚Ä¢ ${dateStr}</p>
          <div class="mt-1">
            <span class="inline-block text-sm font-semibold text-gray-900">
              ${valorOrc}
            </span>
          </div>
        </div>
        <div class="flex flex-col items-end gap-2 flex-shrink-0">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase border ${statusClass}">
            ${statusValue}
          </span>
          <button onclick="editOrcamento('${orc.id}')" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-50 text-gray-500 hover:bg-blue-600 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
        </div>
      </div>
    `;
  }).join('');

  if (isFullList) updateDeleteButtonState();
}
    
window.toggleOrcamentoExclusao = (checkbox) => {
        const id = checkbox.dataset.id;
        console.log(`[DEBUG-CLICK] Checkbox clicado! ID lido do HTML (data-id):`, id);
        if (checkbox.checked) {
            appState.orcamentosParaExcluir.add(id);
        } else {
            appState.orcamentosParaExcluir.delete(id);
        }
        updateDeleteButtonState();
    };

    window.confirmDeleteSelectedOrcamentos = () => {
        const count = appState.orcamentosParaExcluir.size;
        if (count === 0) {
            alert('Nenhum or√ßamento selecionado para exclus√£o.');
            return;
        }
        const modal = document.getElementById('delete-confirm-modal');
        const messageEl = document.getElementById('delete-confirm-message');
        messageEl.innerHTML = `ATEN√á√ÉO! Voc√™ ir√° excluir **${count}** or√ßamento(s) selecionado(s). Esta a√ß√£o √© irrevers√≠vel. Deseja continuar?`;
        modal.classList.add('active');
    };

    window.closeDeleteConfirmModal = (confirmAction) => {
        const modal = document.getElementById('delete-confirm-modal');
        modal.classList.remove('active');
        if (confirmAction) {
             deleteOrcamentosEmLote(Array.from(appState.orcamentosParaExcluir));
        }
    };

    async function deleteOrcamentosEmLote(ids) {
      if (!userId) {
        console.error('ERRO DE EXCLUS√ÉO: userId n√£o est√° definido.');
        alert('Falha cr√≠tica na autentica√ß√£o (userId ausente). Por favor, saia e entre novamente.');
        return;
      }
      const btn = document.getElementById('btn-delete-selected-orcamentos');
      btn.disabled = true;
      try {
        const batch = writeBatch(db);
        console.log(`Iniciando exclus√£o em lote para ${ids.length} IDs. userId: ${userId}`);
        ids.forEach(id => {
            const docPath = `users/${userId}/orcamentos/${id}`;
            const docRef = doc(db, docPath);
            batch.delete(docRef);
            console.log(`Adicionado √† exclus√£o: ${docPath}`);
        });
        await batch.commit();
        appState.orcamentosParaExcluir.clear();
        alert(`${ids.length} or√ßamento(s) exclu√≠do(s) com sucesso.`);
      } catch (e) {
        console.error('ERRO CR√çTICO ao excluir or√ßamentos em lote. Erro retornado:', e);
        alert(`Erro ao excluir ${ids.length} or√ßamento(s). Poss√≠vel falha nas Regras de Seguran√ßa (Permission Denied). Detalhe: ${e.message}`);
      } finally {
        btn.disabled = false;
        updateDeleteButtonState();
      }
    };

    window.showAllOrcamentosPage = () => {
      mainView.classList.add('hidden');
      allOrcamentosView.classList.remove('hidden');
      renderOrcamentosList(true);
    };
    window.showMainPage = () => {
      allOrcamentosView.classList.add('hidden');
      mainView.classList.remove('hidden');
      appState.orcamentosParaExcluir.clear();
      updateDeleteButtonState();
    };

    window.editOrcamento = (id) => {
      console.log("Tentando editar ID:", id, `(tipo: ${typeof id})`);
      if (!appState.orcamentos || appState.orcamentos.length === 0) {
        console.error("appState.orcamentos est√° vazio!");
        return alert('Erro: Nenhuma lista de or√ßamentos carregada.');
      }
      const orc = appState.orcamentos.find(o => String(o.id).trim() === String(id).trim());
      if (!orc) {
        console.error("ID n√£o encontrado no appState.orcamentos.");
        console.log("IDs dispon√≠veis:", appState.orcamentos.map(o => o.id));
        return alert('Or√ßamento n√£o encontrado. Tente recarregar a p√°gina.');
      }
      console.log("Or√ßamento encontrado:", orc);
      openOrcamentoModal(orc);
    };

    // ==========================================================
    // IN√çCIO: L√ìGICA DO MODAL DE OR√áAMENTO (ATUALIZADO)
    // ==========================================================

    // NOVO: Fun√ß√µes de toggle para o modal
    const toggleModoDeCobranca = (modo) => {
        const moWrapper = document.getElementById('orc-cobranca-mo-wrapper');
        const servicoWrapper = document.getElementById('orc-cobranca-servico-wrapper');
        
        if (modo === 'por_servico') {
            moWrapper.classList.add('hidden');
            servicoWrapper.classList.remove('hidden');
            // Limpa a sele√ß√£o de M√£o de Obra
            appState.currentOrcamento.maoDeObra = { tipo: '', valor: 0, label: '', raw_value: '' };
            document.querySelectorAll('input[name="tipo-servico"]').forEach(rb => rb.checked = false);
            document.querySelectorAll('#orc-mao-de-obra input[type="number"]').forEach(inp => inp.value = '');
        } else { // 'mao_de_obra'
            moWrapper.classList.remove('hidden');
            servicoWrapper.classList.add('hidden');
            // Limpa a sele√ß√£o de Servi√ßos
            appState.currentOrcamento.tiposDeServico = [];
            document.querySelectorAll('#orc-tiposdeservico-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#orc-tiposdeservico-list input[type="number"]').forEach(inp => { inp.value = '1'; inp.disabled = true; });
        }
        updateOrcamentoPreview();
    };

    const toggleUsarMaterial = (modo) => {
        const materialWrapper = document.getElementById('orc-cobranca-material-wrapper');
        
        if (modo === 'nao') {
            materialWrapper.classList.add('hidden');
            // Limpa a sele√ß√£o de Materiais
            appState.currentOrcamento.items = [];
            document.querySelectorAll('#orc-materiais-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#orc-materiais-list input[type="number"]').forEach(inp => { inp.value = '1'; inp.disabled = true; });
        } else { // 'sim'
            materialWrapper.classList.remove('hidden');
        }
        updateOrcamentoPreview();
    };

    window.openOrcamentoModal = (orcamentoParaEditar = null) => {
      try {
        const modal = document.getElementById('orcamento-modal');
        const clienteSelect = document.getElementById('orc-cliente-select');
        
        modal.classList.add('active');
        populateClienteSelect();
        populateMateriaisOrcamento();
        populateTiposDeServicoOrcamento();

        if (orcamentoParaEditar) {
          document.getElementById('modal-title').textContent = 'Editar Or√ßamento';
          // Deep copy
          const clone = JSON.parse(JSON.stringify(orcamentoParaEditar || {}));
          
          // Padr√µes
          clone.modoCobranca = clone.modoCobranca || 'mao_de_obra';
          clone.usarMaterial = clone.usarMaterial || 'sim';
          clone.tipoObra = clone.tipoObra || 'residencial';
          clone.maoDeObra = clone.maoDeObra || { tipo: '', valor: 0, label: '', raw_value: '' };
          clone.desconto = clone.desconto || { tipo: 'nenhum', valor: 0 };
          
          appState.currentOrcamento = clone;

          const descTextarea = document.getElementById('orc-descricao-servico');
          if (descTextarea) descTextarea.value = clone.descricaoServico || '';

          if (clone.cliente?.id) clienteSelect.value = clone.cliente.id;
          else clienteSelect.value = '';

          // Preenche Radio Buttons
          const setRadio = (name, val) => {
              const r = document.querySelector(`input[name="${name}"][value="${val}"]`);
              if(r) r.checked = true;
          };
          setRadio('modo-cobranca', clone.modoCobranca);
          setRadio('usar-material', clone.usarMaterial);
          
          if (clone.modoCobranca === 'mao_de_obra') {
              setRadio('tipo-obra', clone.tipoObra);
              if (clone.maoDeObra?.tipo) {
                  setRadio('tipo-servico', clone.maoDeObra.tipo);
                  // Preenche valores manuais
                  const map = { 'empreitada':'empreitada-valor', 'diaria':'diaria-qtd', 'ponto':'ponto-qtd', 'hora':'hora-qtd' };
                  const fieldId = map[clone.maoDeObra.tipo];
                  if(fieldId) document.getElementById(fieldId).value = clone.maoDeObra.raw_value || '';
              }
          }
          
          // Desconto
          if (clone.desconto && clone.desconto.tipo !== 'nenhum') {
            if (descontoTipoEl) descontoTipoEl.value = clone.desconto.tipo;
            if (descontoValorEl) { descontoValorEl.value = clone.desconto.valor || 0; descontoValorEl.disabled = false; }
          } else {
            if (descontoTipoEl) descontoTipoEl.value = 'nenhum';
            if (descontoValorEl) { descontoValorEl.value = ''; descontoValorEl.disabled = true; }
          }
          
          if (typeof toggleModoDeCobranca === 'function') toggleModoDeCobranca(clone.modoCobranca);
          if (typeof toggleUsarMaterial === 'function') toggleUsarMaterial(clone.usarMaterial);
          
          clienteSelect.dispatchEvent(new Event('change'));

          // Delay para preencher itens
          setTimeout(() => {
            if (clone.usarMaterial === 'sim') {
                (clone.items || []).forEach(item => {
                  const cb = document.querySelector(`#orc-materiais-list input[data-id="${item.id}"]`);
                  const qty = document.querySelector(`#orc-materiais-list input[type="number"][data-id="${item.id}"]`);
                  if (cb) cb.checked = true;
                  if (qty) { qty.disabled = false; qty.value = item.quantidade ?? 1; }
                });
            }
            if (clone.modoCobranca === 'por_servico') {
                (clone.tiposDeServico || []).forEach(item => {
                  const cb = document.querySelector(`#orc-tiposdeservico-list input[data-id="${item.id}"]`);
                  const qty = document.querySelector(`#orc-tiposdeservico-list input[type="number"][data-id="${item.id}"]`);
                  if (cb) cb.checked = true;
                  if (qty) { qty.disabled = false; qty.value = item.quantidade ?? 1; }
                });
            }
            calculateMaoDeObra();
            updateOrcamentoPreview();
          }, 300);

        } else { // Novo
          document.getElementById('modal-title').textContent = 'Criar Novo Or√ßamento';
          resetCurrentOrcamento();
          
          const descTextarea = document.getElementById('orc-descricao-servico');
          if (descTextarea) descTextarea.value = '';
          
          document.querySelector('input[name="modo-cobranca"][value="mao_de_obra"]').checked = true;
          document.querySelector('input[name="usar-material"][value="sim"]').checked = true;
          
          if (descontoTipoEl) descontoTipoEl.value = 'nenhum';
          if (descontoValorEl) { descontoValorEl.value = ''; descontoValorEl.disabled = true; }

          if (typeof toggleModoDeCobranca === 'function') toggleModoDeCobranca('mao_de_obra');
          if (typeof toggleUsarMaterial === 'function') toggleUsarMaterial('sim');

          clienteSelect.value = '';
          clienteSelect.dispatchEvent(new Event('change'));
          updateOrcamentoPreview();
        }
      } catch (err) {
        console.error("[openOrcamentoModal] Erro:", err);
      }
    };

    const descontoTipoEl = document.getElementById('orc-desconto-tipo');
    const descontoValorEl = document.getElementById('orc-desconto-valor');
   
    window.closeOrcamentoModal = () => {
      document.getElementById('orcamento-modal').classList.remove('active');
      resetCurrentOrcamento();
      
      document.getElementById('orc-cliente-select').value = '';
      
      // Limpa listas
      const matList = document.querySelector('#orc-materiais-list');
      if (matList) {
        matList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        matList.querySelectorAll('input[type="number"]').forEach(inp => { inp.value = '1'; inp.disabled = true; });
      }
      
      const servList = document.querySelector('#orc-tiposdeservico-list');
      if (servList) {
        servList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        servList.querySelectorAll('input[type="number"]').forEach(inp => { inp.value = '1'; inp.disabled = true; });
      }
      
      const desc = document.getElementById('orc-descricao-servico');
      if (desc) desc.value = '';
      
      document.querySelectorAll('input[name="tipo-servico"]').forEach(rb => rb.checked = false);
      document.querySelectorAll('#orc-mao-de-obra input[type="number"]').forEach(inp => inp.value = '');
      
      // Reseta toggles
      document.querySelector('input[name="modo-cobranca"][value="mao_de_obra"]').checked = true;
      document.querySelector('input[name="usar-material"][value="sim"]').checked = true;
      document.querySelector('input[name="tipo-obra"][value="residencial"]').checked = true;
      
      // Fun√ß√µes que ainda existem no v4.9
      if (typeof toggleModoDeCobranca === 'function') toggleModoDeCobranca('mao_de_obra');
      if (typeof toggleUsarMaterial === 'function') toggleUsarMaterial('sim');

      if (descontoTipoEl) descontoTipoEl.value = 'nenhum';
      if (descontoValorEl) { descontoValorEl.value = ''; descontoValorEl.disabled = true; }
    };
    
    function populateClienteSelect() {
      const selectEl = document.getElementById('orc-cliente-select');
      selectEl.innerHTML = '<option value="">Selecione um cliente</option>';
      appState.clientes.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id; option.textContent = c.nome; selectEl.appendChild(option);
      });
    }

    // Fun√ß√£o nova para filtrar no modal
    window.filtrarMateriaisModal = (tipoAlvo) => {
        // Atualiza visual dos bot√µes
        const btnCompra = document.getElementById('tab-mat-compra');
        const btnEstoque = document.getElementById('tab-mat-estoque');
        
        if (tipoAlvo === 'padrao') {
            btnCompra.className = "text-xs font-bold px-3 py-1 bg-gray-200 rounded text-blue-700 border border-blue-200";
            btnEstoque.className = "text-xs font-bold px-3 py-1 bg-white border rounded text-gray-500 hover:bg-gray-100";
        } else {
            btnCompra.className = "text-xs font-bold px-3 py-1 bg-white border rounded text-gray-500 hover:bg-gray-100";
            btnEstoque.className = "text-xs font-bold px-3 py-1 bg-gray-200 rounded text-blue-700 border border-blue-200";
        }
        populateMateriaisOrcamento(tipoAlvo);
    };

    function populateMateriaisOrcamento(filtroTipo = 'padrao') {
      const listEl = document.getElementById('orc-materiais-list');
      // Filtra a lista global
      const filtrados = appState.materiais.filter(m => {
          if (filtroTipo === 'estoque') return m.tipo === 'estoque';
          return m.tipo !== 'estoque'; // Padr√£o
      });

      if (!filtrados.length) { listEl.innerHTML = '<p class="text-gray-500 p-2 text-xs">Nenhum item nesta categoria.</p>'; return; }
      
      listEl.innerHTML = filtrados.map(m => {
          // Verifica se j√° est√° selecionado no or√ßamento atual para marcar o checkbox
          const jaSelecionado = appState.currentOrcamento?.items?.find(i => i.id === m.id);
          const qtd = jaSelecionado ? jaSelecionado.quantidade : 1;
          const checked = jaSelecionado ? 'checked' : '';
          const disabled = jaSelecionado ? '' : 'disabled';
          
          // Adiciona # visualmente se for estoque
          const prefix = m.tipo === 'estoque' ? '<span class="text-blue-600 font-bold">#</span> ' : '';

          return `
            <div class="flex items-center justify-between p-2 rounded-md hover:bg-white border-b border-gray-100 last:border-0">
              <label class="flex items-center flex-grow cursor-pointer">
                <input type="checkbox" data-id="${m.id}" ${checked} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-xs text-gray-700">${prefix}${m.nome} - R$ ${m.valor.toFixed(2)}</span>
              </label>
              <input type="number" min="1" value="${qtd}" data-id="${m.id}" class="w-14 p-1 border rounded-md text-xs ml-2 text-center" ${disabled}>
            </div>`;
      }).join('');
    }

        function populateTiposDeServicoOrcamento() {
      const listEl = document.getElementById('orc-tiposdeservico-list');
      if (!appState.tiposDeServico.length) {
        listEl.innerHTML = '<p class="text-gray-500 p-2">Nenhum tipo de servi√ßo cadastrado em Servi√ßos.</p>';
        return;
      }

      const grouped = groupBy(appState.tiposDeServico, 'categoria');
      const cats = Object.keys(grouped).sort();

      listEl.innerHTML = cats.map(cat => {
        const servicos = grouped[cat].sort((a, b) => (a.descricao || '').localeCompare(b.descricao || ''));
        return `
          <details class="group border rounded">
            <summary class="flex items-center justify-between p-2 cursor-pointer hover:bg-gray-200 rounded-md">
              <span class="font-medium text-sm text-gray-700">${cat}</span>
              <svg class="w-4 h-4 arrow" xmlns="http://www.w3.org/2000/svg" fill="none"
                   viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="pl-3 pb-2">
              ${
                servicos.map(s => `
                  <div class="flex items-center justify-between p-1 rounded-md hover:bg-gray-100">
                    <label class="flex items-center flex-grow cursor-pointer">
                      <input 
                        type="checkbox" 
                        data-id="${s.id}" 
                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      >
                      <span class="ml-2 servico-slim">
                        ${s.descricao} - R$ ${s.valor.toFixed(2)}
                      </span>
                    </label>
                    <input 
                      type="number" 
                      min="1" 
                      value="1" 
                      data-id="${s.id}" 
                      class="w-16 p-1 border rounded-md text-xs ml-2" 
                      disabled
                    >
                  </div>
                `).join('')
              }
            </div>
          </details>`;
      }).join('');
    }

document.getElementById('filter-tipos').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase().trim();
      const boxes = document.querySelectorAll('#orc-tiposdeservico-list label span');
      boxes.forEach(span => {
        const row = span.closest('label');
        row.style.display = span.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    document.getElementById('orc-materiais-list').addEventListener('input', (e) => {
      const target = e.target;
      const materialId = target.dataset.id;
      const material = appState.materiais.find(m => m.id === materialId);
      if (!material) return;
      const qtyInput = document.querySelector(`#orc-materiais-list input[type="number"][data-id="${materialId}"]`);
      if (target.type === 'checkbox') {
        if (target.checked) {
          qtyInput.disabled = false;
          const newItem = { ...material, quantidade: parseInt(qtyInput.value) || 1 };
          appState.currentOrcamento.items.push(newItem);
        } else {
          qtyInput.disabled = true;
          appState.currentOrcamento.items = appState.currentOrcamento.items.filter(item => item.id !== materialId);
        }
      } else if (target.type === 'number') {
        const itemInOrcamento = appState.currentOrcamento.items.find(item => item.id === materialId);
        if (itemInOrcamento) itemInOrcamento.quantidade = parseInt(target.value) || 1;
      }
      updateOrcamentoPreview();
    });

        document.getElementById('orc-tiposdeservico-list').addEventListener('input', (e) => {
      const target = e.target;
      if (!target) return;

      const serviceId = target.dataset.id;
      if (!serviceId) return;

      const serviceBase = appState.tiposDeServico.find(s => s.id === serviceId);
      if (!serviceBase) return;

      const qtyInput = document.querySelector(
        `#orc-tiposdeservico-list input[type="number"][data-id="${serviceId}"]`
      );

      // Checkbox marcado / desmarcado
      if (target.type === 'checkbox') {
        if (target.checked) {
          if (qtyInput) qtyInput.disabled = false;
          const quantidade = parseInt(qtyInput?.value || '1', 10) || 1;

          const existente = appState.currentOrcamento.tiposDeServico
            .find(s => s.id === serviceId);

          if (existente) {
            existente.quantidade = quantidade;
          } else {
            appState.currentOrcamento.tiposDeServico.push({
              ...serviceBase,
              quantidade
            });
          }
        } else {
          if (qtyInput) {
            qtyInput.disabled = true;
            qtyInput.value = '1';
          }
          appState.currentOrcamento.tiposDeServico =
            appState.currentOrcamento.tiposDeServico.filter(s => s.id !== serviceId);
        }
      }

      // Altera√ß√£o de quantidade
      if (target.type === 'number') {
        const quantidade = parseInt(target.value || '1', 10) || 1;
        const existente = appState.currentOrcamento.tiposDeServico
          .find(s => s.id === serviceId);
        if (existente) existente.quantidade = quantidade;
      }

      updateOrcamentoPreview();
    });

document.getElementById('orc-tipo-obra').addEventListener('change', (e) => {
      if (!e.target || e.target.name !== 'tipo-obra') return;
      const novoValor = e.target.value === 'industrial' ? 'industrial' : 'residencial';
      if (appState.currentOrcamento) appState.currentOrcamento.tipoObra = novoValor;
      const pontoLabel = document.getElementById('ponto-label-span');
      const pontoQtdInput = document.getElementById('ponto-qtd');
      if (pontoLabel) pontoLabel.textContent = novoValor === 'industrial' ? 'Por Equipamento' : 'Por Ponto';
      if (pontoQtdInput) pontoQtdInput.placeholder = novoValor === 'industrial' ? 'Qtd. equip.' : 'Qtd. pontos';
      calculateMaoDeObra();
      updateOrcamentoPreview();
    });

    document.getElementById('orc-mao-de-obra').addEventListener('input', () => {
      calculateMaoDeObra();
      updateOrcamentoPreview();
    });

    // NOVO: Adiciona listeners para os toggles
    document.getElementById('orc-modo-cobranca').addEventListener('change', (e) => {
        if (!appState.currentOrcamento) return;
        const modo = e.target.value;
        appState.currentOrcamento.modoCobranca = modo;
        toggleModoDeCobranca(modo);
    });

    document.getElementById('orc-usar-material').addEventListener('change', (e) => {
        if (!appState.currentOrcamento) return;
        const modo = e.target.value;
        appState.currentOrcamento.usarMaterial = modo;
        toggleUsarMaterial(modo);
    });
    // FIM dos novos listeners

    function calculateMaoDeObra() {
      const tipoSelecionado = document.querySelector('input[name="tipo-servico"]:checked');
      if (!appState.currentOrcamento || !tipoSelecionado) {
        if(appState.currentOrcamento) appState.currentOrcamento.maoDeObra = { tipo: '', valor: 0, label: '', raw_value: '' };
        return;
      }
      const tipo = tipoSelecionado.value;
      let valor = 0, label = '', raw_value = 0;
      const tipoObra = appState.currentOrcamento.tipoObra || 'residencial';
      const rates = {
        empreitada: appState.config.residencial_empreitada || 0,
        diaria: (tipoObra === 'industrial' ? appState.config.industrial_diaria : appState.config.residencial_diaria) || 0,
        ponto: (tipoObra === 'industrial' ? appState.config.industrial_ponto : appState.config.residencial_ponto) || 0,
        hora: (tipoObra === 'industrial' ? appState.config.industrial_hora : appState.config.residencial_hora) || 0,
      };
      
      switch(tipo) {
        case 'empreitada':
          if (tipoObra === 'residencial' && rates.empreitada > 0) {
              valor = rates.empreitada;
              label = 'Empreitada (Valor Fixo da Configura√ß√£o)';
              raw_value = rates.empreitada;
          } else {
              raw_value = parseFloat(document.getElementById('empreitada-valor').value) || 0;
              valor = raw_value; 
              label = 'Empreitada (Valor Manual)';
          }
          break;
        case 'diaria':
          raw_value = parseInt(document.getElementById('diaria-qtd').value) || 0;
          valor = raw_value * rates.diaria; label = `${raw_value} di√°ria(s)`; break;
        case 'ponto':
          raw_value = parseInt(document.getElementById('ponto-qtd').value) || 0;
          valor = raw_value * rates.ponto; label = tipoObra === 'industrial' ? `${raw_value} equipamento(s)` : `${raw_value} ponto(s)`; break;
        case 'hora':
          raw_value = parseFloat(document.getElementById('hora-qtd').value) || 0;
          valor = raw_value * rates.hora; label = `${raw_value} hora(s)`; break;
      }
      appState.currentOrcamento.maoDeObra = { tipo, valor, label, raw_value };
    }

    
    // Campo de descri√ß√£o livre do servi√ßo realizado
    const orcDescricaoServicoEl = document.getElementById('orc-descricao-servico');
    if (orcDescricaoServicoEl) {
      orcDescricaoServicoEl.addEventListener('input', (e) => {
        if (!appState.currentOrcamento) return;
        appState.currentOrcamento.descricaoServico = e.target.value || '';
        updateOrcamentoPreview();
      });
    }

function updateOrcamentoPreview() {
      const { config, currentOrcamento } = appState;
      // Cores configuradas
      const corPrimaria = config.config_color_primary || '#000000';
      const corTotal = config.config_color_secondary || '#333333';

      const previewEl = document.getElementById('pdf-preview');
      if (!currentOrcamento || !currentOrcamento.cliente) {
        previewEl.innerHTML = '<p class="text-gray-500 text-center mt-8">Selecione um cliente para come√ßar.</p>';
        return;
      }
      
      // Dados do Cliente e Profissional
      const fullClient = currentOrcamento.cliente;
      const numeroSeq = String(currentOrcamento.numeroOrcamento || '').padStart(3, '0');
      const dateRef = currentOrcamento.createdAt ? new Date(currentOrcamento.createdAt) : new Date();
      const anoFull = dateRef.getFullYear();
      const codigoCliente = fullClient.numeroCadastro || 'SEM-COD';
      const codigoOrcamento = `${codigoCliente}-${numeroSeq}/${anoFull}`;
      
      const dia = dateRef.getDate().toString().padStart(2, '0');
      const mes = (dateRef.getMonth() + 1).toString().padStart(2, '0');
      const ano = dateRef.getFullYear();
      const dataFormatada = `${dia}/${mes}/${ano}`;

      // Dados do Profissional (Cabe√ßalho)
      const { label: profDocLabel, valor: profDocValor } = getLabelEValorDoc(config.doc);
      const profEnderecoLinha1 = `${config.logradouro || ''}, ${config.numero || 's/n'}`;
      const profEnderecoLinha2 = `${config.bairro || ''} - ${config.cidade || ''}/${config.uf || ''}`;
      
      // Dados do Cliente (Cabe√ßalho)
      const { label: clientDocLabel, valor: clientDocValor } = getLabelEValorDoc(fullClient.documento);
      const clientEndereco = formatarEnderecoCompleto(fullClient);

      // Vari√°veis de C√°lculo
      let tiposDeServicoHtml = '';
      let subtotalServicos = 0;
      let maoDeObraHtml = '';
      let totalMaoDeObra = 0;
      let materiaisHtml = '';
      let subtotalMateriais = 0;

      const modoCobranca = currentOrcamento.modoCobranca || 'mao_de_obra';
      const usarMaterial = currentOrcamento.usarMaterial || 'sim';

      // 1. Processa Servi√ßos (se 'por_servico')
      if (modoCobranca === 'por_servico' && Array.isArray(currentOrcamento.tiposDeServico) && currentOrcamento.tiposDeServico.length > 0) {
        const linhasServicos = currentOrcamento.tiposDeServico.map(s => {
          const qtd = s.quantidade && s.quantidade > 0 ? s.quantidade : 1;
          const valorUnit = s.valor || 0;
          const totalLinha = valorUnit * qtd;
          subtotalServicos += totalLinha;
          return `
            <tr>
              <td style="padding: 4px 2px;">${s.descricao || ''}</td>
              <td style="padding: 4px 2px; text-align: center;">${qtd}</td>
              <td style="padding: 4px 2px; text-align: right;">R$ ${valorUnit.toFixed(2)}</td>
              <td style="padding: 4px 2px; text-align: right;">R$ ${totalLinha.toFixed(2)}</td>
            </tr>`;
        }).join('');
        
        tiposDeServicoHtml = `
          <h4 style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px; color: ${corPrimaria};">
            DESCRI√á√ÉO DOS SERVI√áOS:
          </h4>
          <table style="width: 100%; border-collapse: collapse; font-size: 0.9em; margin-bottom: 10px;">
            <thead><tr><th style="text-align: left; padding: 4px 2px; border-bottom: 1px solid #ccc;">Descri√ß√£o</th><th style="text-align: center; padding: 4px 2px; border-bottom: 1px solid #ccc;">Qtd.</th><th style="text-align: right; padding: 4px 2px; border-bottom: 1px solid #ccc;">V. Unit.</th><th style="text-align: right; padding: 4px 2px; border-bottom: 1px solid #ccc;">V. Total</th></tr></thead>
            <tbody>${linhasServicos}</tbody>
          </table>`;
      }

      // 2. Processa M√£o de Obra (se 'mao_de_obra')
      if (modoCobranca === 'mao_de_obra') {
        totalMaoDeObra = currentOrcamento.maoDeObra.valor || 0;
        const maoDeObraLabel = currentOrcamento.maoDeObra.label || 'N√£o definida';
        
        if (totalMaoDeObra > 0 || maoDeObraLabel !== 'N√£o definida') {
            maoDeObraHtml = `
              <h4 style="font-size: 1.1em; font-weight: bold; margin-top: 15px; margin-bottom: 5px; color: ${corPrimaria};">M√ÉO DE OBRA:</h4>
              <div style="text-align: right;"><span>${maoDeObraLabel}: R$ ${totalMaoDeObra.toFixed(2)}</span></div>`;
        }
      }
      
      // 3. Processa Materiais (se 'sim')
      if (usarMaterial === 'sim') {
          const itemsHtml = currentOrcamento.items.map(item => {
            const itemTotal = item.valor * (item.quantidade || 1);
            subtotalMateriais += itemTotal;
            
            // L√ìGICA DO ESTOQUE (#) INSERIDA AQUI
            const nomeExibicao = (item.tipo === 'estoque' ? '# ' : '') + item.nome;

            return `<tr>
              <td style="padding: 4px 2px; text-align: left;">${nomeExibicao}</td>
              <td style="padding: 4px 2px; text-align: center;">${item.quantidade || 1} ${item.unidade || 'UNID'}</td>
              <td style="padding: 4px 2px; text-align: right;">R$ ${item.valor.toFixed(2)}</td>
              <td style="padding: 4px 2px; text-align: right;">R$ ${itemTotal.toFixed(2)}</td>
            </tr>`;
          }).join('');

          materiaisHtml = `
            <h4 style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px; color: ${corPrimaria};">DESCRI√á√ÉO DOS MATERIAIS:</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
              ${currentOrcamento.items.length > 0 ? `<thead><tr><th style="text-align: left; padding: 4px 2px; border-bottom: 1px solid #ccc;">Descri√ß√£o</th><th style="text-align: center; padding: 4px 2px; border-bottom: 1px solid #ccc;">Qtd.</th><th style="text-align: right; padding: 4px 2px; border-bottom: 1px solid #ccc;">V. Unit.</th><th style="text-align: right; padding: 4px 2px; border-bottom: 1px solid #ccc;">V. Total</th></tr></thead><tbody>${itemsHtml}</tbody>` : '<tbody><tr><td colspan="4" style="padding: 10px 0; color: #888;">Nenhum material adicionado.</td></tr></tbody>'}
            </table>
            ${currentOrcamento.items.length > 0 ? `<div style="text-align: right; font-weight: bold; margin-top: 10px; padding-top: 5px; border-top: 1px solid #ccc;"><span>Subtotal Materiais: R$ ${subtotalMateriais.toFixed(2)}</span></div>` : ''}
            <div style="font-size: 0.7em; color: #666; margin-top: 2px;">* Itens marcados com # s√£o de estoque imediato.</div>`;
      }
      
      // 4. Formas de Pagamento (L√≥gica da V5.2)
      let pagamentoHtml = '';
      if (config.config_pix_chave || config.config_cartao_vezes || config.config_pagamento_dinheiro || config.config_deposito_banco) {
        pagamentoHtml += '<div style="border: 2px dotted #888; padding: 10px; margin-top: 20px;">';
        pagamentoHtml += `<h4 style="font-size: 1.1em; font-weight: bold; margin-top: 0; margin-bottom: 5px; color: ${corPrimaria};">Formas de Pagamento:</h4><div style="font-size: 0.9em; line-height: 1.4;">`;
        let hasPayment = false;
        if (config.config_pix_chave) {
          pagamentoHtml += `<strong>PIX:</strong> ${config.config_pix_chave}<br>`;
          hasPayment = true;
        }
        if (config.config_cartao_vezes) {
          let jurosText = config.config_cartao_juros ? ` (juros de ${config.config_cartao_juros}%)` : '';
          pagamentoHtml += `<strong>Cart√£o:</strong> Em at√© ${config.config_cartao_vezes}x${jurosText}<br>`;
          hasPayment = true;
        }
        if (config.config_pagamento_dinheiro) {
          pagamentoHtml += `<strong>Dinheiro</strong><br>`;
          hasPayment = true;
        }
        if (config.config_deposito_banco && config.config_deposito_ag && config.config_deposito_conta) {
          pagamentoHtml += `<strong>Dep√≥sito:</strong> Banco ${config.config_deposito_banco} | Ag: ${config.config_deposito_ag} | Conta: ${config.config_deposito_conta}<br>`;
          hasPayment = true;
        }
        if (!hasPayment) {
          pagamentoHtml += 'Consulte as formas de pagamento.';
        }
        pagamentoHtml += '</div></div>';
      }
      
      // 5. C√°lculo de Total e Desconto
      const subtotal = subtotalServicos + subtotalMateriais + totalMaoDeObra;
      let valorDesconto = 0;
      let descontoHtml = '';
      const desconto = currentOrcamento.desconto;

      if (desconto && desconto.tipo !== 'nenhum' && desconto.valor > 0) {
        if (desconto.tipo === 'percent') {
          valorDesconto = (subtotal * desconto.valor) / 100;
          descontoHtml = `
            <div style="text-align: right; background: #f5f5f5; padding: 2px 0;">
              <span>Desconto (${desconto.valor.toFixed(2)}%): R$ -${valorDesconto.toFixed(2)}</span>
            </div>`;
        } else { // tipo === 'valor'
          valorDesconto = desconto.valor;
          descontoHtml = `
            <div style="text-align: right; background: #f5f5f5; padding: 2px 0;">
              <span>Desconto (R$): R$ -${valorDesconto.toFixed(2)}</span>
            </div>`;
        }
      }
      
      currentOrcamento.total = subtotal - valorDesconto;
      
      // 6. Renderiza√ß√£o Final (Com Logo e Cabe√ßalho Completo da V5.2)
      previewEl.innerHTML = `
        <div style="padding: 10px 30px 20px 20px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding: 0 10px;">
            <div style="text-align: left; max-width: 70%;">
              <strong style="font-size: 1.2em; display: block;">${config.nome || 'Nome do Profissional'}</strong>
              <span style="display: block; font-size: 0.9em; overflow-wrap: break-word;">${profEnderecoLinha1}</span>
              <span style="display: block; font-size: 0.9em; overflow-wrap: break-word;">${profEnderecoLinha2}</span>
              <span style="display: block; font-size: 0.9em; overflow-wrap: break-word;">Telefone: ${formatarTelefone(config.telefone)} | ${profDocLabel} ${profDocValor}</span>
            </div>
            ${config.logo ? `<div style="text-align: right; flex-shrink: 0; margin-left: 20px;"><img src="${config.logo}" alt="Logomarca" style="max-width: 150px; max-height: 80px;"></div>` : ''}
          </div>
          
          <hr style="margin: 15px 0;">
          
          <h4 style="font-size: 1.1em; font-weight: bold; margin-bottom: 6px; color: ${corPrimaria};">Pedido N¬∫: ${codigoOrcamento}</h4>
          <h4 style="font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: ${corPrimaria};">Data do Pedido: ${dataFormatada}</h4>
          <strong style="display: block;">${fullClient.nome}</strong>
          <span style="display: block;">${clientEndereco}</span>
          ${fullClient.documento ? `<span style="display: block;">${clientDocLabel} ${clientDocValor}</span>` : ''}
          <span style="display: block;">Telefone: ${formatarTelefone(fullClient.telefone)}</span>
          
          <hr style="margin: 15px 0;">
          
          ${
            currentOrcamento.descricaoServico
              ? `<h4 style="font-size: 1.1em; font-weight: bold; margin-bottom: 5px; color: ${corPrimaria};">DESCRI√á√ÉO DO SERVI√áO:</h4>
                 <p style="font-size: 0.9em; margin-bottom: 10px; white-space: pre-line;">
                   ${currentOrcamento.descricaoServico}
                 </p>`
              : ''
          }
          
          ${tiposDeServicoHtml}
          ${materiaisHtml}
          ${maoDeObraHtml}
          
          ${descontoHtml}

          <div style="text-align: right; font-size: 1.2em; font-weight: bold; margin-top: 10px; padding: 10px 5px; border-top: 2px solid ${corTotal}; color: ${corTotal}; background-color: #EEEEEE;">
            <span>TOTAL: R$ ${currentOrcamento.total.toFixed(2)}</span>
          </div>
          
          <div style="page-break-inside: avoid; margin-top: 10px;">
            ${pagamentoHtml}
            <div style="font-size: 0.9em; margin-top: 5px; text-align: center; font-weight: bold; background-color: #FFFFCC; padding: 5px 0;">
              Or√ßamento v√°lido por 15 dias.
            </div>
          </div>
        </div>`;
    }

  window.saveOrcamento = async (fecharModal = true) => {
      if (!appState.currentOrcamento?.cliente) return alert('Selecione um cliente.');
      
      const data = { ...appState.currentOrcamento };
      
      // Define status se for novo
      if (!data.id) {
          data.status = 'pendente';
          data.aprovado = false;
      } else {
          data.status = data.status || (data.aprovado ? 'aprovado' : 'pendente');
      }

      // Limpeza de dados
      if (data.modoCobranca === 'mao_de_obra') data.tiposDeServico = []; 
      else data.maoDeObra = { tipo: '', valor: 0, label: '', raw_value: '' };
      
      if (data.usarMaterial === 'nao') data.items = []; 
      
      try {
        if (data.id) { // Editando
          data.versao = (data.versao || 1) + 1;
          const ref = doc(db, `users/${userId}/orcamentos/${data.id}`);
          delete data.createdAt; 
          await setDoc(ref, data, { merge: true });
        } else { // Criando
          // 1. Calcula o novo n√∫mero
          const maxNumero = appState.orcamentos.reduce((max, o) => Math.max(max, o.numeroOrcamento || 0), 0);
          data.numeroOrcamento = maxNumero + 1;
          data.versao = 1;
          data.createdAt = serverTimestamp();
          
          // 2. Salva no banco
          const ref = await addDoc(collection(db, `users/${userId}/orcamentos`), data);
          
          // 3. Atualiza o estado local com o ID e o N√öMERO NOVO
          appState.currentOrcamento.id = ref.id;
          appState.currentOrcamento.numeroOrcamento = data.numeroOrcamento;
        }
        updateOrcamentoPreview(); 
      
        if (fecharModal) {
            alert('Or√ßamento salvo com sucesso!');
            closeOrcamentoModal();
        } else {
            console.log("Autosalvo com sucesso (N√∫mero gerado).");
        }
        
      } catch(e) {
        console.error(e); 
        alert('Erro ao salvar.');
        throw e; 
      }
    };

   window.shareOrViewPDF = async () => {
      if (!appState.currentOrcamento?.cliente) return alert('Selecione um cliente para gerar o PDF.');
      
      // SALVA AUTOMATICAMENTE ANTES DE GERAR (false = n√£o fechar modal)
      try {
          await saveOrcamento(false);
      } catch (error) {
          return; // Se der erro ao salvar, para tudo e n√£o gera o PDF
      }
      
      // 1. Cria o elemento tempor√°rio para o PDF
      const element = document.createElement('div');
      element.innerHTML = document.getElementById('pdf-preview').innerHTML;
      element.style.width = '700px';
      element.style.padding = '10px 10px 10px 10px';
      element.style.fontSize = '12px'; 
      element.style.fontFamily = 'Inter, sans-serif';
      element.style.backgroundColor = '#ffffff';
      
      const opt = {
        margin:       [10, 10, 10, 10],
        filename:     `pedido-${(appState.currentOrcamento.cliente.nome || 'cliente').replace(/\s+/g, '-')}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 4, useCORS: true, letterRendering: true, scrollY: 0 }, 
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak:    { mode: ['css', 'legacy'] }
      };

      try {
        if (navigator.share && navigator.canShare) {
            const pdfBlob = await html2pdf().set(opt).from(element).output('blob');
            const file = new File([pdfBlob], opt.filename, { type: 'application/pdf' });
            
            if (navigator.canShare({ files: [file] })) {
                await navigator.share({
                    title: `Or√ßamento - ${appState.currentOrcamento.cliente.nome}`,
                    text: 'Segue o or√ßamento em anexo.',
                    files: [file]
                });
                return; 
            }
        }
        html2pdf().set(opt).from(element).save();
        
      } catch (e) {
        console.error("Erro ao gerar PDF:", e);
        alert('Erro ao gerar o PDF.');
      }
    };

    window.sendWhatsAppText = async () => {
      if (!appState.currentOrcamento?.cliente) return alert('Selecione um cliente primeiro.');
      
      // SALVA AUTOMATICAMENTE ANTES DE ENVIAR
      try {
          await saveOrcamento(false);
      } catch (error) {
          return; // Para se der erro no salvamento
      }

      const fullClient = appState.currentOrcamento.cliente;
      if (!fullClient) return alert('Cliente n√£o encontrado.');
      
      const telefone = (fullClient.telefone || '').replace(/\D/g, '');
      const nomeProfissional = appState.config.nome || 'n√≥s';
      // Agora o total est√° garantido atualizado
      const mensagem = `Ol√° ${fullClient.nome}! Segue o or√ßamento que voc√™ solicitou com ${nomeProfissional}, no valor total de R$ ${appState.currentOrcamento.total.toFixed(2)}. O arquivo PDF com os detalhes ser√° enviado em seguida. Qualquer d√∫vida, estou √† disposi√ß√£o!`;
      
      const whatsappUrl = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
      window.open(whatsappUrl, '_blank');
    };

    window.changeTab = (event, tabName) => {
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelectorAll('.tab, .mobile-tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.querySelectorAll(`.tab[data-tab="${tabName}"], .mobile-tab[data-tab="${tabName}"]`).forEach(tab => tab.classList.add('active'));
    };

    // L√≥gica do Desconto
    function handleDescontoChange() {
        if (!appState.currentOrcamento) return; // Prote√ß√£o
        const tipo = descontoTipoEl.value;
        const valor = parseFloat(descontoValorEl.value) || 0;

        if (tipo === 'nenhum') {
            descontoValorEl.disabled = true;
            descontoValorEl.value = '';
            appState.currentOrcamento.desconto = { tipo: 'nenhum', valor: 0 };
        } else {
            descontoValorEl.disabled = false;
            appState.currentOrcamento.desconto = { tipo, valor };
        }
        updateOrcamentoPreview();
    }
    descontoTipoEl?.addEventListener('change', handleDescontoChange);
    descontoValorEl?.addEventListener('input', handleDescontoChange);

    // ==========================================================
    // BLOCO: FUN√á√ïES DE M√ÅSCARA E FORMATA√á√ÉO DE DOCUMENTO
    // ==========================================================
    function formatarCPFCNPJ(value) {
        if (!value) return "";
        const cleanValue = value.replace(/\D/g, '');
        if (cleanValue.length <= 11) {
            return cleanValue
                .slice(0, 11)
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        } else {
            return cleanValue
                .slice(0, 14) 
                .replace(/(\d{2})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1.$2')
                .replace(/(\d{3})(\d)/, '$1/$2')
                .replace(/(\d{4})(\d{1,2})$/, '$1-$2');
        }
    }
    function handleDocMask(event) {
        const input = event.target;
        const originalPos = input.selectionStart;
        const originalLength = input.value.length;
        input.value = formatarCPFCNPJ(input.value);
        const newLength = input.value.length;
        const diff = newLength - originalLength;
        input.setSelectionRange(originalPos + diff, originalPos + diff);
    }
    function getLabelEValorDoc(docValue) {
        if (!docValue) return { label: 'Doc:', valor: '' };
        const cleanValue = String(docValue).replace(/\D/g, '');
        if (cleanValue.length === 11) {
            return { label: 'CPF:', valor: formatarCPFCNPJ(cleanValue) };
        }
        if (cleanValue.length === 14) {
            return { label: 'CNPJ:', valor: formatarCPFCNPJ(cleanValue) };
        }
        return { label: 'Doc:', valor: docValue };
    }
    // ==========================================================
    // BLOCO: FUN√á√ïES DE M√ÅSCARA DE TELEFONE
    // ==========================================================
    function formatarTelefone(value) {
        if (!value) return "";
        const cleanValue = value.replace(/\D/g, '');
        return cleanValue
            .slice(0, 11)
            .replace(/(\d{2})(\d)/, '($1) $2')       // (XX) X
            .replace(/(\d{5})(\d{1,4})$/, '$1-$2');  // (XX) XXXXX-XXXX
    }
    function handleTelefoneMask(event) {
        const input = event.target;
        const originalPos = input.selectionStart;
        const originalLength = input.value.length;
        input.value = formatarTelefone(input.value);
        const newLength = input.value.length;
        const diff = newLength - originalLength;
        if (diff > 0) {
            input.setSelectionRange(originalPos + diff, originalPos + diff);
        } else {
            input.setSelectionRange(originalPos, originalPos);
        }
    }
    
    // ==========================================================
    // BLOCO: FUN√á√ïES DE BUSCA DE CEP E M√ÅSCARA
    // ==========================================================
    
    /**
     * Formata um valor de string para CEP (XXXXX-XXX)
     * @param {string} value - O valor a ser formatado
     * @returns {string} - O valor com a m√°scara
     */
    function formatarCEP(value) {
        if (!value) return "";
        return value
            .replace(/\D/g, '')       // Remove tudo que n√£o √© d√≠gito
            .slice(0, 8)              // Limita a 8 d√≠gitos
            .replace(/(\d{5})(\d{1,3})$/, '$1-$2'); // Aplica a m√°scara
    }
    
    /**
     * Fun√ß√£o para ser usada no evento 'input' dos campos de CEP
     * @param {Event} event - O evento de input
     */
    function handleCEPMask(event) {
        event.target.value = formatarCEP(event.target.value);
    }
    /**
     * NOVO: Filtra a lista de clientes com base na busca
     * @param {Event} event - O evento de input
     */
    function handleSearchCliente(event) {
        const query = event.target.value.toLowerCase().trim();
        
        // --- NOVO: Auto-expandir a lista ao digitar ---
        const listaEl = document.getElementById('clientes-list');
        // Se o usu√°rio digitou algo, for√ßamos a abertura do <details> pai
        if (listaEl && query.length > 0) {
            const details = listaEl.closest('details'); // Encontra o elemento 'details' que envolve a lista
            if (details) {
                details.open = true;
            }
        }
        const clientes = document.querySelectorAll('#clientes-list > div');
        
        if (!clientes.length) return;

        clientes.forEach(clienteDiv => {
            const nomeEl = clienteDiv.querySelector('p.font-medium');
            if (nomeEl) {
                const nome = nomeEl.textContent.toLowerCase();
                if (nome.includes(query)) {
                    clienteDiv.style.display = 'flex';
                } else {
                    clienteDiv.style.display = 'none';
                }
            }
        });
    }
    /**
     * Busca o CEP na API e preenche os campos do formul√°rio
     * @param {string} cep - O CEP para buscar
     * @param {object} fieldMap - Um objeto mapeando os IDs dos campos (logradouro, bairro, cidade, uf)
     */
    window.buscarCEP = async (cep, fieldMap) => {
        const cleanCEP = cep.replace(/\D/g, '');
        if (cleanCEP.length !== 8) {
            console.log('CEP inv√°lido ou incompleto.');
            return;
        }
    
        const logradouroEl = document.getElementById(fieldMap.logradouro);
        const bairroEl = document.getElementById(fieldMap.bairro);
        const cidadeEl = document.getElementById(fieldMap.cidade);
        const ufEl = document.getElementById(fieldMap.uf);
        const numeroEl = document.getElementById(fieldMap.numero);
    
        if (!logradouroEl || !bairroEl || !cidadeEl || !ufEl || !numeroEl) {
            console.error('Campos do formul√°rio n√£o encontrados para o CEP.');
            return;
        }
    
        // Mostra "carregando" nos campos
        const originalValues = {
            logradouro: logradouroEl.value,
            bairro: bairroEl.value,
            cidade: cidadeEl.value,
            uf: ufEl.value,
        };
        logradouroEl.value = "Buscando...";
        bairroEl.value = "Buscando...";
        
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cleanCEP}/json/`);
            if (!response.ok) throw new Error('Falha na busca do CEP.');
            
            const data = await response.json();
            
            if (data.erro) {
                alert('CEP n√£o encontrado. Verifique o n√∫mero.');
                logradouroEl.value = originalValues.logradouro;
                bairroEl.value = originalValues.bairro;
                return;
            }
    
            // Preenche os campos
            logradouroEl.value = data.logradouro;
            bairroEl.value = data.bairro;
            cidadeEl.value = data.localidade;
            ufEl.value = data.uf;
            
            // Foca no campo de n√∫mero para o usu√°rio
            numeroEl.focus();
    
        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
            alert('Ocorreu um erro ao buscar o CEP. Tente novamente.');
            logradouroEl.value = originalValues.logradouro;
            bairroEl.value = originalValues.bairro;
        }
    }

    // ==========================================================
    // NOVO BLOCO: FUN√á√ÉO PARA GERAR NOVO ID DE CLIENTE
    // ==========================================================

/**
 * Gera um novo ID de cliente no formato CL[NNN][MM][YY]
 * @returns {string} - O novo ID do cliente
 */
function gerarNovoNumeroCliente() {
    // 1. Pega o pr√≥ximo n√∫mero sequencial (NNN)
    // Filtra IDs que come√ßam com CL e t√™m o formato novo ou antigo
    const clientesComID = appState.clientes
        .map(c => c.numeroCadastro)
        .filter(id => id && id.startsWith('CL'));

    let maxSeq = 0;
    
    clientesComID.forEach(id => {
        let seqNum = 0;
        // Remove o 'CL'
        const numPart = id.substring(2); 
        
        // Tenta identificar o formato novo (ex: 0011125)
        if (numPart.length === 7) { // CL[NNN][MM][YY]
            seqNum = parseInt(numPart.substring(0, 3), 10);
        } 
        // Tenta identificar o formato antigo (ex: 0001)
        else if (numPart.length === 4) { // CL[NNNN]
            seqNum = parseInt(numPart, 10);
        }
        // Tenta identificar IDs manuais antigos (ex: CL011125)
        else if (numPart.length === 6) { // CL[NN][MM][YY]
             seqNum = parseInt(numPart.substring(0, 2), 10);
        }

        if (!isNaN(seqNum) && seqNum > maxSeq) {
            maxSeq = seqNum;
        }
    });

    const proximoSeq = (maxSeq + 1).toString().padStart(3, '0'); // Garante 3 d√≠gitos (NNN)

    // 2. Pega a data atual (MMYY)
    const agora = new Date();
    const mes = (agora.getMonth() + 1).toString().padStart(2, '0'); // MM
    const ano = agora.getFullYear().toString().slice(-2); // YY

    // 3. Monta o ID
    const novoID = `CL${proximoSeq}${mes}${ano}`;
    
    console.log(`Gerado novo ID de Cliente: ${novoID} (Sequ√™ncia: ${proximoSeq})`);
    return novoID;
}
// ==========================================================
// FIM DO NOVO BLOCO
// =====================================
    // Eventos do Financeiro
   // Filtros do painel financeiro
document.getElementById('fat-ano')?.addEventListener('change', updateFinanceiroView);
document.getElementById('fat-mes')?.addEventListener('change', updateFinanceiroView);
document.getElementById('fat-data-inicio')?.addEventListener('change', updateFinanceiroView);
document.getElementById('fat-data-fim')?.addEventListener('change', updateFinanceiroView);

document.getElementById('btn-atualizar-financeiro')?.addEventListener('click', (e) => {
  e.preventDefault();
  updateFinanceiroView();
});

document.getElementById('btn-exportar-financeiro')?.addEventListener('click', (e) => {
  e.preventDefault();
  exportarFinanceiro();
});


    
    
    // ===== Financeiro / Faturamento =====
    function filtrarOrcamentosPorMesAno(anoSel, mesSel) {
      let list = [...appState.orcamentos];
      if (!list.length) return [];
      return list.filter(orc => {
        if (!orc.createdAt) return false;
        const d = new Date(orc.createdAt);
        const ano = d.getFullYear().toString();
        const mes = d.getMonth().toString();
        if (anoSel && anoSel !== 'todos' && ano !== anoSel) return false;
        if (mesSel && mesSel !== 'all' && mes !== mesSel) return false;
        return true;
      });
    }

    function calcularFinanceiro(anoSel, mesSel) {
      const orcs = filtrarOrcamentosPorMesAno(anoSel, mesSel);
      let bruto = 0;
      let liquido = 0;
      let aprovados = 0;
      let pendentes = 0;

      orcs.forEach(orc => {
        const total = Number(orc.total || 0);
        bruto += total;
        const aprovado = (orc.status === 'aprovado' || orc.aprovado === true);
        if (aprovado) {
          liquido += total;
          aprovados += 1;
        } else {
          pendentes += 1;
        }
      });

      return {
        bruto, liquido, aprovados, pendentes, totalOrcamentos: orcs.length,
      };
    }

    function formatBRL(valor) {
      return (Number(valor || 0)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
function updateFinanceiroView() {
      const anoSel = document.getElementById('fat-ano')?.value || 'todos';
      const mesSel = document.getElementById('fat-mes')?.value || 'all';
      const periodoSel = document.getElementById('chart-periodo')?.value || 'mensal';

      // Mostra/Esconde seletor de m√™s
      const labelMes = document.querySelector('label[for="fat-mes"]');
      if (labelMes && labelMes.parentElement) {
        labelMes.parentElement.style.display = (periodoSel === 'mensal') ? 'flex' : 'none';
      }

      let bruto = 0;
      let aprovado = 0; 
      let faturado = 0; 
      
      let labels = [];
      let datasets = [];

      // Helper local de formata√ß√£o
      const format = (v) => (Number(v)||0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

      // Fun√ß√£o auxiliar para somar os valores
      const processarOrcamento = (orc) => {
          const total = Number(orc.total || 0);
          const st = (orc.status || (orc.aprovado ? 'aprovado' : 'pendente')).toLowerCase();
          
          bruto += total;
          
          if (['aprovado', 'concluido', 'faturado'].includes(st)) {
              aprovado += total;
          }
          
          if (st === 'faturado') {
              faturado += total;
          }
      };

      if (periodoSel === 'mensal') {
        const orcs = filtrarOrcamentosPorMesAno(anoSel, mesSel);
        orcs.forEach(processarOrcamento);

        if (chartType === 'pie') {
          labels = ['Bruto (Gerado)', 'Aprovado (Ganho)', 'Faturado (Caixa)'];
          datasets = [{
            data: [bruto, aprovado, faturado],
            backgroundColor: ['#FACC15', '#22C55E', '#3B82F6'],
            borderWidth: 1
          }];
        } else {
          labels = ['Performance do M√™s'];
          datasets = [
            { label: 'Bruto (Gerado)', data: [bruto], backgroundColor: '#FACC15' },
            { label: 'Aprovado (Ganho)', data: [aprovado], backgroundColor: '#22C55E' },
            { label: 'Faturado (Caixa)', data: [faturado], backgroundColor: '#3B82F6' }
          ];
        }

      } else {
        // Anual
        const orcs = filtrarOrcamentosPorMesAno(anoSel === 'todos' ? null : anoSel, 'all');
        const brutoMes = Array(12).fill(0);
        const aprovadoMes = Array(12).fill(0);
        const faturadoMes = Array(12).fill(0);

        orcs.forEach(orc => {
           if (!orc.createdAt) return;
           const d = new Date(orc.createdAt);
           const m = d.getMonth();
           const total = Number(orc.total || 0);
           const st = (orc.status || (orc.aprovado ? 'aprovado' : 'pendente')).toLowerCase();

           bruto += total;
           brutoMes[m] += total;

           if (['aprovado', 'concluido', 'faturado'].includes(st)) {
               aprovado += total;
               aprovadoMes[m] += total;
           }

           if (st === 'faturado') {
               faturado += total;
               faturadoMes[m] += total;
           }
        });

        const mesesLabels = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
        
        if (chartType === 'pie') {
             labels = ['Bruto Total', 'Aprovado Total', 'Faturado Total'];
             datasets = [{
                data: [bruto, aprovado, faturado],
                backgroundColor: ['#FACC15', '#22C55E', '#3B82F6'],
                borderWidth: 1
             }];
        } else {
             labels = mesesLabels;
             datasets = [
                { label: 'Bruto', data: brutoMes, backgroundColor: '#FACC15' },
                { label: 'Aprovado', data: aprovadoMes, backgroundColor: '#22C55E' },
                { label: 'Faturado', data: faturadoMes, backgroundColor: '#3B82F6' }
             ];
        }
      }

      // Atualiza Cards
      const elBruto = document.getElementById('fat-bruto');
      const elLiq = document.getElementById('fat-liquido'); 
      const elContagem = document.getElementById('fat-contagem');

      if (elBruto) elBruto.textContent = format(bruto);
      
      if (elLiq) {
          const tituloCard = elLiq.parentElement.querySelector('p');
          if(tituloCard) tituloCard.textContent = "Valor Faturado (Caixa)";
          elLiq.textContent = format(faturado);
          elLiq.className = "text-xl font-bold text-blue-800"; 
      }
      
      if (elContagem) elContagem.textContent = `Aprovado: ${format(aprovado)}`;

      // Renderiza Gr√°fico
      const canvas = document.getElementById('finance-chart');
      if (!canvas || typeof Chart === 'undefined') return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      if (financeChart) {
        try { financeChart.destroy(); } catch(e) {}
      }

      financeChart = new Chart(ctx, {
        type: chartType,
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        // L√ìGICA CORRIGIDA AQUI
                        let label = context.dataset.label || '';

                        // Se for pizza, o nome da fatia est√° em context.label, n√£o no dataset
                        if (chartType === 'pie') {
                            label = context.label || '';
                        }

                        if (label) label += ': ';
                        
                        // Pega o valor independente do tipo de gr√°fico
                        let valor = context.parsed.y;
                        if (valor === undefined || valor === null) {
                             valor = context.raw;
                        }
                        
                        if (valor !== null) {
                            label += format(valor);
                        }
                        return label;
                    }
                }
            }
          },
          scales: chartType === 'pie' ? {
             x: { display: false },
             y: { display: false }
          } : {
            y: { beginAtZero: true, ticks: { callback: (v) => format(v) } }
          }
        }
      });
    }

    window.mudarTipoGrafico = (tipo) => {
      chartType = tipo;
      updateFinanceiroView();
    };

    function exportarFinanceiro() {
      const inicioStr = document.getElementById('fat-data-inicio')?.value || '';
      const fimStr = document.getElementById('fat-data-fim')?.value || '';

      let orcs = [...appState.orcamentos];
      if (inicioStr || fimStr) {
        const inicio = inicioStr ? new Date(`${inicioStr}T00:00:00`) : null;
        const fim = fimStr ? new Date(`${fimStr}T23:59:59`) : null;
        orcs = orcs.filter(orc => {
          if (!orc.createdAt) return false;
          const d = new Date(orc.createdAt);
          if (inicio && d < inicio) return false;
          if (fim && d > fim) return false;
          return true;
        });
      }

      if (!orcs.length) {
        alert('Nenhum or√ßamento encontrado para o per√≠odo selecionado.');
        return;
      }

      const rows = orcs.map(orc => {
        const d = orc.createdAt ? new Date(orc.createdAt) : null;
        const status = (orc.status === 'aprovado' || orc.aprovado === true) ? 'APROVADO' : 'PENDENTE';
        const cliente = appState.clientes.find(c => c.id === orc.cliente?.id);
        return {
          'Data': d ? d.toLocaleDateString('pt-BR') : '',
          'N√∫mero Or√ßamento': orc.numeroOrcamento || '',
          'Cliente': cliente ? cliente.nome : '',
          'Status': status,
          'Valor Total': Number(orc.total || 0),
        };
      });

      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Faturamento');
      const hoje = new Date();
      const nomeArquivo = `faturamento_orcamentos_${hoje.toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, nomeArquivo);
    }
// Filtros de or√ßamentos (status / m√™s / ano)
    document.getElementById('filtro-status-orcamento')?.addEventListener('change', () => renderOrcamentosList(true));
    document.getElementById('filtro-mes-orcamento')?.addEventListener('change', () => renderOrcamentosList(true));
    document.getElementById('filtro-ano-orcamento')?.addEventListener('change', () => renderOrcamentosList(true));
    document.getElementById('btn-limpar-filtros-orcamento')?.addEventListener('click', () => {
      const statusSel = document.getElementById('filtro-status-orcamento');
      const mesSel = document.getElementById('filtro-mes-orcamento');
      const anoSel = document.getElementById('filtro-ano-orcamento');
      if (statusSel) statusSel.value = 'todos';
      if (mesSel) mesSel.value = 'todos';
      if (anoSel) anoSel.value = 'todos';
      renderOrcamentosList(true);
    });
window.changeOrcamentoStatus = async (selectEl) => {
        try {
            const id = selectEl.dataset.id;
            const novoStatus = selectEl.value;
            console.log('[STATUS] Alterando or√ßamento', id, 'para', novoStatus);

            // 1. Atualiza visualmente na mem√≥ria (para n√£o precisar recarregar tudo do banco)
            const orc = appState.orcamentos.find(o => o.id === id);
            if (orc) {
                orc.status = novoStatus;
                // Mant√©m a l√≥gica de "Aprovado" para compatibilidade, 
                // considerando Aprovado, Concluido e Faturado como "Sim"
                orc.aprovado = (novoStatus === 'aprovado' || novoStatus === 'concluido' || novoStatus === 'faturado');
            }

            // 2. Salva no Firebase
            if (!userId) return; 

            // Usando a sintaxe correta do seu arquivo original (doc, db)
            const ref = doc(db, `users/${userId}/orcamentos/${id}`);
            
            await setDoc(ref, { 
                status: novoStatus,
                aprovado: (novoStatus === 'aprovado' || novoStatus === 'concluido' || novoStatus === 'faturado')
            }, { merge: true });

            // 3. Atualiza SOMENTE o painel financeiro para refletir os novos valores
            updateFinanceiroView();
            // (Opcional) Re-renderiza a lista da Home para atualizar a badge l√° tamb√©m
            renderOrcamentosList(false); 
            
        } catch (err) {
            console.error('Erro ao mudar status:', err);
            alert('Erro ao salvar o status. Verifique sua conex√£o.');
        }
    };
    // --- L√ìGICA DO MENU DE CONFIGURA√á√ïES ---

// Fun√ß√£o para mostrar uma se√ß√£o espec√≠fica e esconder o menu
window.showConfigSection = (sectionId) => {
    document.getElementById('config-menu-view').classList.add('hidden');
    document.querySelectorAll('.config-section').forEach(el => el.classList.add('hidden'));
    document.getElementById(sectionId).classList.remove('hidden');
};

// Fun√ß√£o para voltar ao menu principal
window.hideConfigSection = () => {
    document.querySelectorAll('.config-section').forEach(el => el.classList.add('hidden'));
    document.getElementById('config-menu-view').classList.remove('hidden');
};

// Fun√ß√£o unificada para salvar configura√ß√µes (substitui o submit do form antigo)
window.saveConfigData = async () => {
    if (!userId) return alert('Fa√ßa login novamente.');
    
    // Feedback visual (opcional: mudar texto do bot√£o clicado, mas alert resolve)
    try {
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
        
        const data = {
          // Dados da Empresa
          nome: getVal('config-nome'),
          telefone: getVal('config-telefone').replace(/\D/g, ''),
          doc: getVal('config-doc').replace(/\D/g, ''),
          cep: getVal('config-cep').replace(/\D/g, ''),
          numero: getVal('config-numero'),
          logradouro: getVal('config-logradouro'),
          bairro: getVal('config-bairro'),
          cidade: getVal('config-cidade'),
          uf: getVal('config-uf'),
          logo: getVal('config-logo'),

          // Cores
          config_color_primary: getVal('config-color-primary'),
          config_color_secondary: getVal('config-color-secondary'),

          // Valores
          residencial_empreitada: parseFloat(getVal('config-residencial-empreitada')) || 0,
          residencial_diaria: parseFloat(getVal('config-residencial-diaria')) || 0,
          residencial_ponto: parseFloat(getVal('config-residencial-ponto')) || 0,
          residencial_hora: parseFloat(getVal('config-residencial-hora')) || 0,
          industrial_diaria: parseFloat(getVal('config-industrial-diaria')) || 0,
          industrial_ponto: parseFloat(getVal('config-industrial-ponto')) || 0,
          industrial_hora: parseFloat(getVal('config-industrial-hora')) || 0,

          // Pagamento
          config_pix_chave: getVal('config-pix-chave'),
          config_cartao_vezes: parseInt(getVal('config-cartao-vezes')) || 0,
          config_cartao_juros: parseFloat(getVal('config-cartao-juros')) || 0,
          config_pagamento_dinheiro: document.getElementById('config-pagamento-dinheiro').checked,
          config_deposito_banco: getVal('config-deposito-banco'),
          config_deposito_ag: getVal('config-deposito-ag'),
          config_deposito_conta: getVal('config-deposito-conta'),
        };

        // Remove 'endereco' antigo se existir (limpeza)
        delete data.endereco;

        // Salva no Firebase
        await setDoc(doc(db, `users/${userId}/config/main`), data);
        
        alert('Configura√ß√µes salvas com sucesso!');
        hideConfigSection(); // Volta pro menu automaticamente ap√≥s salvar (opcional)
        
    } catch(e) {
        console.error(e);
        alert('Erro ao salvar as configura√ß√µes.');
    }
};
window.onload = initializeFirebase;
  </script>
</body>
</html>
